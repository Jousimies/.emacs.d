#+TITLE: Personal emacs configuration
#+DATE: [2023-02-27 Mon 14:14]
#+PROPERTY: header-args:emacs-lisp :results silent :tangle "~/.emacs.d/init.el"
#+AUTO_TANGLE: t
#+OPTIONS: author:nil
#+DESCRIPTION: Personal emacs configuration
#+HUGO_BASE_DIR: ~/Documents/hugo-source
#+HUGO_AUTO_SET_LASTMOD: t
#+HUGO_TAGS: Emacs

* Early Init
#+begin_src emacs-lisp :tangle "~/.emacs.d/early-init.el"
  ;;; early-init.el --- Early Init File -*- lexical-binding: t; no-byte-compile: t -*-

  ;; Profiling since here when in debug-mode
  (when init-file-debug
    (profiler-start 'cpu)
    (add-hook 'window-setup-hook #'profiler-stop 0))

  ;; Defer garbage collection further back in the startup process
  (setq gc-cons-threshold most-positive-fixnum
        gc-cons-percentage 1.0)

  ;; Prevent the glimpse of un-styled Emacs by disabling these UI elements early.
  (push '(menu-bar-lines . 0) default-frame-alist)
  (push '(tool-bar-lines . 0) default-frame-alist)
  (push '(vertical-scroll-bars . 0) default-frame-alist)
  (push '(undecorated . t) default-frame-alist)
  (push '(fullscreen . maximized) initial-frame-alist)

  ;; (setq-default initial-major-mode 'fundamental-mode)
  ;; Disable mode-line when emacs startup.
  (setq-default mode-line-format nil)

  (setq initial-buffer-choice nil)

  (setq byte-compile-warnings nil)
  ;;; early-init.el ends here
#+end_src

* Start, Lexical Binding
å…³äº lexical-binding çš„ä½œç”¨è§ [[https://nullprogram.com/blog/2016/12/22/][Make Emacs run (slightly) faster with lexical binding]] . æˆ–è€… [[http://www.yinwang.org/blog-cn/2013/03/26/lisp-dead-alive][Lisp å·²æ­»ï¼ŒLisp ä¸‡å²ï¼]]
#+begin_src emacs-lisp
  ;; init.el --- Personal Emacs Configuration -*- lexical-binding: t; no-byte-compile: t -*-

  ;;; Commentary:

  ;;; Code:
#+end_src

* Rudimentary Configuration
** Speedup
è¿™éƒ¨ä»½çš„å†…å®¹æ¥æºï¼š[[https://github.com/seagle0128/.emacs.d/blob/master/init.el][.emacs.d/init.el at master Â· seagle0128/.emacs.d]]
å¯ä»¥åŠ å¿« Emacs çš„å¯åŠ¨é€Ÿåº¦ã€‚
#+begin_src emacs-lisp
  (setq auto-mode-case-fold nil)

  (unless (or (daemonp) noninteractive init-file-debug)
    (let ((old-file-name-handler-alist file-name-handler-alist))
      (setq file-name-handler-alist nil)
      (add-hook 'emacs-startup-hook
                (lambda ()
                  "Recover file name handlers."
                  (setq file-name-handler-alist
                        (delete-dups (append file-name-handler-alist
                                             old-file-name-handler-alist)))))))
#+end_src
** Benchmark
å¯ä»¥ä½¿ç”¨çš„é…ç½®ï¼š[[https://github.com/purcell/emacs.d/blob/master/lisp/init-benchmarking.el][emacs.d/init-benchmarking.el at master Â· purcell/emacs.d]]

Emacs è¿›è¡Œæ€§æ£€æ£€æµ‹è¿˜å¯ä»¥ä½¿ç”¨[[https://github.com/dholm/benchmark-init-el][dholm/benchmark-init-el: Benchmark your Emacs initialization]] æˆ–è€…[[https://github.com/jschaf/esup][jschaf/esup: ESUP - Emacs Start Up Profiler]].

ç›¸æ¯”è¾ƒä¸ä½¿ç”¨ Emacs å†…ç½®çš„ ~package.el~, ä½¿ç”¨ borg ç®¡ç†åŒ…ï¼ŒEmacs çš„å¯åŠ¨æ—¶é—´æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ä¼˜åŒ–ã€‚

ä¸ºäº†æé«˜ Emacs çš„å¯åŠ¨é€Ÿåº¦ï¼Œéœ€è¦åšçš„å‡ ä¸ªæ–¹é¢åŒ…æ‹¬ï¼š[[Speedup]], [[PATH]], [[Early Init]], ä»¥åŠä½¿ç”¨ gcmh ç®¡ç†ä½¿ç”¨æ—¶çš„ Garbage collection è¡Œä¸ºã€‚
#+begin_src emacs-lisp
  (add-hook 'window-setup-hook
            (lambda ()
              (garbage-collect)
              (let ((curtime (current-time)))
                (message "Times: init:%.06f total:%.06f gc-done:%d"
                         (float-time (time-subtract after-init-time before-init-time))
                         (float-time (time-subtract curtime before-init-time))
                         gcs-done)))
            90)
#+end_src
#+begin_src emacs-lisp
  (defun sanityinc/time-subtract-millis (b a)
    (* 1000.0 (float-time (time-subtract b a))))

  (defvar sanityinc/require-times nil
    "A list of (FEATURE LOAD-START-TIME LOAD-DURATION).
  LOAD-DURATION is the time taken in milliseconds to load FEATURE.")

  (defun sanityinc/require-times-wrapper (orig feature &rest args)
    "Note in `sanityinc/require-times' the time taken to require each feature."
    (let* ((already-loaded (memq feature features))
           (require-start-time (and (not already-loaded) (current-time))))
      (prog1
          (apply orig feature args)
        (when (and (not already-loaded) (memq feature features))
          (let ((time (sanityinc/time-subtract-millis (current-time) require-start-time)))
            (add-to-list 'sanityinc/require-times
                         (list feature require-start-time time)
                         t))))))

  (advice-add 'require :around 'sanityinc/require-times-wrapper)

  (define-derived-mode sanityinc/require-times-mode tabulated-list-mode "Require-Times"
    "Show times taken to `require' packages."
    (setq tabulated-list-format
          [("Start time (ms)" 20 sanityinc/require-times-sort-by-start-time-pred)
           ("Feature" 30 t)
           ("Time (ms)" 12 sanityinc/require-times-sort-by-load-time-pred)])
    (setq tabulated-list-sort-key (cons "Start time (ms)" nil))
    ;; (setq tabulated-list-padding 2)
    (setq tabulated-list-entries #'sanityinc/require-times-tabulated-list-entries)
    (tabulated-list-init-header)
    (when (fboundp 'tablist-minor-mode)
      (tablist-minor-mode)))

  (defun sanityinc/require-times-sort-by-start-time-pred (entry1 entry2)
    (< (string-to-number (elt (nth 1 entry1) 0))
       (string-to-number (elt (nth 1 entry2) 0))))

  (defun sanityinc/require-times-sort-by-load-time-pred (entry1 entry2)
    (> (string-to-number (elt (nth 1 entry1) 2))
       (string-to-number (elt (nth 1 entry2) 2))))

  (defun sanityinc/require-times-tabulated-list-entries ()
    (cl-loop for (feature start-time millis) in sanityinc/require-times
             with order = 0
             do (cl-incf order)
             collect (list order
                           (vector
                            (format "%.3f" (sanityinc/time-subtract-millis start-time before-init-time))
                            (symbol-name feature)
                            (format "%.3f" millis)))))

  (defun sanityinc/require-times ()
    "Show a tabular view of how long various libraries took to load."
    (interactive)
    (with-current-buffer (get-buffer-create "*Require Times*")
      (sanityinc/require-times-mode)
      (tabulated-list-revert)
      (display-buffer (current-buffer))))

  (defun sanityinc/show-init-time ()
    (message "init completed in %.2fms"
             (sanityinc/time-subtract-millis after-init-time before-init-time)))
#+end_src
** PATH
å¦‚æœä½¿ç”¨ emacs-plus, ä¼šè‡ªåŠ¨çš„æ·»åŠ åˆ° path å½“ä¸­ï¼Œæˆ–è€…ä½¿ç”¨[[https://github.com/purcell/exec-path-from-shell][purcell/exec-path-from-shell: Make Emacs use the $PATH set up by the user's shell]]. æˆ–è€…ä½¿ç”¨ä¸‹é¢çš„é…ç½®.

è¿™éƒ¨ä»½çš„é…ç½®æ¥æºï¼š[[https://www.emacswiki.org/emacs/ExecPath][EmacsWiki: Exec Path]]

ä¸è®¾ç½® ~exec-path~, åœ¨ MacOS ä¸Šæœ‰å¯èƒ½ä¼šæç¤ºæ‰¾ä¸åˆ°ç¨‹åºã€‚
#+begin_src emacs-lisp
  (defun set-exec-path-from-shell-PATH ()
    "This is particularly useful under Mac OS X and macOS."
    (interactive)
    (let ((path-from-shell (replace-regexp-in-string
                            "[ \t\n]*$" "" (shell-command-to-string
                                            "$SHELL --login -c 'echo $PATH'"))))
      (setenv "PATH" path-from-shell)
      (setq exec-path (split-string path-from-shell path-separator))))
  (set-exec-path-from-shell-PATH)
#+end_src
#+begin_src emacs-lisp
  (require 'cl-lib)
  (defun add-subdirs-to-load-path (search-dir)
    (interactive)
    (let* ((dir (file-name-as-directory search-dir)))
      (dolist (subdir
	       ;; è¿‡æ»¤å‡ºä¸å¿…è¦çš„ç›®å½•ï¼Œæå‡Emacså¯åŠ¨é€Ÿåº¦
	       (cl-remove-if
		#'(lambda (subdir)
		    (or
		     ;; ä¸æ˜¯ç›®å½•çš„æ–‡ä»¶éƒ½ç§»é™¤
		     (not (file-directory-p (concat dir subdir)))
		     ;; çˆ¶ç›®å½•ã€ è¯­è¨€ç›¸å…³å’Œç‰ˆæœ¬æ§åˆ¶ç›®å½•éƒ½ç§»é™¤
		     (member subdir '("." ".."
				      "dist" "node_modules" "__pycache__"
				      "RCS" "CVS" "rcs" "cvs" ".git" ".github"))))
		(directory-files dir)))
	(let ((subdir-path (concat dir (file-name-as-directory subdir))))
	  ;; ç›®å½•ä¸‹æœ‰ .el .so .dll æ–‡ä»¶çš„è·¯å¾„æ‰æ·»åŠ åˆ° `load-path' ä¸­ï¼Œæå‡Emacså¯åŠ¨é€Ÿåº¦
	  (when (cl-some #'(lambda (subdir-file)
			     (and (file-regular-p (concat subdir-path subdir-file))
				  ;; .so .dll æ–‡ä»¶æŒ‡éElispè¯­è¨€ç¼–å†™çš„EmacsåŠ¨æ€åº“
				  (member (file-name-extension subdir-file) '("el" "so" "dll"))))
			 (directory-files subdir-path))

	    ;; æ³¨æ„ï¼š`add-to-list' å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¿…é¡»ä¸º t ï¼Œè¡¨ç¤ºåŠ åˆ°åˆ—è¡¨æœ«å°¾
	    ;; è¿™æ ·Emacsä¼šä»çˆ¶ç›®å½•åˆ°å­ç›®å½•çš„é¡ºåºæœç´¢Elispæ’ä»¶ï¼Œé¡ºåºåè¿‡æ¥ä¼šå¯¼è‡´Emacsæ— æ³•æ­£å¸¸å¯åŠ¨
	    (add-to-list 'load-path subdir-path t))

	  ;; ç»§ç»­é€’å½’æœç´¢å­ç›®å½•
	  (add-subdirs-to-load-path subdir-path)))))
  (add-subdirs-to-load-path "~/.emacs.d/packages")
  ;; (add-to-list 'load-path "~/.emacs.d/packages")
#+end_src
** Utility Hooks and Functions
è¿™ä¸ª [[https://github.com/ajgrf/on.el/tree/master/][ajgrf/on.el: Hooks for faster Emacs startup â€“ GitHub mirror]] å¢åŠ äº†ä¸€äº›æœ‰ç”¨çš„ hookï¼Œå¯ä»¥æ§åˆ¶åŒ…çš„å¯åŠ¨æ—¶æœºã€‚

æ›´å¤šå‚è§ï¼š[[https://github.com/emacs-magus][emacs-magus]].
#+begin_src emacs-lisp
  (use-package on)
#+end_src

** Variables
å®šä¹‰ä¸€äº›å˜é‡ï¼Œæ–¹ä¾¿é…ç½®æ–‡ä»¶ä½ç½®æˆ–é’ˆå¯¹ç‰¹å®šç³»ç»Ÿè¿›è¡Œç›¸å…³è®¾å®šã€‚
#+begin_src emacs-lisp
  (defvar my-cloud "~/Nextcloud"
    "This folder is My cloud.")

  ;; L.Personal.Galaxy location may change, but folders in this directory never change.
  (defvar my-galaxy (expand-file-name "L.Personal.Galaxy" my-cloud)
    "This folder stores all the plain text files of my life.")

  (defvar website-directory "~/Nextcloud/L.Personal.Galaxy/website"
    "The source folder of my blog.")
#+end_src

[[https://github.com/emacscollective/no-littering][https://github.com/emacscollective/no-littering]], ä¼šå°†ä¸€äº›åŒ…äº§ç”Ÿçš„æ–‡ä»¶é›†ä¸­æ”¾ç½®åˆ° etc å’Œ var ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨ user-emacs-directory å½“ä¸­ã€‚

#+begin_src emacs-lisp
  (use-package no-littering)
#+end_src

** Evil modal edit

åœ¨ç»å†äº†å¤šç§å°è¯•ä¹‹åï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº† Evil æ¨¡å¼ç¼–è¾‘ï¼Œå…¶ä»–çš„æ¨¡å¼ç¼–è¾‘æœ‰ [[https://github.com/meow-edit/meow][meow-edit/meow: Yet another modal editing on Emacs / çŒ«æ€ç¼–è¾‘]].

æˆ‘ä¸ä½¿ç”¨ Meow æ˜¯å› ä¸ºå®ƒåªèƒ½åœ¨ Emacs ä¸­ä½¿ç”¨ã€‚

ä¹Ÿæ›¾ç»é•¿æ—¶é—´ä½¿ç”¨è¿‡ Emacs çš„åŸç”ŸæŒ‰é”®æ–¹å¼ï¼Œè¯¥ä½“éªŒåœ¨ Mac ç³»ç»Ÿä¸Šå…·æœ‰è¾ƒå¥½çš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯åŸç”ŸæŒ‰é”®æ–¹å¼æœ‰ç‚¹è´¹æ‰‹ã€‚

*** evil
#+begin_src emacs-lisp
  (use-package evil
    :bind (:map evil-insert-state-map
                ("C-e" . move-end-of-line)
                ("C-k" . kill-line))
    :hook ((after-init . evil-mode)
           (after-change-major-mode . (lambda ()
                                        (setq-local evil-shift-width tab-width))))
    :init
    (setq evil-want-keybinding nil)
    (setq evil-want-integration t)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-C-h-delete t)
    :config
    (setq evil-undo-system 'undo-fu)
    (setq evil-respect-visual-line-mode t)
    (setq evil-visual-state-cursor 'hollow)

    (setq evil-normal-state-tag " ğ ")
    (setq evil-insert-state-tag " ğˆ ")
    (setq evil-motion-state-tag " ğŒ ")
    (setq evil-visual-state-tag " ğ• ")
    (setq evil-replace-state-tag " ğ‘ ")
    (setq evil-operator-state-tag " O ")
    (setq evil-emacs-state-tag " E "))

  (global-set-key (kbd "C-M-u") 'universal-argument)
#+end_src
ä¸‹é¢çš„é…ç½®æ¥æºï¼š[[https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-evil.el][emacs.d/init-evil.el at master Â· redguardtoo/emacs.d]]
*** evil-collection
[[https://github.com/emacs-evil/evil-collection][emacs-evil/evil-collection: A set of keybindings for evil-mode]] è®¾ç½® Major mode ä¸‹çš„æŒ‰é”®ç»‘å®šï¼Œæ¯”è‡ªå·±ä¸€ä¸€è®¾ç½®è¦æ–¹ä¾¿ã€‚è‹¥æ²¡æœ‰ä½ ä½¿ç”¨çš„ï¼Œå¯ä»¥æ PR.

æˆ‘ä½¿ç”¨ =SPC= ä½œä¸º =leader key=, è¿™ä¸ªé”®åœ¨ evil-collection çš„ major mode ä¸­è¢«é…ç½®æˆäº†å…¶ä»–çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® ~evil-collection-key-blacklist~ ç¦ç”¨ =SPC= é”®ã€‚

#+begin_src emacs-lisp
  ;; (with-eval-after-load 'evil
  ;;   (evil-collection-init))
  (use-package evil-collection
    :after evil
    :config
    (setq evil-collection-key-blacklist '("SPC" ","))
    (setq forge-add-default-bindings nil)
    (evil-collection-init))

#+end_src

*** evil-commentary
[[https://github.com/linktohack/evil-commentary][linktohack/evil-commentary: Comment stuff out. A port of vim-commentary]] é€šè¿‡ä½¿ç”¨ ~gcc~ æ·»åŠ æ³¨é‡Šï¼Œåœ¨ Mac ä¸Šå¯ä»¥é€šè¿‡ä½¿ç”¨ ~s-/~ è¿›è¡Œã€‚

#+begin_src emacs-lisp
  (use-package evil-commentary
    :hook (on-first-file . evil-commentary-mode))
#+end_src

*** evil-surround
[[https://github.com/emacs-evil/evil-surround][emacs-evil/evil-surround: you will be surrounded (surround.vim for evil, the extensible vi layer)]] å¯ä»¥åœ¨æŒ‡å®šçš„åŒºåŸŸæ·»åŠ æˆå¯¹çš„ç¬¦å·ï¼Œå…·ä½“ä½¿ç”¨å‚è§ä»¥ä¸Šé¡µé¢ã€‚

å…·ä½“çš„ä½¿ç”¨æ˜¯å¯¹äº visual çŠ¶æ€ï¼Œä½¿ç”¨ ~S =~ æ¥æ’å…¥æˆå¯¹çš„ç­‰äºå·ï¼Œå…¶ä»–çš„ç¬¦å·åŒç†ã€‚è‹¥è¦ä¿®æ”¹çš„è¯ï¼Œä½¿ç”¨ ~cs = *~ æ¥å°†ç­‰äºå·æ”¹ä¸ºæ˜Ÿå·ï¼Œå…¶ä»–çš„ç¬¦å·åŒç†ã€‚

#+begin_src emacs-lisp
  (use-package evil-surround
    :hook (on-first-file . global-evil-surround-mode))
#+end_src

*** evil-embrace
[[https://github.com/cute-jumper/evil-embrace.el][cute-jumper/evil-embrace.el: Evil integration of embrace.el]] å…·æœ‰å’Œ evil-surround ç›¸ä¼¼çš„åŠŸèƒ½ã€‚

#+begin_src emacs-lisp
  (use-package evil-embrace
    :hook ((org-mode . embrace-org-mode-hook))
    :config
    (evil-embrace-enable-evil-surround-integration))
#+end_src

*** which-key-mode
[[https://github.com/justbur/emacs-which-key][justbur/emacs-which-key: Emacs package that displays available keybindings in popup]] å¯ä»¥æç¤ºæŒ‰é”®ï¼Œå¯¹äºä¸å¸¸ä½¿ç”¨çš„æŒ‰é”®åºåˆ—ï¼Œæœ‰æ—¶æƒ³ä¸èµ·æ¥ï¼Œæœ‰æç¤ºè¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚

#+begin_src emacs-lisp
  (use-package which-key
    :hook (on-first-input . which-key-mode)
    :config
    (setq which-key-show-early-on-C-h t)
    (setq which-key-idle-delay 10000)
    (setq which-key-idle-secondary-delay 0.05))
#+end_src

*** general
[[https://github.com/noctuid/general.el][noctuid/general.el: More convenient key definitions in emacs]] ç»“åˆ Evil å¯ä»¥è®¾ç½®ä¸€ç³»åˆ—çš„æŒ‰é”®ç»‘å®šï¼Œç›¸å¯¹äº Emacs åŸç”Ÿçš„æŒ‰é”®æ–¹å¼ï¼Œåºåˆ—åŒ–çš„æŒ‰é”®æ¯”è¾ƒå‹å¥½ã€‚

å…·ä½“çš„ä½¿ç”¨æ–¹å¼è§ package çš„ README æ–‡ä»¶ã€‚
#+begin_src emacs-lisp
  (use-package general
    :config
    (general-create-definer my/space-leader-def
                :prefix "SPC"
                :non-normal-prefix "M-SPC"
                :states '(normal visual insert emacs))
    (general-create-definer my/comma-leader-def
                :prefix ","
                :non-normal-prefix "M-,"
                :states '(normal visual insert emacs)))
#+end_src

#+begin_src emacs-lisp
  (defun my/emacs-config ()
    "My literate Emacs configuration."
    (interactive)
    (find-file (expand-file-name "emacs.org" user-emacs-directory)))

  (my/space-leader-def
    "f" '(:ignore t :wk "Files"))
#+end_src

** epkg
#+begin_src emacs-lisp
  (use-package epkg
    :commands (epkg-describe-package))

  (my/space-leader-def
    "p" '(:ignore t :wk "Package management")
    "pp" '(epkg-describe-package :wk "Epkg describe package"))

  (use-package epkg-marginalia
    :after (epkg marginalia)
    :config
    (cl-pushnew 'epkg-marginalia-annotate-package
                (alist-get 'package marginalia-annotator-registry)))
#+end_src

** auto-save
[[https://github.com/manateelazycat/auto-save][auto-save/auto-save.el at master Â· manateelazycat/auto-save]] æˆ‘ä½¿ç”¨è¿™ä¸ªåŒ…è¿›è¡Œæ–‡ä»¶çš„è‡ªåŠ¨ä¿å­˜ï¼ŒEmacs è‡ªå¸¦ `auto-save-visited-mode', ä½†æ˜¯æ²¡æœ‰ auto-save è¿™ä¸ªåŒ…å¥½ç”¨ã€‚

ä¸»è¦çš„é—®é¢˜æ˜¯ auto-save-visited-mode åœ¨ org-capture å½“ä¸­ä¸èƒ½å…³é—­è‡ªåŠ¨åˆ é™¤ç©ºæ ¼ã€‚

#+begin_src emacs-lisp
  (use-package auto-save
    :hook (on-first-file . auto-save-enable)
    :config
    (setq auto-save-silent t)
    (setq auto-save-delete-trailing-whitespace t))
#+end_src

** Auto tangle
ä½¿ç”¨ Literate programming é…ç½® Emacs æ–‡ä»¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥ä¸ç”¨æ‰‹åŠ¨ tangleï¼Œæ–‡ä»¶ä¿å­˜åè‡ªåŠ¨æ‰§è¡Œã€‚

#+begin_src emacs-lisp
  (use-package org-auto-tangle
    :hook (org-mode . org-auto-tangle-mode))
#+end_src

** Server
å¯ç”¨ Server åå¯ä»¥ä½¿ç”¨ emacsclient æ‰“å¼€æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼Œè€Œä¸æ˜¯æ–°å¼€ä¸€ä¸ª Emacs.

åœ¨ Mac ä¸Šä½¿ç”¨ emacsclient éœ€è¦é€šè¿‡ automator åˆ›å»ºä¸€ä¸ª application. æ–°å»ºä¸€ä¸ª run shell script å¡«å…¥ä»¥ä¸‹çš„å†…å®¹ã€‚

#+begin_src shell
  /opt/homebrew/bin/emacsclient -n -a -c "$@"
#+end_src

#+begin_src emacs-lisp
  (use-package server
    :hook (on-first-input . server-start)
    :config
    (defun my/start-server ()
      (interactive)
      (if (not (server-running-p))
          (server-start))
      (message "Server has started")))
#+end_src

[[https://github.com/iqbalansari/restart-emacs][iqbalansari/restart-emacs: A simple emacs package to restart emacs from within emacs]]  Emacs 29 ä¸­ restart-emacs å·±æ˜¯ builtin functionã€‚
#+begin_src emacs-lisp
  (my/space-leader-def
    "q" '(:ignore t :wk "Quit/Restart")
    "qR" '(restart-emacs :wk "Restart emacs")
    "qq" '(server-force-delete :wk "Server Delete")
    "qs" '(my/start-server :wk "Server Delete"))
#+end_src

** Magit
[[https://github.com/magit/magit][magit/magit: It's Magit! A Git Porcelain inside Emacs.]] æ˜¯ Emacs ä¸Šçš„ä¸€å¤§æ€å™¨åº”ç”¨ï¼Œç›¸å¯¹äºå‘½ä»¤è¡Œçš„æ–¹å¼ä½¿ç”¨ git å‹å¥½çš„å¾ˆå¤šã€‚

é€šè¿‡ borg å®‰è£… Magit éœ€è¦å¢åŠ ä¸¤è¡Œ load-path çš„é…ç½®ã€‚ä½¿ç”¨æ—¶é€šè¿‡ ~C-x g~ å³å¯è°ƒç”¨ Magit.
#+begin_src shell
  [submodule "magit"]
      path = lib/magit
      url = git@github.com:magit/magit.git
      load-path = .
      load-path = ./lisp
#+end_src
#+begin_src emacs-lisp
  (use-package magit
    :commands (magit magit-status magit-submodule-add)
    :bind ("C-x g" . magit)
    :general (:keymaps 'with-editor-mode-map
                       "RET" "C-c C-c")
    :config
    (magit-add-section-hook 'magit-status-sections-hook
                            'magit-insert-modules
                            'magit-insert-unpulled-from-upstream)
    (remove-hook 'magit-module-sections-hook 'magit-insert-modules-overview)
    (remove-hook 'magit-module-sections-hook 'magit-insert-modules-unpulled-from-pushremote)
    (remove-hook 'magit-module-sections-hook 'magit-insert-modules-unpushed-to-upstream)
    (remove-hook 'magit-module-sections-hook 'magit-insert-modules-unpushed-to-pushremote))

  (use-package forge
    :after magit)
#+end_src
*** browse-at-remote
#+begin_src emacs-lisp
  (use-package browse-at-remote
    :bind ("C-c f b" . browse-at-remote)
    :config
    (my/space-leader-def
      "fb" '(browse-at-remote :wk "Browse remote")))
#+end_src

** Custom
#+begin_src emacs-lisp
  (setq custom-file (locate-user-emacs-file "custom.el"))
  (when (file-exists-p custom-file)
    (load custom-file))
#+end_src

* Emacs User Interface, Delicious
** Fonts
=Insevka Fixed= å’Œ =Source Han Serif SC= è¿™ä¸¤ä¸ªå­—ä½“ç­‰å®½ï¼Œåœ¨ org-mode ä¸­å¯ä»¥å¯¹é½è¡¨æ ¼ã€‚

å°è¯•è¿‡ ~variable-pitch-mode~ å’Œ ~fixed-pitch-mode~, ä¸å¥½ç”¨ã€‚

ä¸è®¾ç½® charsetï¼Œåœ¨ MacOS ä¸Šé»˜è®¤ä½¿ç”¨ =PingFanc SC= å­—ä½“ï¼Œçœ‹èµ·æ¥ä¹Ÿå¯ä»¥ã€‚
#+begin_src emacs-lisp
  (set-face-attribute 'default nil :font "Iosevka Fixed" :height 160)
  (if (display-graphic-p)
      (dolist (charset '(kana han cjk-misc bopomofo))
        (set-fontset-font (frame-parameter nil 'font)
                          charset (font-spec :family "Source Han Serif SC" :height 160)) t 'prepend))
#+end_src

** Themes
å½“å‰å†…ç½®çš„ Modus-themes ä¸»é¢˜çœ‹èµ·æ¥å¾ˆå¥½ï¼ŒI like it.
#+begin_src emacs-lisp
  (use-package modus-themes
    :config
    (setq modus-themes-bold-constructs t)
    (setq modus-themes-italic-constructs t)

    (setq modus-themes-common-palette-overrides
      '(;; mode-line
        (border-mode-line-active unspecified)
        (border-mode-line-inactive unspecified)
        (bg-mode-line-active bg-main)
        (fg-mode-line-active fg-main)

        ;; line-number
        (fg-line-number-inactive "gray50")
        (fg-line-number-active red-cooler)
        (bg-line-number-inactive unspecified)
        (bg-line-number-active unspecified)
        ;; link
        (underline-link border)
        (underline-link-visited border)
        (underline-link-symbolic border)

        ;; org agenda
        (date-common cyan)   ; default value (for timestamps and more)
        (date-deadline red-warmer)
        (date-event magenta-warmer)
        (date-holiday blue) ; for M-x calendar
        (date-now yellow-warmer)
        (date-scheduled magenta-cooler)
        (date-weekday cyan-cooler)
        (date-weekend blue-faint)

        ;; org heading
        (fg-heading-1 blue-warmer)
        (fg-heading-2 yellow-cooler)
        (fg-heading-3 cyan-cooler)))

    (setq modus-themes-prompts '(extrabold italic))

    (setq modus-themes-completions
      '((matches . (extrabold))
        (selection . (semibold italic text-also)))))
#+end_src

*** Theme switch

emacs-plus can switch themes by system. é€šè¿‡å¢åŠ çš„è¡¥å®šå®ç°çš„æ­¤åŠŸèƒ½ï¼Œè‹¥æ˜¯ä¸ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œè¿˜æœ‰ [[https://github.com/LionyxML/auto-dark-emacs][auto-dark-emacs]] å¯ä»¥ä½¿ç”¨ã€‚

ä½¿ç”¨ [[https://github.com/mclear-tools/build-emacs-macos/tree/main/][mclear-tools/build-emacs-macos: Build script for emacs and macos]] è‡ªç¼–è¯‘ Emacs ä¹Ÿæœ‰æ”¹å˜ä¸»é¢˜çš„ patch.

#+begin_src emacs-lisp
  (defun my/apply-theme (appearance)
    "Load theme, taking current system APPEARANCE into consideration."
    (mapc #'disable-theme custom-enabled-themes)
    (pcase appearance
      ('light (load-theme 'modus-operandi t))
      ('dark (load-theme 'modus-vivendi t))))
  (add-hook 'ns-system-appearance-change-functions #'my/apply-theme)
#+end_src

** all-the-icons
è¿™é‡Œä½¿ç”¨äº†[[https://github.com/domtronn/all-the-icons.el][domtronn/all-the-icons.el: A utility package to collect various Icon Fonts and propertize them within Emacs.]]

éœ€è¦è‡ªå·±æ‰§è¡Œ all-the-icons-install-fonts æ¥å®‰è£…å¯¹åº”çš„å­—ä½“ã€‚

#+begin_src emacs-lisp
  (set-fontset-font t 'unicode (font-spec :family "Material Icons") nil 'prepend)
  (set-fontset-font t 'unicode (font-spec :family "file-icons") nil 'prepend)
#+end_src

è¿™éƒ¨ä»½çš„é…ç½®æ¥æºï¼š[[https://github.com/seagle0128/.emacs.d][seagle0128/.emacs.d: Centaur Emacs - A Fancy and Fast Emacs Configuration]]

#+begin_src emacs-lisp
  (use-package all-the-icons
    :config
    (let ((extension-icon-alist
           '(("bat"  all-the-icons-alltheicon "terminal" :face all-the-icons-lsilver)
             ("cmd"  all-the-icons-alltheicon "terminal" :face all-the-icons-lsilver)
             ("conf" all-the-icons-octicon "settings"    :v-adjust 0.0 :face all-the-icons-yellow)
             ("eln"  all-the-icons-octicon "file-binary" :v-adjust 0.0 :face all-the-icons-dsilver)
             ("epub" all-the-icons-faicon "book"         :height 1.0 :v-adjust -0.1 :face all-the-icons-green)
             ("exe"  all-the-icons-octicon "file-binary" :v-adjust 0.0 :face all-the-icons-dsilver)
             ("make" all-the-icons-fileicon "gnu"        :face all-the-icons-dorange)
             ("rss"  all-the-icons-octicon "rss"         :height 1.1 :v-adjust 0.0 :face all-the-icons-lorange)
             ("toml" all-the-icons-octicon "settings"    :v-adjust 0.0 :face all-the-icons-yellow)
             ("tsx"  all-the-icons-fileicon "tsx"        :height 1.0 :v-adjust -0.1 :face all-the-icons-cyan-alt)
             ("xpm"  all-the-icons-octicon "file-media"  :v-adjust 0.0 :face all-the-icons-dgreen))))
      (dolist (icon extension-icon-alist)
        (add-to-list 'all-the-icons-extension-icon-alist icon)))

    (let ((regexp-icon-alist
           '(("\\.[bB][iI][nN]$"               all-the-icons-octicon "file-binary" :v-adjust 0.0 :face all-the-icons-yellow)
             ("^config$"                       all-the-icons-octicon "settings"    :v-adjust 0.0 :face all-the-icons-dorange)
             ("\\.\\(ba\\|z\\)shrc$"           all-the-icons-alltheicon "script"   :height 0.9 :face all-the-icons-dpink)
             ("\\.\\(bash\\|zsh\\)*_?profile$" all-the-icons-alltheicon "script"   :height 0.9 :face all-the-icons-dred)
             ("\\.\\(ba\\|z\\)sh_history$"     all-the-icons-alltheicon "script"   :height 0.9 :face all-the-icons-dsilver)
             ("\\.zshenv$"                     all-the-icons-alltheicon "script"   :height 0.9 :face all-the-icons-dred)
             ("Cask\\'"                        all-the-icons-fileicon "elisp"      :height 1.0 :v-adjust -0.2 :face all-the-icons-blue)
             ("NEWS$"                          all-the-icons-faicon "newspaper-o"  :height 0.9 :v-adjust -0.2)
             ("^Rakefile$"                     all-the-icons-alltheicon "ruby-alt" :face all-the-icons-red))))
      (dolist (icon regexp-icon-alist)
        (add-to-list 'all-the-icons-regexp-icon-alist icon)))

    (let ((mode-icon-alist
           '((xwidget-webkit-mode           all-the-icons-faicon "chrome"          :v-adjust -0.1 :face all-the-icons-blue)
             (bongo-playlist-mode           all-the-icons-material "queue_music"   :height 1.3 :face all-the-icons-green)
             (bongo-library-mode            all-the-icons-material "library_music" :height 1.1 :face all-the-icons-green)
             (simple-mpc-mode               all-the-icons-faicon "music"           :v-adjust -0.1 :face all-the-icons-green)
             (mingus-playlist-mode          all-the-icons-faicon "music"           :v-adjust -0.1 :face all-the-icons-green)
             (mingus-help-mode              all-the-icons-material "music_note"    :height 1.2 :face all-the-icons-green)
             (mingus-browse-mode            all-the-icons-material "library_music" :height 1.1 :face all-the-icons-green)
             (mingus-burn-mode              all-the-icons-material "queue_music"   :height 1.3 :face all-the-icons-green)
             (gnus-group-mode               all-the-icons-fileicon "gnu"           :face all-the-icons-silver)
             (gnus-summary-mode             all-the-icons-octicon "inbox"          :height 1.0 :v-adjust 0.0 :face all-the-icons-orange)
             (gnus-article-mode             all-the-icons-octicon "mail"           :height 1.1 :v-adjust 0.0 :face all-the-icons-lblue)
             (message-mode                  all-the-icons-octicon "mail"           :height 1.1 :v-adjust 0.0 :face all-the-icons-lblue)
             (diff-mode                     all-the-icons-octicon "git-compare"    :v-adjust 0.0 :face all-the-icons-lred)
             (flycheck-error-list-mode      all-the-icons-octicon "checklist"      :height 1.1 :v-adjust 0.0 :face all-the-icons-lred)
             (newsticker-mode               all-the-icons-faicon "rss-square"      :v-adjust -0.1 :face all-the-icons-orange)
             (newsticker-treeview-mode      all-the-icons-faicon "rss-square"      :v-adjust -0.1 :face all-the-icons-orange)
             (newsticker-treeview-list-mode all-the-icons-octicon "rss"            :height 1.1 :v-adjust 0.0 :face all-the-icons-orange)
             (newsticker-treeview-item-mode all-the-icons-octicon "rss"            :height 1.1 :v-adjust 0.0 :face all-the-icons-lorange)
             (conf-mode                     all-the-icons-octicon "settings"       :v-adjust 0.0 :face all-the-icons-yellow)
             (conf-space-mode               all-the-icons-octicon "settings"       :v-adjust 0.0 :face all-the-icons-yellow)
             (gitconfig-mode                all-the-icons-octicon "settings"       :v-adjust 0.0 :face all-the-icons-dorange)
             (forge-topic-mode              all-the-icons-alltheicon "git"         :face all-the-icons-blue)
             (help-mode                     all-the-icons-faicon "info-circle"     :height 1.1 :v-adjust -0.1 :face all-the-icons-purple)
             (helpful-mode                  all-the-icons-faicon "info-circle"     :height 1.1 :v-adjust -0.1 :face all-the-icons-purple)
             (Info-mode                     all-the-icons-faicon "info-circle"     :height 1.1 :v-adjust -0.1)
             (cask-mode                     all-the-icons-fileicon "elisp"         :height 1.0 :v-adjust -0.2 :face all-the-icons-blue)
             (ein:notebooklist-mode         all-the-icons-faicon "book"            :face all-the-icons-lorange)
             (ein:notebook-mode             all-the-icons-fileicon "jupyter"       :height 1.2 :face all-the-icons-orange)
             (ein:notebook-multilang-mode   all-the-icons-fileicon "jupyter"       :height 1.2 :face all-the-icons-dorange)
             (nov-mode                      all-the-icons-faicon "book"            :height 1.0 :v-adjust -0.1 :face all-the-icons-green)
             (gfm-mode                      all-the-icons-octicon "markdown"       :face all-the-icons-lblue)
             (osx-dictionary-mode           all-the-icons-material "library_books" :face all-the-icons-lblue)
             (youdao-dictionary-mode        all-the-icons-material "library_books" :face all-the-icons-lblue)
             (fanyi-mode                    all-the-icons-material "library_books" :face all-the-icons-lblue))))
      (dolist (icon mode-icon-alist)
        (add-to-list 'all-the-icons-mode-icon-alist icon))))
#+end_src

#+begin_src emacs-lisp
  (use-package all-the-icons-completion
    :hook ((minibuffer-setup . all-the-icons-completion-mode)
           (marginalia-mode . all-the-icons-completion-marginalia-setup)))
#+end_src
** fringe-mode
å› ä¸ºæˆ‘è¦ä½¿ç”¨ [[org-transclusion]], æ‰€ä»¥ä¸èƒ½é»˜è®¤ä¸æ˜¾ç¤º fringe. å°†å…¶è®¾ç½®ä¸ºæœ€å°æ¨¡å¼ã€‚

fringe-mode éœ€è¦è·Ÿä¸€ä¸ª cons cell, ç›´æ¥ä½¿ç”¨ minimal ä¼šæŠ¥é”™ã€‚
#+begin_src emacs-lisp
  (define-fringe-bitmap 'right-curly-arrow  [])
  (define-fringe-bitmap 'left-curly-arrow  [])

  (fringe-mode '(1 . 1))
#+end_src

** hl-line-mode
é«˜äº®å½“å‰è¡Œï¼Œå…¨å±€å¼€å¯ä½¿ç”¨ ~global-hl-line-mode~.

ä¸ä½¿ç”¨ ~global-hl-line-mode~ å› ä¸ºä¸æƒ³åœ¨ dashboard ä¸­å¼€å¯è¡Œé«˜äº®ã€‚
#+begin_src emacs-lisp
  (add-hook 'prog-mode-hook 'hl-line-mode)
  (add-hook 'org-mode-hook 'hl-line-mode)
#+end_src

** line numbers
#+begin_src emacs-lisp
  (setq-default display-line-numbers-widen t)

  (add-hook 'prog-mode-hook 'display-line-numbers-mode)
  (add-hook 'org-mode-hook 'display-line-numbers-mode)
  (add-hook 'LaTeX-mode-hook 'display-line-numbers-mode)
#+end_src

** scroll-bar-mode
#+begin_src emacs-lisp
  (scroll-bar-mode 0)
#+end_src

** fill column indicator
#+begin_src emacs-lisp
  (setq-default fill-column 90)

  (face-spec-set 'fill-column-indicator
                 '((default :height 0.1))
                 'face-override-spec)

  ;; only show fill indicator in prog mode.
  (add-hook 'prog-mode-hook 'display-fill-column-indicator-mode)
#+end_src

** Paren
æ˜¾ç¤ºå¯¹åº”çš„æ‹¬å·ï¼Œè¿™ä¸ªåœ¨ elisp ä¸­æŒºå‹å¥½ã€‚
#+begin_src emacs-lisp
  (setq show-paren-style 'parenthesis)
  (setq show-paren-context-when-offscreen 'overlay)

  (add-hook 'text-mode-hook 'show-paren-mode)
#+end_src

** Cursor and color
é»˜è®¤å…³é—­å…‰æ ‡é—ªçƒã€‚
#+begin_src emacs-lisp
  (blink-cursor-mode -1)
#+end_src

ä½¿ç”¨ Evilï¼Œé€šè¿‡å…‰æ ‡çš„é¢œè‰²æ¥æç¤ºå½“å‰çš„è¾“å…¥æ³•çŠ¶æ€ï¼Œç»“åˆä½¿ç”¨[[http://zzzm.ysepan.com/][ä¸‰ç éƒ‘ç  / è‡³è‡³éƒ‘ç  ï¼ˆè‡³ç®€Â·è‡³çˆ±ï¼‰zhengma.plus]] è¾“å…¥æ³•ï¼Œå…·æœ‰å¾ˆå¥½çš„ä½¿ç”¨ä½“éªŒï¼Œç›¸å½“çš„æ˜ç¡®æ„Ÿã€‚

å…³äºå…‰æ ‡è‡ªåŠ¨æ›´æ¢é¢œè‰²ï¼Œè¿™é‡Œæœ‰ä¸ªåŒ…å¯ä»¥ä½¿ç”¨ï¼š[[https://github.com/Eason0210/im-cursor-chg][Eason0210/im-cursor-chg]].
#+begin_src emacs-lisp :tangle no
  (defun im--chinese-p ()
    "Check if the current input state is Chinese."
    (if (featurep 'rime)
        (and (rime--should-enable-p)
             (not (rime--should-inline-ascii-p))
             current-input-method)
      current-input-method))

  (defun im-change-cursor-color ()
    "Set cursor color depending on input method."
    (interactive)
    (set-cursor-color (if (im--chinese-p)
                          "red"
                        (foreground-color-at-point))))

  (add-hook 'post-command-hook 'im-change-cursor-color)
#+end_src

[[https://emacs-china.org/t/topic/17717/42][åˆ‡æ¢è¾“å…¥æ³•æ—¶è‡ªåŠ¨æ›´æ¢å…‰æ ‡é¢œè‰² - Emacs-general - Emacs China]] æåˆ°äº† ~post-command-hook~ çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œè°ƒç”¨é¢‘ç¹ã€‚

ä½¿ç”¨ evil å†…ç½®çš„ hook ä¹Ÿå¯ä»¥è¾¾åˆ°åˆ‡æ¢å…‰æ ‡é¢œè‰²çš„åŠŸèƒ½ï¼ŒåŒæ—¶é¿å… ~post-command-hook~ çš„å·¨å¤§å¼€é”€ã€‚

#+begin_src emacs-lisp
  (defun im--chinese-p ()
    "Check if the current input state is Chinese."
    (if (featurep 'rime)
        (and (rime--should-enable-p)
             (not (rime--should-inline-ascii-p))
             current-input-method)
      current-input-method))

  (add-hook 'evil-insert-state-entry-hook
            (lambda ()
              (when (im--chinese-p)
                (set-cursor-color "red"))))

  (add-hook 'evil-insert-state-exit-hook
            (lambda ()
              (set-cursor-color (foreground-color-at-point))))
#+end_src

** Frame
çª—å£é€æ˜ï¼Œæ›´å¤šè§ï¼š[[https://emacs-china.org/t/emacs/2405/11][Emacs é€æ˜çª—å£ - Emacs-general - Emacs China]]
#+begin_src emacs-lisp
  (set-frame-parameter nil 'alpha '(100 . 100))
#+end_src

åœ¨ MacOS ä¸Šæ–°å»ºçš„ frame æ€»æ˜¯ä½äºå±å¹•çš„å·¦ä¸Šè§’ã€‚è§£å†³æ–¹æ¡ˆï¼š[[https://christiantietze.de/posts/2021/06/emacs-center-window/][Automatically Center New Emacs Windows (Aka Frames) on Screen â€¢ Christian Tietze]].
#+begin_src emacs-lisp
  (defun ct/frame-center (&optional frame)
    "Center a frame on the screen."
    (interactive)
    (let* ((frame (or (and (boundp 'frame) frame) (selected-frame)))
           (center (ct/frame-get-center frame)))
      (apply 'set-frame-position (flatten-list (list frame center)))))

  (defun ct/screen-usable-height (&optional display)
    "Return the usable height of the display.

  Some window-systems have portions of the screen which Emacs
  cannot address. This function should return the height of the
  screen, minus anything which is not usable."
    (- (display-pixel-height display)
       (cond ((eq window-system 'ns) 22) ;; macOS Menu Bar offset
             (t 0))))

  (defun ct/screen-usable-width (&optional display)
    "Return the usable width of the display."
    (display-pixel-width display))

  (defun ct/center-box (w h cw ch)
    "Center a box inside another box.

  Returns a list of `(TOP LEFT)' representing the centered position
  of the box `(w h)' inside the box `(cw ch)'."
    (list (/ (- cw w) 2) (/ (- ch h) 2)))

  (defun ct/frame-get-center (frame)
    "Return the center position of FRAME on it's display."
    (let ((disp (frame-parameter frame 'display)))
      (ct/center-box (frame-pixel-width frame) (frame-pixel-height frame)
                     (ct/screen-usable-width disp) (ct/screen-usable-height disp))))

  (defun ct/frame-center (&optional frame)
    "Center a frame on the screen."
    (interactive)
    (apply 'set-frame-position
           (let* ((frame (or (and (boundp 'frame) frame) (selected-frame)))
                  (center (ct/frame-get-center frame)))
             ;; Flatten the X/Y list in `center` into a single list with `frame`
             ;; so this list can be applied as parameters to `set-frame-position`:
             `(,frame ,@center))))

  (add-to-list 'after-make-frame-functions #'ct/frame-center 0)
#+end_src

é»˜è®¤çš„ make-frame çš„æŒ‰é”®æ˜¯ ~s-n~, ä½¿ç”¨ä¿®æ”¹çš„å‡½æ•°å®ç°äº†åŒä¸€ä¸ªæŒ‰é”®ï¼Œä¸¤ç§å½¢ä¸ºã€‚æˆ‘é»˜è®¤çš„ frame æ˜¯å…¨å±ä½¿ç”¨ï¼Œåªåœ¨å°‘æ•°æ—¶å€™ä½¿ç”¨ make-frame çš„åŠŸèƒ½ã€‚
#+begin_src emacs-lisp
  (defun my/make-or-delete-frame ()
    (interactive)
    (if (= (frame-width) 80) ;; 80 is the default frame width.
        (delete-frame)
      (make-frame)))

  (global-set-key (kbd "s-n") 'my/make-or-delete-frame)
#+end_src

** modeline
*** mode-line-format
2023-01-30 å‘ç° doom-modeline æ€»æ˜¯åœ¨ä¸åœçš„ =redisplay_internal= ï¼Œéœ€è¦æ¶ˆè€—è¾ƒå¤šçš„èµ„æºã€‚æ‰€ä»¥æš‚æ—¶ç¦ç”¨æ­¤åŒ…ï¼Œé€šè¿‡è‡ªå®šä¹‰ mode-line-format æ¥é…ç½® modelineã€‚
#+begin_example
           210  56% + command-execute
            94  25% + ...
            62  16% - redisplay_internal (C function)
            61  16%  - eval
            51  13%   + doom-modeline-segment--buffer-info
             9   2%   + doom-modeline-format--main
             1   0%   + doom-modeline-segment--modals
#+end_example

[[https://emacs.stackexchange.com/questions/5529/how-to-right-align-some-items-in-the-modeline][mode line - How to right align some items in the modeline? - Emacs Stack Exchange]]
ä»¥ä¸‹çš„å‡½æ•°æ¥è‡ªä¸Šé¢çš„é“¾æ¥ä¸­çš„å›ç­”ï¼Œä½¿ç”¨ ~string-width~ æ›¿ä»£äº† ~length~ ï¼Œå¦åˆ™åœ¨å¯¹å«æœ‰ä¸­æ–‡çš„ heading è¿›è¡Œ org-clock çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´è¶…å‡º mode-line åªæ˜¾ç¤ºéƒ¨ä»½çš„ headingã€‚

2023-02-01 Emacs 29 ä¸Šä½¿ç”¨ ~string-pixel-width~ æ›¿ä»£ ~string-width~ ï¼Œå¯ä»¥è·å¾—è±¡ç´ çº§å¯¹é½ã€‚
#+begin_src emacs-lisp
  (defun my/mode-line-padding ()
    (let* ((r-length (string-width (format-mode-line global-mode-string))))
      (propertize " "
                  'display `(space :align-to (- right ,(+ r-length 1))))))

  (add-to-list 'global-mode-string
               '(:eval (propertize
                        (concat
                         "ğš»ğš¨ğš© "
                         (number-to-string (tab-bar--current-tab-index))
                         ": "
                         (alist-get 'group (tab-bar--current-tab))) 'face 'font-lock-constant-face)))

  (setq mode-line-end-spaces
        '(""
          global-mode-string))

  (setq mode-line-position-column-line-format '(" %l,%c"))

  (setq mode-line-percent-position '(-4 "%p"))

  (setq-default mode-line-format
                `("%e"
                  mode-line-front-space
                  (:propertize ("" mode-line-mule-info mode-line-client mode-line-modified mode-line-remote))
                  mode-line-frame-identification
                  mode-line-buffer-identification
                  mode-line-position
                  ;; (:eval (propertize " %I " 'face 'font-lock-constant-face))
                  "  "
                  (vc-mode vc-mode)
                  (:eval (when buffer-read-only
                           (concat "  "  (propertize "RO"
                                                     'face 'font-lock-type-face
                                                     'help-echo "Buffer is read-only"))))
                  (:eval (my/mode-line-padding))
                  mode-line-end-spaces))
#+end_src
ä¸Šå¼ä¸­çš„ ~%e~ ç­‰è¯´æ˜å¦‚ä¸‹ï¼š[[http://emacs-fu.blogspot.com/2011/08/customizing-mode-line.html][emacs-fu: customizing the mode-line]].
#+begin_quote
  %b -- print buffer name.      %f -- print visited file name.
  %F -- print frame name.
  %* -- print %, * or hyphen.   %+ -- print *, % or hyphen.
        %& is like %*, but ignore read-only-ness.
        % means buffer is read-only and * means it is modified.
        For a modified read-only buffer, %* gives % and %+ gives *.
  %s -- print process status.   %l -- print the current line number.
  %c -- print the current column number (this makes editing slower).
        To make the column number update correctly in all cases,
        `column-number-mode' must be non-nil.
  %i -- print the size of the buffer.
  %I -- like %i, but use k, M, G, etc., to abbreviate.
  %p -- print percent of buffer above top of window, or Top, Bot or All.
  %P -- print percent of buffer above bottom of window, perhaps plus Top,
        or print Bottom or All.
  %n -- print Narrow if appropriate.
  %t -- visited file is text or binary (if OS supports this distinction).
  %z -- print mnemonics of keyboard, terminal, and buffer coding systems.
  %Z -- like %z, but including the end-of-line format.
  %e -- print error message about full memory.
  %@ -- print @ or hyphen.  @ means that default-directory is on a
        remote machine.
  %[ -- print one [ for each recursive editing level.  %] similar.
  %% -- print %.   %- -- print infinitely many dashes.
Decimal digits after the % specify field width to which to pad.
#+end_quote

*** mode-line-bell
[[https://github.com/purcell/mode-line-bell][purcell/mode-line-bell: Flash the Emacs mode line instead of ringing the bell]] å¦‚é¢˜ã€‚
#+begin_src emacs-lisp
  (use-package mode-line-bell
    :hook (on-first-buffer . mode-line-bell-mode))
#+end_src

** rainbow-mode
#+begin_src emacs-lisp
  (use-package rainbow-mode
    :hook (prog-mode . rainbow-mode))
#+end_src

** rainbow-delimiters
#+begin_src emacs-lisp
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

** pulse

#+begin_src emacs-lisp
  (defun pulse-line (&rest _)
    "Pulse the current line."
    (pulse-momentary-highlight-one-line (point)))

  (dolist (command '(evil-paste-after
                     evil-paste-pop
                     evil-paste-before
                     evil-delete
                     evil-delete-line))
    (advice-add command :after #'pulse-line))
#+end_src
** dashboard
Dashboard å¯ä»¥è®©å¯åŠ¨ç•Œé¢çœ‹èµ·æ¥æ¯” scratch ç•Œé¢æ›´ fancy, ä½†æ˜¯ä¼šæ¯”è¾ƒæ˜æ˜¾çš„å¢åŠ å¯åŠ¨æ—¶é—´ï¼Œæœ‰æ˜æ˜¾çš„è¿Ÿé¡¿æ„Ÿã€‚

Dashboard ç•Œé¢çš„ banner ä½¿ç”¨çš„æ˜¯ ~ascii art~, å¯ä»¥é€šè¿‡ [[https://ascii.co.uk/][ASCII.co.uk - The home of all things ASCII]] ç”Ÿæˆã€‚

æˆ–è€…ä¸ä½¿ç”¨ dashboard, å°†å¯åŠ¨ç•Œé¢è®¾ç½®æˆå›¾ç‰‡ç­‰ï¼Œå‚è§ [[https://emacs-china.org/t/topic/264/33][å¦‚ä½•è‡ªå®šä¹‰ Banner çš„å›¾æ¡ˆï¼Ÿ - Spacemacs - Emacs China]].

ä¹Ÿå¯ä»¥ç»“åˆ [[https://www.emacswiki.org/emacs/TipOfTheDay][EmacsWiki: Tip Of The Day]].

#+begin_src emacs-lisp
  (use-package dashboard
    :config
    (setq dashboard-center-content t)
    (setq dashboard-set-init-info t)
    (setq dashboard-set-footer nil)
    (setq dashboard-banner-logo-title nil)
    (setq dashboard-heading-icons t)
    (dashboard-setup-startup-hook)
    (setq dashboard-items '((recents  . 5)
                            (bookmarks . 5)
                            (agenda . 5)))
    (require 'cal-china)
    (let* ((ny (calendar-gregorian-from-absolute
                (cadr (assoc 1 (calendar-chinese-year
                                (string-to-number
                                 (format-time-string "%Y" (current-time))))))))
           (m (string-to-number (format-time-string "%m" (current-time))))
           (d (string-to-number (format-time-string "%d" (current-time)))))
      (if (and (= d (cadr ny))
               (= m (car ny)))
          (setq dashboard-startup-banner (expand-file-name "src/banner2.txt" user-emacs-directory))
        (setq dashboard-startup-banner (expand-file-name "src/banner.txt" user-emacs-directory))))
    (setq dashboard-set-navigator t)
    (with-eval-after-load 'all-the-icons
      (setq dashboard-navigator-buttons
            `(((,(all-the-icons-octicon "mark-github" :height 1 :v-adjust 0.0)
                "Emacs Configuration" "Browse homepage"
                (lambda (&rest _) (browse-url "https://github.com/Jousimies/.emacs.d")))
               (,(all-the-icons-octicon "law" :height 1 :v-adjust 0.0)
                "Blog" "Browse blog"
                (lambda (&rest _) (browse-url "https://jousimies.github.io"))))))))

  (my/space-leader-def
    "bo" '(dashboard-open :wk "*Dashboard*"))

  (with-eval-after-load 'evil
    (evil-define-key 'motion 'dashboard-mode-map
      "gf" 'find-file
      "gb" 'consult-buffer))

  (run-with-idle-timer 300 t #'dashboard-open)
#+end_src
** color-identifiers-mode
#+begin_src emacs-lisp
  (use-package color-identifiers-mode
    :hook (on-first-file . global-color-identifiers-mode))
#+end_src

* Powerful Emacs Equipped with Builtin Packages
Emacs å†…ç½®äº†å¾ˆå¤šæœ‰ç”¨çš„ mode, è¯¦ç»†å†…å®¹è¯·å‚è€ƒä»“åº“ï¼š[[https://github.com/condy0919/emacs-newbie][condy0919/emacs-newbie: Introduction to Emacs]]. åˆå­¦è€…å¯ä»¥çœ‹çœ‹ã€‚
** Better default
#+begin_src emacs-lisp
  (setq frame-inhibit-implied-resize t)
  (setq use-file-dialog nil)
  (setq use-dialog-box nil)
#+end_src

#+begin_src emacs-lisp
  (setq-default ring-bell-function 'ignore
                use-short-answers t
                read-process-output-max #x10000
                message-kill-buffer-on-exit t
                message-kill-buffer-query nil
                indent-tabs-mode nil
                tab-width 4
                make-backup-files nil
                create-lockfiles nil
                confirm-kill-processes nil
                confirm-kill-emacs nil
                recenter-redisplay nil
                load-prefer-newer t
                mark-ring-max 128
                next-screen-context-lines 5
                inhibit-default-init t
                inhibit-startup-message t
                inhibit-splash-screen t
                inhibit-compacting-font-caches t
                ;; inhibit-quit nil
                fast-but-imprecise-scrolling t
                scroll-preserve-screen-position t
                auto-save-default nil
                auto-save-list-file-name nil
                kill-do-not-save-duplicates t
                kill-ring-max (* kill-ring-max 2)
                history-delete-duplicates t
                view-read-only t
                kill-read-only-ok t
                async-shell-command-display-buffer nil
                ;; Improve the performance of rendering long lines.
                bidi-display-reordering nil)

  (setq ffap-machine-p-known 'reject)
#+end_src

** system coding
#+begin_src emacs-lisp
  (prefer-coding-system 'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
#+end_src

** profiler
#+begin_src emacs-lisp
  (add-hook 'profiler-report-mode-hook #'hl-line-mode)
#+end_src

** buffer
#+begin_src emacs-lisp
  (setq switch-to-buffer-in-dedicated-window 'pop)
  (setq switch-to-buffer-obey-display-actions t)
#+end_src
#+begin_src emacs-lisp
  (my/space-leader-def
    "b" '(:ignore t :wk "Buffer/Bookmark")
    "be" '(eval-buffer :wk "Eval buffer")
    "bk" '(kill-this-buffer :wk "Kill This Buffer"))

  (with-eval-after-load 'evil
    (evil-define-key 'normal 'global
      "gB" 'switch-to-prev-buffer
      "gb" 'switch-to-buffer
      "zx" 'kill-current-buffer))
#+end_src

** calculator
#+begin_src emacs-lisp
  (use-package calc
    :hook ((calc-trail-mode . (lambda ()
                                (setq-local mode-line-format nil)))
           (calc-mode . (lambda ()
                          (setq-local mode-line-format nil))))
    :config
    (setq calc-window-height 15))

  (my/comma-leader-def
    "C" '(calc :wk "calc"))
#+end_src

** column-number-mode
ä½œç”¨æ˜¯åœ¨ modeline ä¸­æ˜¾ç¤ºå½“å‰å…‰æ ‡ç«–å‘å¤„çš„ä½ç½®ã€‚

#+begin_src emacs-lisp
  (add-hook 'prog-mode-hook 'column-number-mode)
#+end_src

** size-indication-mode
ä½œç”¨æ˜¯åœ¨ modeline ä¸­æ˜¾ç¤ºæ–‡ä»¶çš„å¤§å°ã€‚

#+begin_src emacs-lisp
  (add-hook 'find-file-hook 'size-indication-mode)
#+end_src

** delete-selection-mode
ä½œç”¨æ˜¯å½“é€‰ä¸­åŒºåŸŸåè¾“å…¥å­—ç¬¦ä¼šåˆ é™¤é€‰ä¸­çš„åŒºåŸŸï¼Œå¤§éƒ¨ä»½è½¯ä»¶éƒ½æ˜¯è¿™ç§è¡Œä¸ºã€‚

#+begin_src emacs-lisp
  (add-hook 'on-first-input-hook 'delete-selection-mode)
#+end_src

** winner-mode
è¿›è¡Œçª—å£ç®¡ç†ã€‚
#+begin_src emacs-lisp
  (setq-default winner-dont-bind-my-keys t)
  (add-hook 'on-first-buffer-hook 'winner-mode)
  (setq winner-boring-buffers '("*Completions*"
                                "*Compile-Log*"
                                "*inferior-lisp*"
                                "*Fuzzy Completions*"
                                "*Apropos*"
                                "*Help*"
                                "*cvs*"
                                "*Buffer List*"
                                "*Ibuffer*"
                                "*esh command on file*"))
#+end_src
#+begin_src emacs-lisp
  (my/space-leader-def
    "w" '(:ignore t :wk "Window")
    "wu" '(winner-undo :wk "Undo winner")
    "wr" '(winner-redo :wk "Redo winner"))
#+end_src

** auto-revert-mode
#+begin_src emacs-lisp
  (add-hook 'on-first-file-hook 'global-auto-revert-mode)
#+end_src

** tab-bar-mode
å¯ä»¥å°† mode-line ä¸Šçš„ä¸€äº›ä¿¡æ¯æ˜¾ç¤ºåœ¨ tab-bar ä¹‹ä¸Šã€‚
#+begin_example
(setq tab-bar-format '(tab-bar-format-history
                       tab-bar-format-tabs
                       tab-bar-format-align-right
                       tab-bar-format-global))
#+end_example
#+begin_src emacs-lisp
  (use-package tab-bar
    :hook (on-first-file . tab-bar-mode)
    :config
    (setq tab-bar-new-tab-choice "*dashboard*")
    (setq tab-bar-close-button-show nil)
    (setq tab-bar-tab-hints nil)
    (setq tab-bar-show nil))

  (use-package tabspaces
    :after tab-bar
    :hook (tab-bar-mode . tabspaces-mode)
    :config
    (setq tabspaces-session-file
          (expand-file-name "tabsession.el" no-littering-var-directory))
    (setq tabspaces-use-filtered-buffers-as-default t))
#+end_src
#+begin_src emacs-lisp
  (my/space-leader-def
    "t" '(:ignore t :wk "Tabs")
    "tn" '(tab-new :wk "New")
    "tg" '(tab-group :wk "Group")
    "tr" '(tab-bar-switch-to-recent-tab :wk "Recent")
    "tc" '(tab-close :wk "Close")
    "tC" '(tab-close-group :wk "Close group")
    "tO" '(tab-close-other :wk "Close other"))

  (with-eval-after-load 'evil
    (evil-define-key 'normal 'global
      "gs" 'tab-switch))
#+end_src
#+begin_src emacs-lisp
  (add-to-list 'display-buffer-alist
               '("^.*\\.\\(org\\|md\\|tex\\|log\\)$"
                 (display-buffer-in-tab)
                 (tab-name . "Edit")
                 (tab-group . "Edit")))

  (add-to-list 'display-buffer-alist
               '((or (derived-mode . dired-mode)
                     (derived-mode . dirvish-mode))
                 (display-buffer-in-tab)
                 (tab-name . "Dired")
                 (tab-group . "Dired")))

  (add-to-list 'display-buffer-alist
               '((derived-mode . image-mode)
                 (display-buffer-in-tab)
                 (tab-name . "Pic")
                 (tab-group . "Pic")))

  (add-to-list 'display-buffer-alist
               '((derived-mode . emacs-lisp-mode)
                 (display-buffer-in-tab)
                 (tab-name . "Prog")
                 (tab-group . "Prog")))

  (add-to-list 'display-buffer-alist
               `(,(rx (| "*scratch*"
                         "*dashboard*"
                         "*Messages*"))
                 (display-buffer-in-tab)
                 (tab-name . "Home")
                 (tab-group . "Home")
                 (window-parameters . ((mode-line-format . none)))))
#+end_src
** savehist-mode
#+begin_src emacs-lisp
  (setq history-length 1000
        savehist-save-minibuffer-history 1
        savehist-additional-variables '(kill-ring
                                        search-ring
                                        regexp-search-ring)
        history-delete-duplicates t)
  (add-hook 'on-first-file-hook 'savehist-mode)
#+end_src

** save-place-mode
#+begin_src emacs-lisp
  (add-hook 'on-first-buffer-hook 'save-place-mode)
#+end_src

** midnight-mode
ä½œç”¨æ˜¯åŠå¤œçš„æ—¶å€™è‡ªåŠ¨æ¸…ç† bufferã€‚æ€€ç–‘è¿™ä¸ªå¯¼è‡´ mu4e å‡ºç° error code 1 çš„é”™è¯¯ï¼Œå…ˆå…³é—­è¯•è¯•ã€‚
#+begin_src emacs-lisp
  (add-hook 'on-first-buffer-hook 'midnight-mode)
#+end_src

** so-long-mode
#+begin_src emacs-lisp
  (add-hook 'text-mode-hook 'global-so-long-mode)
  (setq-default large-file-warning-threshold nil)
  (when (fboundp 'so-long-enable)
    (add-hook 'on-first-file-hook 'so-long-enable))
#+end_src

** electric-pair-mode
#+begin_src emacs-lisp
  (add-hook 'prog-mode-hook 'electric-pair-mode)
  (add-hook 'org-mode-hook 'electric-pair-mode)
#+end_src

** prettify-symbols-mode
#+begin_src emacs-lisp
  (setq prettify-symbols-alist '(("lambda" . ?Î»)
                                 ("function" . ?ğ‘“)))
  (add-hook 'prog-mode-hook 'prettify-symbols-mode)
  (add-hook 'LaTeX-mode-hook 'prettify-symbols-mode)
#+end_src

** hippie-expand
#+begin_src emacs-lisp
  (setq hippie-expand-try-functions-list '(try-complete-file-name-partially
                                           try-complete-file-name
                                           try-expand-all-abbrevs
                                           try-expand-dabbrev
                                           try-expand-dabbrev-all-buffers
                                           try-expand-dabbrev-from-kill
                                           try-complete-lisp-symbol-partially
                                           try-complete-lisp-symbol))
  (global-set-key [remap dabbrev-expand] 'hippie-expand)
#+end_src

** outline-minor-mode
#+begin_src emacs-lisp
  (add-hook 'prog-mode-hook 'outline-minor-mode)
#+end_src

** pixel-scroll-precision-mode
è¿™ä¸ª mode ä¸å¥½ç”¨ï¼Œä½¿ç”¨è§¦æ‘¸æ¿å¤§å¹…åº¦æ»šåŠ¨å±å¹•åï¼Œä¼šè‡ªåŠ¨å›åˆ°åŸå…ˆçš„ä½ç½®ã€‚
#+begin_src emacs-lisp
  (use-package loaddefs
    :hook (on-first-file . pixel-scroll-precision-mode))
#+end_src

** recentf-mode
#+begin_src emacs-lisp
  (use-package recentf
    :hook (on-first-buffer . recentf-mode)
    :config
    (setq recentf-auto-cleanup 300)
    (setq recentf-max-saved-items 1000))

  (with-eval-after-load 'evil
    (evil-define-key 'normal 'global
      "gr" 'recentf-open-files))
#+end_src

** visual-line-mode
#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'turn-on-visual-line-mode)
  (add-hook 'org-roam-mode-hook 'turn-on-visual-line-mode)
  (add-hook 'LaTeX-mode-hook #'turn-on-visual-line-mode)
#+end_src

** word-wrap-whitespace-mode
è¿™ä¸ªæ˜¯ Emacs 29 ä¸­çš„åŠŸèƒ½ï¼Œå…·ä½“è§ï¼š[[https://github.com/emacs-mirror/emacs/commit/c789430331948e76b38091aa95bb9a9602a08289][Add new minor mode word-wrap-whitespace-mode Â· emacs-mirror/emacs@c789430]]

å¦‚æœä½ ä½¿ç”¨ emacs 29 ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œå°†è¿™ä¸ªæ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°å¯ä»¥ä½¿ç”¨ã€‚
#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'word-wrap-whitespace-mode)
  (add-hook 'org-roam-mode-hook 'word-wrap-whitespace-mode)
#+end_src

** dired
#+begin_src emacs-lisp
  (use-package dired
    :bind ("C-x d" . dired)
    :config
    (setq insert-directory-program "/opt/homebrew/bin/gls")
    (setq dired-use-ls-dired t)
    (setq dired-dwim-target t)
    (setq dired-auto-revert-buffer #'dired-buffer-stale-p)
    (setq dired-recursive-copies 'always)
    (setq dired-recursive-deletes 'top)
    (setq dired-listing-switches
          "-l --almost-all --human-readable --group-directories-first --no-group")
    (setq dired-auto-revert-buffer t))
#+end_src

*** dired-hide-dotfiles
#+begin_src emacs-lisp
  (use-package dired-hide-dotfiles
    :bind (:map dired-mode-map
                ("s-." . dired-hide-dotfiles-mode)))
#+end_src

*** dirvish
#+begin_src emacs-lisp
  (use-package dirvish
    :bind ([remap dired] . dirvish)
    :config
    (setq dirvish-use-header-line nil)
    (setq dirvish-use-mode-line nil)
    (setq dirvish-hide-cursor nil)
    (with-eval-after-load 'doom-modeline
      (setq dirvish-mode-line-height doom-modeline-height))

    (setq dirvish-default-layout '(0 0.4 0.6))
    (setq dirvish-header-line-format
          '(:left (path) :right (free-space)))
    (setq dirvish-mode-line-format
          '(:left (sort file-time " " file-size symlink) :right (omit yank index)))
    :hook ((dirvish-find-entry . (lambda (&rest _) (setq-local truncate-lines t)))
           (on-switch-buffer . dirvish-override-dired-mode)))
#+end_src

~e~ ç»‘å®šçš„å‡½æ•°è§ï¼š[[Open file with system file manager]]
#+begin_src emacs-lisp
  (with-eval-after-load 'evil-collection
    (evil-collection-define-key 'normal 'dirvish-mode-map
      "q" 'dirvish-quit
      "e" 'xah-show-in-desktop))

  ;; dired has default keybinding, C-x d, remap it to dirvish.

  (with-eval-after-load 'evil
    (evil-define-key 'normal 'global
      "zd" 'dirvish-quick-access))
#+end_src

*** consult-dir
#+begin_src emacs-lisp
  (use-package consult-dir
    :bind (("C-x C-d" . consult-dir)
           (:map minibuffer-mode-map
                 ("C-x C-d" . consult-dir)
                 ("C-x C-j" . consult-dir-jump-file))))
#+end_src
** window-divider-mode
#+begin_src emacs-lisp
  (use-package frame
    :config
    (face-spec-set 'window-divider
                   '((((background light))
                      :foreground "#000000")
                     (t
                      :foreground "#FFFFFF"))
                   'face-override-spec)
    (setq window-divider-default-bottom-width 1)
    (setq window-divider-default-places 'bottom-only)
    :hook (after-init . window-divider-mode))
#+end_src

** doc-view
#+begin_src emacs-lisp
  (setq doc-view-mupdf-use-svg t)
  (setq doc-view-imenu-flatten t)
  (setq doc-view-continuous t)
#+end_src

** abbrev-mode
#+begin_src emacs-lisp
  (setq-default abbrev-mode t)
#+end_src

** bookmark
#+begin_src emacs-lisp
  (my/space-leader-def
    "ba" 'bookmark-set
    "br" 'bookmark-rename
    "bd" 'bookmark-delete
    "bj" 'bookmark-jump)
#+end_src

** clipboard
#+begin_src emacs-lisp
  (setq select-enable-primary t)
#+end_src

** files
[[https://emacsredux.com/blog/2022/06/12/auto-create-missing-directories/][Auto-create Missing Directories | Emacs Redux]].
#+begin_src emacs-lisp
  (defun my/auto-create-missing-dirs ()
    (let ((target-dir (file-name-directory buffer-file-name)))
      (unless (file-exists-p target-dir)
        (make-directory target-dir t))))

  (add-to-list 'find-file-not-found-functions #'my/auto-create-missing-dirs)
#+end_src
* Awesome Emacs Equipped with Third-Party Packages
** undo
Emacs è‡ªå¸¦ undo å’Œ undo-redo åŠŸèƒ½ã€‚è¿™é‡Œä½¿ç”¨äº† ~undo-fu~ å’Œ ~undo-fu-session~ ä»¥åŠ ~vundo~ è¿™ä¸‰ä¸ªåŒ…ã€‚

Evil æ¨¡å¼ç¼–è¾‘éœ€è¦è®¾ç½® undo system.
#+begin_src emacs-lisp
  (use-package undo-fu)

  (use-package undo-fu-session
    :after undo-fu
    :hook (on-first-file . undo-fu-session-global-mode))
#+end_src

#+begin_src emacs-lisp
  (use-package vundo
    :config
    (setq vundo-glyph-alist vundo-unicode-symbols)
    :bind ("C-x u" . vundo))
#+end_src

** delete
å…³äº Emacs ä¸­çš„åˆ é™¤ï¼Œä¸€ä¸ªæ˜¯ ~delete-selection-mode~, ~hungry-delelte~ ä»¥åŠæ˜¯å¦ä½¿ç”¨ç³»ç»Ÿåƒåœ¾æ¡¶ã€‚
#+begin_src emacs-lisp
  (setq delete-by-moving-to-trash t)
  (setq trash-directory "~/.Trash")
#+end_src

[[https://github.com/nflath/hungry-delete][nflath/hungry-delete: Enables hungry deletion in all modes.]]
#+begin_src emacs-lisp
  (use-package hungry-delete
    :custom
    (hungry-delete-chars-to-skip " \t\n\r\f\v")
    :hook ((text-mode . hungry-delete-mode)
           (prog-mode . hungry-delete-mode)
           (org-mode . hungry-delete-mode)))
#+end_src

** gc-buffers
ä½œç”¨æ˜¯è‡ªåŠ¨åˆ é™¤ buffers.
#+begin_src emacs-lisp
  (use-package gc-buffers
    :hook (on-first-buffer . gc-buffers-mode))
#+end_src

** COMMENT ace-window
ä½œç”¨æ˜¯æ–¹ä¾¿è¿›è¡Œçª—å£çš„è·³è½¬ï¼Œå¯¹äºç¬”è®°æœ¬è¿™ç§ä¸å¤§çš„å±å¹•ä¸æ€ä¹ˆéœ€è¦ï¼Œå¦‚æœæ˜¯è¾ƒå¤§çš„å±å¹•å¾ˆæœ‰ç”¨ã€‚å¯ä»¥ç»“åˆ winner è¿›è¡Œä½¿ç”¨ã€‚

å¯¹äºåŒä¸€ buffer ä¸­ä½ç½®çš„è·³è½¬ï¼Œæƒ³è¦å›åˆ°ä¹‹å‰çš„ä½ç½®å¯ä»¥ä½¿ç”¨ ~evil-jump-backward~.
#+begin_src emacs-lisp
  (use-package ace-window
    :bind ("C-x o" . ace-window))
#+end_src

** COMMENT sis
[[https://www.sheerwill.live/posts/main/20220723211325-vanilla_emacs_with_purcell/#init-sis-dot-el][Vanilla Emacs with Purcell | Lucius | Braindump]]
#+begin_src emacs-lisp
  (use-package sis
    :config
    (setq sis-other-cursor-color "red")
    (setq sis-english-source "com.apple.keylayout.ABC")
    (setq sis-other-source "im.rime.inputmethod.Squirrel.Hans")
    (add-hook 'evil-insert-state-exit-hook #'sis-set-english)
    (sis-global-cursor-color-mode t)
    (sis-global-context-mode t)
    (sis-global-respect-mode t)
    (sis-global-inline-mode t))
#+end_src
** rime
#+begin_src emacs-lisp
  (use-package rime
    :init
    (setq rime-title "ğ‘ ")
    :config
    (setq default-input-method "rime")
    (setq rime-user-data-dir "~/Library/Rime/")
    (setq rime-emacs-module-header-root "/Applications/Emacs.app/Contents/Resources/include/")
    (setq rime-librime-root (expand-file-name "librime/dist" user-emacs-directory))
    (setq rime-show-candidate 'minibuffer)
    ;; (setq rime-posframe-properties '(:internal-border-width 0))
    (setq rime-disable-predicates '(rime-predicate-prog-in-code-p
                                    rime-predicate-org-in-src-block-p
                                    rime-predicate-org-latex-mode-p
                                    rime-predicate-tex-math-or-command-p))

    (setq rime-inline-predicates '(rime-predicate-space-after-cc-p
                                   rime-predicate-after-alphabet-char-p))
    :bind (:map rime-mode-map
                ("M-j" . rime-force-enable))
    :hook ((evil-insert-state-entry . (lambda ()
                                        (if (and (not (rime--should-inline-ascii-p))
                                                 (eq major-mode 'org-mode)
                                                 (not (org-at-clock-log-p))
                                                 (not (org-at-table-p))
                                                 (not (org-at-timestamp-p))
                                                 (not (and (bolp) (org-on-heading-p))))
                                            (activate-input-method "rime"))))
           (evil-insert-state-exit .  #'evil-deactivate-input-method)))
#+end_src

è¿›è¡Œ Evil çš„ insert çŠ¶æ€æ—¶è‡ªåŠ¨çš„åˆ‡æ¢ä¸­è‹±æ–‡è¾“å…¥æ³•çš„çŠ¶æ€ï¼Œç»“åˆ rime çš„ predicates ä½¿ç”¨ã€‚

[[https://github.com/colawithsauce/rime-regexp.el/tree/main/][rime-regexp-mode]], é€šè¿‡æ­¤åŒ…å¯ä»¥ä½¿ç”¨è¾“å…¥æ³•è¿›è¡Œæ–‡ä»¶çš„æ£€ç´¢ï¼Œè‹¥ä½¿ç”¨æ‹¼éŸ³è¾“å…¥æ³•åˆ™å¯ä»¥é€šè¿‡æ‹¼éŸ³è¿›è¡Œæ–‡ä»¶åçš„æ£€ç´¢ã€‚æˆ‘ä½¿ç”¨ä¸‰éƒ‘è¾“å…¥æ³•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å½¢ç è¿›è¡Œæ£€ç´¢ã€‚
#+begin_src emacs-lisp
  (use-package rime-regexp
    :hook (on-first-input . rime-regexp-mode))
#+end_src

** helpful
#+begin_src emacs-lisp
  (use-package helpful
    :commands helpful-update
    :bind (([remap describe-function] . helpful-callable)
           ([remap describe-variable] . helpful-variable)
           ([remap describe-key] . helpful-key))
    :init
    (setq help-window-select 'always)
    (setq help-window-keep-selected t)
    :config
    (add-to-list 'display-buffer-alist
                 '((or (derived-mode . help-mode)
                       (derived-mode . helpful-mode))
                   (display-buffer-reuse-mode-window display-buffer-in-side-window)
                   (window-width . 0.5)
                   (side . right)
                   (slot . 0))))
#+end_src
#+begin_src emacs-lisp
  (autoload #'elisp-demos-advice-helpful-update "elisp-demos" nil t)
  (advice-add 'helpful-update :after #'elisp-demos-advice-helpful-update)
#+end_src
** expand-region
è¿™ä¸ªç”¨äºæ‰©å±•é€‰åŒºï¼Œæœ‰æ—¶å€™æ¯” Evil çš„ Visual å¥½ç”¨ã€‚æœ€æ–°çš„é…ç½®ä¸­å·±ç»ä½¿ç”¨ =v= æ›¿ä»£äº† =C-== è¿™ä¸ªå¿«æ·é”®ã€‚
#+begin_src emacs-lisp
  (use-package expand-region
    :after evil
    :bind (("C-=" . er/expand-region)
           (:map evil-visual-state-map
                 ("v" . er/expand-region))))
#+end_src

** COMMENT symbol-overlay
#+begin_src emacs-lisp
  (dolist (hook '(prog-mode-hook html-mode-hook yaml-mode-hook conf-mode-hook))
    (add-hook hook 'symbol-overlay-mode))

  (with-eval-after-load 'symbol-overlay
    (define-key symbol-overlay-mode-map (kbd "M-i") 'symbol-overlay-put)
    (define-key symbol-overlay-mode-map (kbd "M-I") 'symbol-overlay-remove-all)
    (define-key symbol-overlay-mode-map (kbd "M-n") 'symbol-overlay-jump-next)
    (define-key symbol-overlay-mode-map (kbd "M-p") 'symbol-overlay-jump-prev)
    (define-key symbol-overlay-mode-map (kbd "s-r") 'symbol-overlay-rename))
#+end_src

** COMMENT bicycle
#+begin_src emacs-lisp
  (with-eval-after-load 'outline
    (define-key outline-minor-mode-map (kbd "C-<tab>") 'bicycle-cycle)
    (define-key outline-minor-mode-map (kbd "S-<tab>") 'bicycle-cycle-global))
#+end_src

** ctrlf
#+begin_src emacs-lisp
  (use-package ctrlf
    :after evil
    :hook (on-first-buffer . ctrlf-mode)
    :config
    (evil-global-set-key 'normal (kbd "/") 'ctrlf-forward-default))
#+end_src
** avy
#+begin_src emacs-lisp
  (my/comma-leader-def
    "g" '(:ignore t :wk "Goto")
    "gc" '(avy-goto-char :wk "Goto Char")
    "gC" '(avy-goto-char-2 :wk "Goto Char 2")
    "gl" '(avy-goto-line :wk "Goto Line")
    "gw" '(avy-goto-word-0 :wk "Goto Line"))
#+end_src
** whitespace-cleanup-mode
#+begin_src emacs-lisp
  (use-package whitespace-cleanup-mode
    :hook (on-first-file . whitespace-cleanup-mode))
#+end_src

** elisp-demos
[[https://github.com/xuchunyang/elisp-demos][xuchunyang/elisp-demos: Demonstrate Emacs Lisp APIs]] ç”¨äºæŸ¥æŸ¥å‡½æ•°çš„ç”¨æ³•å¾ˆæ–¹ä¾¿ã€‚

** tempel
#+begin_src emacs-lisp
  (use-package tempel
    :bind (("M-+" . tempel-complete)
           ("M-*" . tempel-insert))
    :config
    (setq tempel-path `("~/.emacs.d/template/tempel"
                        ,(expand-file-name "template/tempel" my-galaxy))))
#+end_src

** yasnippet
#+begin_src emacs-lisp
  (use-package yasnippet
    :hook (on-first-file . yas-global-mode))
  (use-package yasnippet-snippets
    :after yasnippet)
#+end_src

** rg
#+begin_src emacs-lisp
  (use-package rg
    :hook (on-first-input . rg-enable-default-bindings)
    :config
    (setq rg-group-result t)
    (setq rg-show-columns t))
#+end_src

** Minibuffer and completion
*** minibuffer
#+begin_src emacs-lisp
  (setq read-buffer-completion-ignore-case t)
  (setq completion-ignore-case t)
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))

  (use-package simple
    :config
    (setq-default read-extended-command-predicate #'command-completion-default-include-p))

  (use-package minibuffer
    :config
    (setq completion-category-overrides '((file (styles basic partial-completion))))
    (setq read-file-name-completion-ignore-case t)

    (setq-local completion-in-region-function
                (lambda (&rest args)
                  (apply (if vertico-mode
                             #'consult-completion-in-region
                           #'completion--in-region)
                         args))))
#+end_src
*** orderless
#+begin_src emacs-lisp
  (setq tab-always-indent 'complete)

  (use-package orderless
    :config
    (setq completion-styles '(orderless partial-completion)))
#+end_src

*** vertico
#+begin_src emacs-lisp
  (use-package vertico
    :load-path "~/.emacs.d/packages/vertico"
    :hook (after-init . vertico-mode)
    :config
    (setq vertico-cycle t)
    :bind (:map vertico-map
        ("C-j" . vertico-next)
        ("C-k" . vertico-previous)))

  (use-package vertico-directory
    :after vertico
    :bind (:map vertico-map
          ("C-u" . vertico-directory-up)))
#+end_src
*** marginalia
#+begin_src emacs-lisp
  (use-package marginalia
    :hook ((minibuffer-setup . marginalia-mode)))
#+end_src

*** embark
#+begin_src emacs-lisp
  (use-package embark
    :bind (("C-." . embark-act)
           ("M-." . embark-dwim)
           (:map vertico-map
                 ("C-c C-o" . embark-export)
                 ("C-c C-c" . embark-act)))
    :init
    (setq prefix-help-command #'embark-prefix-help-command)
    :config
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none)))))

  (my/space-leader-def
    "fe" '(embark-open-externally :wk "Open externally"))
#+end_src
*** consult
#+begin_src emacs-lisp
  (use-package consult
    :commands consult-outline
    :hook (completion-list-mode . consult-preview-at-point-mode)
    :bind (([remap apropos] . consult-apropos)
           ([remap bookmark-jump] . consult-bookmark)
           ([remap goto-line] . consult-goto-line)
           ([remap imenu] . consult-imenu)
           ([remap locate] . consult-locate)
           ([remap load-theme] . consult-theme)
           ([remap man] . consult-man)
           ([remap recentf-open-files] . consult-recent-file)
           ([remap switch-to-buffer] . consult-buffer)
           ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
           ([remap switch-to-buffer-other-frame] . consult-buffer-other-frame)
           ([remap yank-pop] . consult-yank-pop)
           :map minibuffer-mode-map
           ("C-r" . consult-history)))

  (with-eval-after-load 'evil
    (evil-declare-key 'normal org-mode-map
      "gh" 'consult-outline)
    (evil-declare-key 'normal LaTeX-mode-map
      "gh" 'consult-outline))
#+end_src

*** corfu
#+begin_src emacs-lisp
  (use-package corfu
    :config
    (setq corfu-cycle t)
    (setq corfu-auto t)
    (setq corfu-auto-prefix 2)
    (setq corfu-auto-delay 0.0)
    (setq corfu-preselect 'valid)

    (setq-default corfu-quit-no-match 'separator)
    :init
    (defun corfu-enable-always-in-minibuffer ()
    "Enable Corfu in the minibuffer if Vertico/Mct are not active."
    (unless (or (bound-and-true-p mct--active)
                (bound-and-true-p vertico--input)
                (eq (current-local-map) read-passwd-map))
      (setq-local corfu-auto nil) ;; Enable/disable auto completion
      (setq-local corfu-echo-delay nil ;; Disable automatic echo and popup
                  corfu-popupinfo-delay nil)
      (corfu-mode 1)))
    :hook ((on-first-buffer . global-corfu-mode)
           (eshell-mode-hook . (lambda ()
                                 (setq-local corfu-quit-at-boundary t
                                             corfu-quit-no-match t
                                             corfu-auto nil)
                                 (corfu-mode)))))

  (use-package corfu-echo
    :hook (corfu-mode . corfu-echo-mode))

  (use-package corfu-popupinfo
    :hook (corfu-mode . corfu-popupinfo-mode))
#+end_src

*** kind-icon
#+begin_src emacs-lisp
  (use-package kind-icon
    :after corfu
    :config
    (setq kind-icon-use-icons t)
    (setq kind-icon-default-face 'corfu-default)
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src
*** cape
#+begin_src emacs-lisp
  (use-package cape
    :bind (("C-c p p" . completion-at-point) ;; capf
           ("C-c p t" . complete-tag)        ;; etags
           ("C-c p d" . cape-dabbrev)        ;; or dabbrev-completion
           ("C-c p h" . cape-history)
           ("C-c p f" . cape-file)
           ("C-c p k" . cape-keyword)
           ("C-c p s" . cape-symbol)
           ("C-c p a" . cape-abbrev)
           ("C-c p i" . cape-ispell)
           ("C-c p l" . cape-line)
           ("C-c p w" . cape-dict)
           ("C-c p \\" . cape-tex)
           ("C-c p _" . cape-tex)
           ("C-c p ^" . cape-tex)
           ("C-c p &" . cape-sgml)
           ("C-c p r" . cape-rfc1345))
    :init
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file)
    ;;(add-to-list 'completion-at-point-functions #'cape-history)
    ;;(add-to-list 'completion-at-point-functions #'cape-keyword)
    ;;(add-to-list 'completion-at-point-functions #'cape-tex)
    ;;(add-to-list 'completion-at-point-functions #'cape-sgml)
    ;;(add-to-list 'completion-at-point-functions #'cape-rfc1345)
    ;;(add-to-list 'completion-at-point-functions #'cape-abbrev)
    (add-to-list 'completion-at-point-functions #'cape-ispell)
    (add-to-list 'completion-at-point-functions #'cape-dict)
    ;;(add-to-list 'completion-at-point-functions #'cape-symbol)
    ;;(add-to-list 'completion-at-point-functions #'cape-line)
    )
#+end_src

[[https://github.com/SystemCrafters/crafted-emacs/blob/master/modules/crafted-completion.el][crafted-emacs/crafted-completion.el at master Â· SystemCrafters/crafted-emacs]]
#+begin_src emacs-lisp :tangle no
  ;; Ensure that pcomplete does not write to the buffer
  ;; and behaves as a pure `completion-at-point-function'.
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-purify)
#+end_src
*** prescient
#+begin_src emacs-lisp
  (autoload 'prescient-persist-mode "prescient" "" t)
  (add-hook 'after-init-hook 'prescient-persist-mode)

  (use-package vertico-prescient
    :hook (vertico-mode . vertico-prescient-mode))

  (use-package corfu-prescient
    :hook (corfu-mode . corfu-prescient-mode)
    :config
    (setq vertico-prescient-completion-styles '(orderless prescient partial-completion)))
#+end_src

*** COMMENT company
#+begin_src emacs-lisp :tangle no
  (add-hook 'after-init-hook 'global-company-mode)

  (setq company-idle-delay 0)
  (setq company-minimum-prefix-length 1)
  (setq company-require-match nil)
  (setq company-icon-margin 3)
  (setq company-backends '((company-capf :with company-yasnippet)
                           (company-dabbrev-code company-keywords company-files)
                           ;; (company-ispell :separate)))
                           (company-dabbrev company-ispell :separate)))
  (add-hook 'company-mode-hook 'company-prescient-mode)
#+end_src

**** Company+
Company-box, Default company is good enough.
#+begin_src emacs-lisp :tangle no
  (when (maybe-require-package 'company-box)
    (add-hook 'company-mode-hook 'company-box-mode))
#+end_src

Company-posframe
#+begin_src emacs-lisp
  (add-hook 'company-mode-hook 'company-posframe-mode)
#+end_src

Company-quickhelp
#+begin_src emacs-lisp
  (add-hook 'company-mode-hook 'company-quickhelp-mode)
  (eval-after-load 'company
    '(define-key company-active-map (kbd "C-c h") #'company-quickhelp-manual-begin))
#+end_src

* Misc
** gcmh
Emacs çš„æ‹‰åœ¾å›æ”¶å¤ªå½±å“æ€§èƒ½ï¼Œæ­¤åŒ…çš„ä½œç”¨æ˜¯å½“ Emacs å¤„äº idle çŠ¶æ€æ—¶è¿›è¡Œæ‹‰åœ¾å›æ”¶ï¼Œæ­£å¸¸ä½¿ç”¨çš„æ—¶å€™è®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„é˜ˆå€¼ï¼Œé™ä½åƒåœ¾å›æ”¶ã€‚
#+begin_src emacs-lisp
  (use-package gcmh
    :config
    (setq gcmh-idle-delay 'auto)
    (setq gcmh-auto-idle-delay-factor 10)
    (setq gcmh-high-cons-threshold #x1000000)
    :hook (after-init . gcmh-mode))
#+end_src

** file-info
#+begin_src emacs-lisp
  (use-package file-info
    :bind ("C-c f i" . file-info-show)
    :config
    (setq hydra-hint-display-type 'posframe)
    (setq hydra-posframe-show-params `(:poshandler posframe-poshandler-frame-center
                                                   :internal-border-width 2
                                                   :internal-border-color "#61AFEF"
                                                   :left-fringe 16
                                                   :right-fringe 16))

    (my/space-leader-def
      "fs" '(file-info-show :wk "File info")))
#+end_src
** disk-usage
#+begin_src emacs-lisp
  (use-package disk-usage
    :bind ("C-c d u" . disk-usage))
  (my/space-leader-def
    "d" '(:ignore t :wk "Disk")
    "du" '(disk-usage :wk "usage"))
#+end_src
** youtube-dl
#+begin_src emacs-lisp
  (use-package youtube-dl
    :commands youtube-dl
    :config
    (setq youtube-dl-directory "~/Downloads/")
    (setq youtube-dl-program "/opt/homebrew/bin/youtube-dl")
    (setq youtube-dl-arguments
          '("--no-mtime" "--restrict-filenames" "--format" "best" "--mark-watched")))
#+end_src
** OCR
#+begin_src emacs-lisp
  (defun my/ocr ()
  "OCR with Macos system."
    (interactive)
    (shell-command "shortcuts run \"OCR Selected Area\"")
    (do-applescript "tell application id \"org.gnu.Emacs\" to activate"))

  (my/comma-leader-def
    "o" '(my/ocr :wk "OCR"))
#+end_src
** proxy
#+begin_src emacs-lisp
  (defun toggle-proxy ()
    "Toggle proxy for the url.el library."
    (interactive)
    (if url-proxy-services
        (proxy-disable)
      (proxy-enable)))

  (defun proxy-enable ()
    "Enable proxy."
    (interactive)
    (setq url-proxy-services
          '(("http" . "127.0.0.1:8118")
            ("https" . "127.0.0.1:8118")
            ("socks" . "127.0.0.1:8118")
            ("no_proxy" . "0.0.0.0")))
    (message "Proxy enabled! %s" (car url-proxy-services)))

  (defun proxy-disable ()
    "Disable proxy."
    (interactive)
    (if url-proxy-services
        (setq url-proxy-services nil))
    (message "Proxy disabled!"))

  (run-with-idle-timer 2 nil (lambda ()
                               (proxy-enable)))
#+end_src
#+begin_src emacs-lisp :tangle no
  (my/comma-leader-def
    "p" '(toggle-proxy :wk "Proxy"))
#+end_src
** word-count
#+begin_src emacs-lisp
  (use-package advance-words-count
    :bind ("M-=" . advance-words-count))
#+end_src
* Emacs Works with Multiple Language, Piece of Cake
Emacs åœ¨è‹±æ–‡çš„å­¦ä¹ ã€ä½¿ç”¨æ–¹é¢å…·æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚

ä½¿ç”¨ Emacs å†™æ–‡æ¡£å¯ä»¥è‡ªåŠ¨æ£€æŸ¥æ‹¼å†™ï¼Œéœ€è¦ç”¨åˆ°çš„æœ‰ ~ispell~, ~flyspell~ æˆ–è€… ~wucuo-mode~. å¯¹äºå…·æœ‰é”™è¯¯çš„å•è¯ä¼šæœ‰ä¸‹åˆ’çº¿æç¤ºï¼Œä½¿ç”¨ ~flyspell-correct~ è¿›è¡Œä¿®æ­£ã€‚

å¯¹äºä¸è®¤è¯†çš„å•è¯å¯ä»¥ä½¿ç”¨ ~sdcv~ æˆ–è€… ~osx-dictionary~ æŸ¥è¯¢ï¼Œå¯¹äºè¯»ä¸æ‡‚çš„å•è¯å¯ä»¥ä½¿ç”¨ ~go-translate~ æˆ–è€… ~lingva~ æˆ–è€… ~google-translate~ è¿›è¡Œä¸­è‹±æ–‡çš„äº’è¯‘ã€‚å½“ç„¶å…¶ä»–çš„è¯­è¨€ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

æ­¤å¤–è¿˜å¯ä»¥ä½¿ç”¨ dictionary-overlay ç›´æ¥æ¸²æŸ“æ•´ä¸ª buffer, ä¸è®¤è¯†çš„å•è¯ä¼šç›´æ¥æ˜¾ç¤ºä¸­æ–‡æ„æ€ã€‚è¿™ä¸ªåŠŸèƒ½ç»“åˆ ~eww~ æˆ–è€… ~elfeed~ é˜…è¯»ç½‘é¡µçš„æ—¶å€™ä½¿ç”¨ã€‚

å½“ä¸çŸ¥é“è‹±æ–‡å•è¯æ€ä¹ˆå†™æ—¶å¯ä»¥ä½¿ç”¨ ~lsp-bridge-toggle-sdcv-helper~, é€šè¿‡è¾“å…¥æ‹¼éŸ³æ¥è¾“å…¥è‹±è¯­å•è¯ã€‚å¯¹äºæƒ³è¦æŸ¥è¯¢è¿‘æ„è¯ç­‰æ—¶å¯ä»¥ä½¿ç”¨ ~powerthesaurus-lookup-dwim~ æ¥æŸ¥æ‰¾ã€‚

å­¦ä¹ è‹±è¯­å•è¯è¿˜å¯ä»¥ç»“åˆ [[https://gitlab.com/phillord/org-drill][org-drll]] æˆ–è€… [[https://github.com/eyeinsky/org-anki][org-anki]] è¿›è¡Œï¼Œè¿™é‡Œä½¿ç”¨åˆ°çš„æ¦‚å¿µæ˜¯ [[https://en.wikipedia.org/wiki/Forgetting_curve][Forgetting curve]].

** Ispell
#+begin_src emacs-lisp
  (use-package ispell
    :config
    (setq ispell-program-name "/opt/homebrew/bin/aspell")
    (setq ispell-extra-args '("--sug-mode=ultra" "--lang=en_US" "--run-together"))
    (setq ispell-aspell-dict-dir
          (ispell-get-aspell-config-value "dict-dir"))

    (setq ispell-aspell-data-dir
          (ispell-get-aspell-config-value "data-dir"))

    (setq ispell-personal-dictionary (expand-file-name "config/ispell/.aspell.en.pws" my-galaxy))

    (setq-default ispell-following-word t
                  ispell-quietly t))
#+end_src

è¿™é‡Œä½¿ç”¨äº†[[https://github.com/cask/shut-up][cask/shut-up: Emacs, shut up would you!]] æ¥å…³é—­ä¸€äº›é”™è¯¯æç¤ºã€‚è™½ç„¶å…¶åªæ˜¯æ˜¾ç¤ºåœ¨ Message buffer å½“ä¸­ï¼Œä½†æ˜¯çœ‹èµ·æ¥è¿˜æ˜¯å¾ˆä¸çˆ½ã€‚
#+begin_src emacs-lisp
  ;; Suppress start looking process.
  ;; https://github.com/company-mode/company-mode/issues/912
  ;; shut-up
  (with-eval-after-load 'ispell
    (advice-add 'ispell-lookup-words :around
                (lambda (orig &rest args)
                  (shut-up (apply orig args)))))
#+end_src

** flyspell
Wucuo åœ¨æŸä¸ªç‰ˆæœ¬æœ‰æç¤º warning, ä¸çŸ¥é“äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆã€‚
#+begin_src emacs-lisp
  (use-package flyspell
    :hook (org-mode . flyspell-mode))
#+end_src

** COMMENT wucuo
Wucuo çš„æ€§èƒ½æ¯” flyspell å¥½ï¼Œå…¶é»˜è®¤æ£€æŸ¥å¯è§åŒºåŸŸï¼Œè€Œ flyspell æ˜¯æ£€æŸ¥æ•´ä¸ª buffer, è¿™å¯¼è‡´åœ¨æ¯”è¾ƒå¤§çš„æ–‡æ¡£ä¸­ä¼šäº§ç”Ÿè¾ƒä¸¥é‡çš„å¡é¡¿ï¼Œæ€§èƒ½ä¸è¡Œã€‚

#+begin_src emacs-lisp
  (add-hook 'org-mode-hook #'wucuo-start)
#+end_src
** flyspell-correct
#+begin_src emacs-lisp
  (use-package flyspell-correct
    :commands flyspell-correct-wrapper
    :bind ([remap flyspell-auto-correct-previous-word] . flyspell-correct-wrapper))
#+end_src
** langtool
MacOS ä¸Šä½¿ç”¨éœ€è¦å®‰è£… languagetool.
#+begin_src emacs-lisp
  (use-package langtool
    :commands langtool-check-buffer
    :config
    (setq langtool-http-server-host "localhost")
    (setq langtool-http-server-port 8081)
    (setq langtool-autoshow-message-function #'langtool-popup-autoshow))
#+end_src

** dictionary
Emacs å†…ç½®äº† dictionaryï¼Œé»˜è®¤æ˜¯æŸ¥è¯¢çš„ dict.orgã€‚
#+begin_src emacs-lisp
  (add-to-list 'display-buffer-alist
               '("^\\*Dictionary\\*"
                 (display-buffer-in-side-window)
                 (side . right)
                 (window-width . 70)))

  (global-set-key (kbd "M-#") 'dictionary-lookup-definition)
#+end_src
** go-translate
#+begin_src emacs-lisp
  (use-package go-translate
    :commands gts-do-translate
    :config
    (setq gts-buffer-follow-p t)
    (setq gts-translate-list '(("en" "zh")))
    (setq gts-default-translator (gts-translator
                                  :picker (gts-noprompt-picker)
                                  :engines (list
                                            (gts-google-engine :parser (gts-google-summary-parser)))
                                  :render (gts-buffer-render))))
  (my/space-leader-def
   "l" '(:ignore t :wk "Language")
   "ll" '(gts-do-translate :wk "Translate"))
#+end_src
** lingva
go-translate çš„å¤‡ç”¨ã€‚
#+begin_src emacs-lisp
  (use-package lingva
    :commands lingva-translate
    :config
    (setq lingva-target "zh"))

  (my/space-leader-def
    "lL" '(lingva-translate :wk "Lingva"))
#+end_src

** sdcv
æ­¤ sdcv æ¥è‡ª [[https://github.com/manateelazycat/sdcv/tree/master/][manateelazycat/sdcv: Emacs interface for sdcv (Stardict console version)]] è€Œä¸æ˜¯ Melpa ä¸Šçš„ã€‚

å…³äº sdcv çš„è¯å…¸å¯ä»¥å»è¿™ä¸‹è½½ï¼š[[http://download.huzheng.org/dict.org/][dictd-www.dict.org Dictionaries]]

é»˜è®¤çš„é¢œè‰²ä¸å–œæ¬¢å¯ä»¥é€šè¿‡ ~face-spec-set~ å‡½æ•°è¿›è¡Œè®¾ç½®ã€‚
#+begin_src emacs-lisp
  (use-package sdcv
    :commands sdcv-search-pointer sdcv-search-input+
    :config
    (face-spec-set 'sdcv-tooltip-face
                   '((((background light))
                      :foreground "#000000" :background "#ffffff")
                     (t
                      :foreground "#ffffff" :background "#000000"))
                   'face-override-spec)

    (setq sdcv-tooltip-border-width 2)
    (setq sdcv-dictionary-data-dir (expand-file-name "sdcv-dict" user-emacs-directory))
    (setq sdcv-program "/opt/homebrew/bin/sdcv")
    (setq sdcv-dictionary-simple-list    ;æ˜Ÿé™…è¯‘ç‹å±å¹•å–è¯è¯å…¸, ç®€å•, å¿«é€Ÿ
          '("æ‡’è™«ç®€æ˜è‹±æ±‰è¯å…¸"
            "æ‡’è™«ç®€æ˜æ±‰è‹±è¯å…¸"
            "KDic11ä¸‡è‹±æ±‰è¯å…¸"))
    (setq sdcv-dictionary-complete-list     ;æ˜Ÿé™…è¯‘ç‹çš„è¯å…¸, å®Œå…¨, è¯¦ç»†
          '("ç‰›æ´¥è‹±æ±‰åŒè§£ç¾åŒ–ç‰ˆ"
            "æ‡’è™«ç®€æ˜è‹±æ±‰è¯å…¸"
            "è‹±æ±‰æ±‰è‹±ä¸“ä¸šè¯å…¸"
            "XDICTè‹±æ±‰è¾å…¸"
            "stardict1.3è‹±æ±‰è¾å…¸"
            "WordNet"
            "XDICTæ±‰è‹±è¾å…¸"
            "Jargon"
            "æ‡’è™«ç®€æ˜æ±‰è‹±è¯å…¸"
            "FOLDOC"
            "æ–°ä¸–çºªè‹±æ±‰ç§‘æŠ€å¤§è¯å…¸"
            "KDic11ä¸‡è‹±æ±‰è¯å…¸"
            "æœ—é“æ±‰è‹±å­—å…¸5.0"
            "CDICT5è‹±æ±‰è¾å…¸"
            "æ–°ä¸–çºªæ±‰è‹±ç§‘æŠ€å¤§è¯å…¸"
            "21ä¸–çºªåŒè¯­ç§‘æŠ€è¯å…¸"
            "quick_eng-zh_CN")))

  (my/space-leader-def
    "lp" '(sdcv-search-pointer :wk "SDCV Point")
    "li" '(sdcv-search-input+ :wk "SDCV Input"))

  (with-eval-after-load 'evil-collection
    (evil-collection-define-key 'normal 'sdcv-mode-map
      "q" 'quit-window))
#+end_src

** osx-dictionary
[[https://github.com/xuchunyang/osx-dictionary.el][xuchunyang/osx-dictionary.el: Mac OS X Dictionary.app interface for Emacs]]

è¿™ä¸ªæ˜¯ä½¿ç”¨ MacOS ä¸Šè‡ªå¸¦çš„ dictionary è¿›è¡Œå•è¯çš„æŸ¥è¯¢ï¼Œéœ€è¦è®© dictionary åå°è¿è¡Œï¼Œå¦åˆ™æ— ç»“æœæ˜¾ç¤ºã€‚

#+begin_src emacs-lisp
  (use-package osx-dictionary
    :commands osx-dictionary-search-pointer)

  (my/space-leader-def
    "ld" '(osx-dictionary-search-pointer :wk "OSX dictionary"))
#+end_src
** powerthesaurus
è¿™ä¸ªçš„å¥½å¤„æ˜¯å¯ä»¥ç”¨äºæŸ¥è¯¢åŒä¹‰è¯ã€åä¹‰è¯ç­‰ç­‰ï¼Œç”¨äºæ›¿æ¢å•è¯æ¯”è¾ƒæ–¹ä¾¿ã€‚

éœ€è¦å®æ—¶åœ¨çº¿æŸ¥è¯¢ï¼Œæœ‰æ—¶å€™ç»“æœè¿”å›çš„è¾ƒæ…¢ã€‚
#+begin_src emacs-lisp
  (use-package powerthesaurus
    :commands (powerthesaurus-lookup-dwim
               powerthesaurus-lookup-related-dwim
               powerthesaurus-lookup-synonyms-dwim
               powerthesaurus-lookup-antonyms-dwim
               powerthesaurus-lookup-definitions-dwim
               powerthesaurus-lookup-sentences-dwim))

  (my/space-leader-def
    "ls" '(:ignore t :wk "synosaurus")
    "lsl" '(powerthesaurus-lookup-dwim :wk "Dwim")
    "lsr" '(powerthesaurus-lookup-related-dwim :wk "Related")
    "lss" '(powerthesaurus-lookup-synonyms-dwim :wk "Synonyms")
    "lsa" '(powerthesaurus-lookup-antonyms-dwim :wk "Antonyms")
    "lsd" '(powerthesaurus-lookup-definitions-dwim :wk "Definitions")
    "lsj" '(powerthesaurus-lookup-sentences-dwim :wk "Sentences"))
#+end_src
** COMMENT dictionary-overlay
[[https://github.com/ginqi7/websocket-bridge][websocket-bridge]] and [[https://github.com/ginqi7/dictionary-overlay][dictionary-overlay]] can be used to learn English words.

æˆ‘çš„æ—¥å¸¸ä½¿ç”¨æµç¨‹æ˜¯ä½¿ç”¨ ~SPC b r~ æ¥æ¸²æŸ“ buffer, ä½¿ç”¨ ~SPC l k~ æ ‡è®°ä¸è®¤è¯†çš„å•è¯ï¼Œä½¿ç”¨ ~SPC l K~ å°†å•è¯æ ‡è®°ä¸ºå·±çŸ¥ã€‚

è‹¥é€šè¿‡å•è¯æŸ¥è¯¢çš„å•è¯ä¹Ÿè‡ªåŠ¨æ ‡è®°ä¸ºæœªçŸ¥ï¼Œä¸‹æ¬¡æ¸²æŸ“ buffer æ—¶å°±ä¼šè‡ªåŠ¨æ ‡å‡ºå…¶è¯æ„ã€‚

è¿™ä¸ªåŠŸèƒ½åœ¨é˜…è¯» [[RSS]] çš„æ—¶å€™ååˆ†çš„æ–¹ä¾¿ã€‚
#+begin_src emacs-lisp
  (use-package dictonary-overlay
    :load-path "~/.emacs.d/packages/dictionary-overlay/"
    :commands (dictionary-overlay-mark-word-unknown
               dictionary-overlay-mark-word-known
               dictionary-overlay-toggle)
    :config
    (setq dictionary-overlay-translators '("local" "darwin" "sdcv" "web"))
    (setq dictionary-overlay-user-data-directory
          (expand-file-name "var/dictionary-overlay" user-emacs-directory)))

  ;; (add-to-list 'load-path "~/.emacs.d/lib/dictionary-overlay/")
  ;; (add-to-list 'load-path "~/.emacs.d/lib/websocket-bridge")
  ;; (run-with-idle-timer 2 nil (lambda ()
  ;;                                  (require 'websocket-bridge)
  ;;                                  (require 'dictionary-overlay)
  ;;                                  (dictionary-overlay-start)))

  ;; (with-eval-after-load 'dictionary-overlay
  ;;   (setq dictionary-overlay-translators '("local" "darwin" "sdcv" "web"))
  ;;   (setq dictionary-overlay-user-data-directory (expand-file-name "var/dictionary-overlay" user-emacs-directory))
  ;;   (with-eval-after-load 'osx-dictionary
  ;;     (advice-add 'osx-dictionary-search-pointer :after 'dictionary-overlay-mark-word-unknown))
  ;;   (with-eval-after-load 'sdcv
  ;;     (advice-add 'sdcv-search-input+ :after 'dictionary-overlay-mark-word-unknown)
  ;;     (advice-add 'sdcv-search-pointer :after 'dictionary-overlay-mark-word-unknown)))

  (my/space-leader-def
    "lk" '(dictionary-overlay-mark-word-unknown :wk "Mark word unknown")
    "lK" '(dictionary-overlay-mark-word-known :wk "Mark word known")
    "br" '(dictionary-overlay-toggle :wk "Toggle Render buffer"))
#+end_src

** flycheck
#+begin_src emacs-lisp
  (use-package flycheck
    :hook (prog-mode . flycheck-mode))
#+end_src
** flycheck-grammarly
langtool ä¹Ÿå¯ä»¥æ£€æŸ¥è¯­æ³•ï¼Œç›¸æ¯”è¾ƒ grammarlyï¼Œä¸éœ€è¦è¿ç½‘ï¼Œæ‰€ä»¥é€Ÿåº¦è¾ƒå¿«ã€‚
è‡ªåŠ¨å¼€å¯æ­¤åŠŸèƒ½å¯¼è‡´åœ¨æ–‡æ¡£è¾ƒå¤§æ—¶æœ‰æ˜æ˜¾çš„å¡é¡¿æ„Ÿï¼Œæ‰‹åŠ¨å¼€å¯è¯­æ³•æ£€æŸ¥è¾ƒå¥½ã€‚
#+begin_src emacs-lisp
  (use-package flycheck-grammarly
    :after flycheck
    :commands flycheck-grammarly-setup)
#+end_src

** shortcut
åœ¨ MacOS å¯ä»¥è°ƒç”¨ shortcut ä½¿ç”¨ç³»ç»Ÿç¿»è¯‘åŠŸèƒ½ã€‚

æ­¤å¤„ä»…åšè®°å½•ï¼Œæˆ‘ä¸æ€ä¹ˆä½¿ç”¨ã€‚å…·ä½“çš„è§ [[https://emacs-china.org/t/emacs-macos/23268][Emacs+macOS æœ€ç®€å•ä¹Ÿæœ€å¼ºå¤§çš„ä¸­è‹±äº’è¯‘è®¾ç½®ï¼Œä¸åªè‹±è¯­ - Emacs-general - Emacs China]].
#+begin_src emacs-lisp
  (add-to-list 'display-buffer-alist
               (cons
                "\\*Async Shell Command\\*.*"
                (cons #'display-buffer-no-window nil)))

  (defun my/siri-translate ()
    (interactive)
    (let ((tempfile (make-temp-file "siri-translate-" nil ".txt")))
      (write-region
       (format "%s" (thing-at-point 'paragraph)) nil tempfile)
      (end-of-paragraph-text)
      (shell-command (format "shortcuts run \"Translate File\" -i %s &" tempfile)))
    (shell-command "open -b org.gnu.Emacs"))

  (defun my/siri-translate2english ()
    (interactive)
    (let ((tempfile (make-temp-file "siri-translate-" nil ".txt")))
      (write-region
       (format "%s" (thing-at-point 'paragraph)) nil tempfile)
      (end-of-paragraph-text)
      (shell-command (format "shortcuts run \"Translate File 2 English\" -i %s &" tempfile)))
    (shell-command "open -b org.gnu.Emacs"))

  (defun language-to-zh-or-zh-to-english ()
    (interactive)
    (let ((string (thing-at-point 'paragraph)))
      (if (eq (string-match "\\cC" string) nil)
          (my/siri-translate)
        (my/siri-translate2english))))
#+end_src

** LSP

*** eglot
#+begin_src emacs-lisp
  (with-eval-after-load 'yasnippet
    (add-hook 'LaTeX-mode-hook 'eglot-ensure))
#+end_src
*** COMMENT lsp-bridge
#+begin_src emacs-lisp
  ;; lsp-bridge-toggle-sdcv-helper use pinyin to search english words,
  ;; need to deactivate rime input method before search words.
  (autoload 'lsp-bridge-toggle-sdcv-helper "lsp-bridge" "" t)
  (defun my/deactivate-input-method-sdcv-helper ()
    "Deactivate input method when sdcv helper enabled."
    (if acm-enable-search-sdcv-words
        (deactivate-input-method)))

  (advice-add 'lsp-bridge-toggle-sdcv-helper :after 'my/deactivate-input-method-sdcv-helper)

  ;; Disable sdcv helper after exit insert state if acm-enable-search-sdcv-words is true.
  (with-eval-after-load 'lsp-bridge
    (add-hook 'evil-insert-state-exit-hook (lambda ()
                                             (if acm-enable-search-sdcv-words
                                                 (lsp-bridge-toggle-sdcv-helper)))))
#+end_src
#+begin_src emacs-lisp
  (my/space-leader-def
    "lh" '(lsp-bridge-toggle-sdcv-helper :wk "Sdcv help"))
#+end_src
** markdown
#+begin_src emacs-lisp
  (use-package markdown-mode
    :mode (("\\.\\(?:md\\|markdown\\|mkd\\|mdown\\|mkdn\\|mdwn\\)\\'" . markdown-mode)
           ("README\\.md\\'" . gfm-mode))
    :init (setq markdown-command "multimarkdown")
    :bind (:map markdown-mode-map
           ("C-c C-e" . markdown-do)))

  ;; (with-eval-after-load 'whitespace-cleanup-mode
  ;;   (add-to-list 'whitespace-cleanup-mode-ignore-modes 'markdown-mode))
#+end_src

** COMMENT Python
#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("poetry\\.lock\\'" . toml-mode))
#+end_src

* Organize Life with Plain Text, High Effective System
** org-mode
#+begin_src emacs-lisp
  (use-package org
    :config
    (setq org-ellipsis " â‡²")
    (setq org-modules '()
          org-imenu-depth 4
          org-return-follows-link t
          org-image-actual-width nil
          org-display-remote-inline-images 'download
          org-log-into-drawer t
          org-fast-tag-selection-single-key 'expert
          org-adapt-indentation nil
          org-fontify-quote-and-verse-blocks t
          org-support-shift-select t
          org-treat-S-cursor-todo-selection-as-state-change nil
          org-hide-leading-stars nil
          org-startup-with-inline-images t
          org-image-actual-width '(500)
          org-use-speed-commands t)
    (setq org-enforce-todo-dependencies t)
    (setq org-enforce-todo-checkbox-dependencies t)

    (setq org-todo-repeat-to-state t)
    (setq org-todo-keywords
          '((sequence "TODO(t)" "NEXT(n)" "INPROGRESS(i)" "|" "WAIT(w@)" "SOMEDAY(s@)" "CNCL(c@/!)" "DONE(d)")))
    (setq org-todo-state-tags-triggers
          (quote (("CNCL" ("CNCL" . t))
                  ("WAIT" ("WAIT" . t))
                  ("SOMEDAY" ("WAIT") ("SOMEDAY" . t))
                  (done ("WAIT") ("SOMEDAY"))
                  ("TODO" ("WAIT") ("CNCL") ("SOMEDAY"))
                  ("NEXT" ("WAIT") ("CNCL") ("SOMEDAY"))
                  ("DONE" ("WAIT") ("CNCL") ("SOMEDAY")))))
    :bind (:map org-mode-map
                ("C-c l" . org-store-link)))
                ;; ("<return>" . org-return)))
#+end_src
*** Babel
ä»¥ä¸‹é…ç½®æ¥æºï¼šhttps://emacs-china.org/t/org-babel/18699

ç¦ç”¨ org babel åŠ è½½çš„è¯­è¨€å¯ä»¥æœ‰æ•ˆçš„æé«˜ Emacs çš„å¯åŠ¨é€Ÿåº¦ã€‚
#+begin_example
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)))
#+end_example
#+begin_src emacs-lisp
  (use-package ob-core
    :after org
    :config
    (defun my/org-babel-execute-src-block (&optional _arg info _params)
      "Load language if needed"
      (let* ((lang (nth 0 info))
             (sym (if (member (downcase lang) '("c" "cpp" "c++")) 'C (intern lang)))
             (backup-languages org-babel-load-languages))
        (unless (assoc sym backup-languages)
          (condition-case err
              (progn
                (org-babel-do-load-languages 'org-babel-load-languages (list (cons sym t)))
                (setq-default org-babel-load-languages (append (list (cons sym t)) backup-languages)))
            (file-missing
             (setq-default org-babel-load-languages backup-languages)
             err)))))
    (advice-add 'org-babel-execute-src-block :before 'my/org-babel-execute-src-block)
    (setq org-confirm-babel-evaluate nil))
#+end_src

*** org-capture
#+begin_src emacs-lisp
  (use-package org-capture
    :after org
    :bind (:map org-capture-mode-map
                ([remap evil-save-and-close] . org-capture-finalize)
                ([remap evil-save-modified-and-close] . org-capture-finalize)
                ([remap evil-quit] . org-capture-kill)
                ("RET" . org-capture-finalize))
    :config
    (setq org-capture-templates
          '(("i" "Inbox"
             plain (file+olp+datetree (lambda () (concat my-galaxy "/inbox/inbox.org")))
             "**** %?\n%U\n" :time-prompt t :tree-type week)
            ("p" "Daily Plan"
             plain (file+olp+datetree (lambda () (concat my-galaxy "/inbox/plan.org")))
             "- [ ] %?\n%U\n" :time-prompt t :tree-type week)
            ("r" "Reflection"
             plain
             (file+olp+datetree (lambda () (concat my-galaxy "/roam/main/reflection.org")))
             (file "~/.emacs.d/template/tpl-daily-reflection")
             :time-prompt t :tree-type week)
            ("a" "Anki Deck")
            ("ae" "Deck: English"
             entry (file (lambda ()
                           (concat my-galaxy "/anki/anki_english.org")))
             "* %?\n" :jump-to-captured t)
            ("ac" "Deck: Civil Engineering"
             entry (file (lambda ()
                           (concat my-galaxy "/anki/anki_engineering.org")))
             "* %?\n" :jump-to-captured t)
            ("s" "Code snippets"
             entry (file (lambda ()
                           (concat my-galaxy "/scripts/snippets.org")))
             "* %?\t%^g\n#+BEGIN_SRC %^{language}\n\n#+END_SRC")
            ;; ("l" "Lists")
            ("m" "Movie"
             entry (file+headline (lambda () (concat my-galaxy "/roam/main/watchlist.org")) "Watching Lists")
             "* %?
  :PROPERTIES:
  :GENRE: %^{Film genre|Action|Adventure|Comedy|Drama|Fantasy|Horror|Musicals|Mystery|Romance|Science fiction|Sports|Thriller}
  :COUNTRY:
  :SCORE:
  :PLOT: %^{PLOT}
  :END:"))))
#+end_src

ç”±äºä½¿ç”¨äº† org-roam çš„è‡ªåŠ¨å¼¹å‡ºåŠŸèƒ½ï¼Œå¯¼è‡´ org-capture çš„æ—¶å€™å…‰æ ‡æœªèƒ½æ­£å¸¸çš„è·³è½¬åˆ° org-capture çš„çª—å£å½“ä¸­ï¼Œä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ¥è§„é¿è¿™ä¸ªé—®é¢˜ã€‚
#+begin_src emacs-lisp
  (defun my/org-capture ()
    "Make a new frame to do org-capture staff."
    (interactive)
    (make-frame)
    (org-capture))

  (add-hook 'org-capture-after-finalize-hook 'delete-frame)

  (add-to-list 'display-buffer-alist '("\\*Org Select\\*"
                                       (display-buffer-pop-up-frame)
                                       (window-parameters
                                        (no-other-window . t)
                                        (mode-line-format . none)
                                        (no-delete-other-windows . t))))

  (global-set-key (kbd "<f10>") 'my/org-capture)
#+end_src

*** org-archive
#+begin_src emacs-lisp
  (use-package org-archive
    :after org
    :init
    (setq org-archive-location (expand-file-name "todos/gtd_archive.org::datetree/" my-galaxy))

    (defun my/gtd-archive ()
      "Archive tasks to specific file."
      (interactive)
      (find-file (expand-file-name "todos/gtd_archive.org" my-galaxy)))
    (my/space-leader-def
      "foa" '(my/gtd-archive :wk "Archive File")))
#+end_src

*** org-attach
POSTï¼š[[https://fuco1.github.io/2023-02-08-Visit-the-org-headline-from-the-attach-dired-buffer.html][Visit the org headline from the attach dired buffer]]
é€šå¸¸ä¸éœ€è¦ç®¡ç†é™„ä»¶åœ¨æ–‡ä»¶å¤¹ä¸­æ˜¯æ€ä¹ˆå­˜æ”¾çš„ï¼Œæ‰¾åˆ° heading å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„é™„ä»¶ã€‚
æˆ–è€…å½“åœ¨ =dired= ä¸­æŸ¥çœ‹ =attach= æ–‡ä»¶å¤¹ä¸­çš„é™„ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ ~my/org-attach-visit-heading-from-dired~ å‡½æ•°è·³è½¬åˆ°å¯¹åº”çš„ heading ä½ç½®ã€‚
#+begin_src emacs-lisp
  (use-package org-attach
    :config
    (setq org-attach-id-dir (expand-file-name "attach" my-galaxy))
    (defun my/org-attach-visit-headline-from-dired ()
      "Go to the headline corresponding to this org-attach directory."
      (interactive)
      (let* ((id-parts (last (split-string default-directory "/" t) 2))
             (id (apply #'concat id-parts)))
        (let ((m (org-id-find id 'marker)))
          (unless m (user-error "Cannot find entry with ID \"%s\"" id))
          (pop-to-buffer (marker-buffer m))
          (goto-char m)
          (move-marker m nil)
          (org-fold-show-context))))
    (add-to-list 'display-buffer-alist
                 '("\\*Org Attach\\*"
                   (display-buffer-pop-up-frame)
                   (side . right)
                   (slot . 0)
                   (window-width . 0.5)
                   (window-parameters . ((no-other-window . t)
                                         (no-delete-other-windows . t)))))
    :bind (:map dired-mode-map
                ("C-'" . my/org-attach-visit-headline-from-dired)))
#+end_src
#+begin_src emacs-lisp :tangle no
  (defun my/copy-or-move-file-to-buffer-dir
      (file-name &optional arg)
    "Copy or move the FILE-NAME to the directory of the buffer's file.\n
  With prefix argument ARG, copy the file instead of moving it."
    (interactive "FFile to move: \nP")
    (let ((new-file-name (concat (file-name-directory (buffer-file-name))
                                 (file-name-nondirectory file-name))))
      (if (not (file-exists-p file-name))
          (error "File does not exist: %s" file-name)
        (if (file-exists-p new-file-name)
            (error "File already exists: %s" new-file-name)
          (progn
            (let ((command (if arg 'copy-file 'rename-file )))
              (funcall command file-name new-file-name t))
            (if arg
                (find-file-noselect new-file-name)
              (progn
                  (kill-buffer (current-buffer))
                  (delete-file file-name)))
            (message "File %s to %s"
                     (if arg "moved" "copied")
                     new-file-name))))))
#+end_src

*** org-habit
#+begin_src emacs-lisp
  (use-package org-habit
    :after org-agenda
    :config
    (add-to-list 'org-modules 'org-habit t))
#+end_src

*** org-id
#+begin_src emacs-lisp
  (use-package org-id
    :after org
    :config
    (setq org-id-method 'ts)
    (setq org-id-link-to-org-use-id 'create-if-interactive)
    (defun my/copy-idlink ()
      "Copy idlink to clipboard."
      (interactive)
      (when (eq major-mode 'org-agenda-mode) ;switch to orgmode
        (org-agenda-show)
        (org-agenda-goto))
      (when (eq major-mode 'org-mode) ; do this only in org-mode buffers
        (let* ((mytmphead (nth 4 (org-heading-components)))
               (mytmpid (funcall 'org-id-get-create))
               (mytmplink (format "- [ ] [[id:%s][%s]]" mytmpid mytmphead)))
          (kill-new mytmplink)
          (message "Copied %s to killring (clipboard)" mytmplink))))
    :bind ("<f7>" . my/copy-idlink))

  (my/space-leader-def
    "oi" '(org-id-get-create :wk "Create ID"))
#+end_src

*** org-src
#+begin_src emacs-lisp
  (use-package org-src
    :after org
    :config
    (setq org-src-window-setup 'current-window)
    (setq org-src-ask-before-returning-to-edit-buffer nil))
#+end_src
*** org-refile
#+begin_src emacs-lisp
  (use-package org-refile
    :after org
    :config
    (setq org-refile-targets '((nil :maxlevel . 9)
                               (org-agenda-files :maxlevel . 9)))
    (setq org-refile-use-outline-path t)
    (setq org-outline-path-complete-in-steps nil)
    (setq org-refile-allow-creating-parent-nodes 'confirm)
    (setq org-refile-use-outline-path 'file)
    (setq org-refile-active-region-within-subtree t))
#+end_src

*** org-emphasis-alist
æ­¤å¤„çš„è®¾ç½®æ¥æºï¼šhttps://protesilaos.com/emacs/modus-themes

è‹¥å‡çº§ modus-themes åˆ° 4.0 çš„ç‰ˆæœ¬ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹ã€‚
#+begin_src emacs-lisp
  (use-package org
    :config
    (defface my-org-emphasis-bold
      '((default :inherit bold)
        (((class color) (min-colors 88) (background light))
         :foreground "#a60000")
        (((class color) (min-colors 88) (background dark))
         :foreground "#ff8059"))
      "My bold emphasis for Org.")

    (defface my-org-emphasis-italic
      '((default :inherit italic)
        (((class color) (min-colors 88) (background light))
         :foreground "#005e00")
        (((class color) (min-colors 88) (background dark))
         :foreground "#44bc44"))
      "My italic emphasis for Org.")

    (defface my-org-emphasis-underline
      '((default :inherit underline)
        (((class color) (min-colors 88) (background light))
         :foreground "#813e00")
        (((class color) (min-colors 88) (background dark))
         :foreground "#d0bc00"))
      "My underline emphasis for Org.")

    (defface my-org-emphasis-strike-through
      '((default :strike-through t)
        (((class color) (min-colors 88) (background light))
         :foreground "#505050")
        (((class color) (min-colors 88) (background dark))
         :foreground "#a8a8a8"))
      "My strike-through emphasis for Org.")

    (defface my-org-emphasis-strike-through
      '((((class color) (min-colors 88) (background light))
         :strike-through "#972500" :foreground "#505050")
        (((class color) (min-colors 88) (background dark))
         :strike-through "#ef8b50" :foreground "#a8a8a8"))
      "My strike-through emphasis for Org.")

    (setq org-emphasis-alist
          '(("*" my-org-emphasis-bold)
            ("/" my-org-emphasis-italic)
            ("_" my-org-emphasis-underline)
            ("=" org-verbatim verbatim)
            ("~" org-code verbatim)
            ("+" my-org-emphasis-strike-through))))
#+end_src

*** org-clock
#+begin_src emacs-lisp
  (use-package org-clock
    :after org
    :config
    (org-clock-persistence-insinuate)
    (setq org-clock-history-length 23)
    (setq org-clock-in-resume t)
    (setq org-clock-into-drawer "LOGCLOCK")
    (setq org-clock-out-remove-zero-time-clocks t)
    (setq org-clock-out-when-done t)
    (setq org-clock-persist t)
    (setq org-clock-clocktable-default-properties '(:maxlevel 5 :link t :tags t))
    (setq org-clock-persist-query-resume nil)
    (setq org-clock-report-include-clocking-task t))

  (my/space-leader-def
    "oc" '(:ignore t :wk "Clock")
    "ocj" '(org-clock-goto :wk "Clock goto")
    "oci" '(org-clock-in :wk "Clock In")
    "oco" '(org-clock-out :wk "Clock Out")
    "ocl" '(org-clock-in-last :wk "Clock In Last"))
#+end_src

Punch in or out.
#+begin_src emacs-lisp
  (setq bh/keep-clock-running nil)

  (defun bh/is-task-p ()
    "Any task with a todo keyword and no subtask."
    (save-restriction
      (widen)
      (let ((has-subtask)
            (subtree-end (save-excursion (org-end-of-subtree t)))
            (is-a-task (member (nth 2 (org-heading-components)) org-todo-keywords-1)))
        (save-excursion
          (forward-line 1)
          (while (and (not has-subtask)
                      (< (point) subtree-end)
                      (re-search-forward "^\*+ " subtree-end t))
            (when (member (org-get-todo-state) org-todo-keywords-1)
              (setq has-subtask t))))
        (and is-a-task (not has-subtask)))))
  (defun bh/is-project-p ()
    "Any task with a todo keyword subtask."
    (save-restriction
      (widen)
      (let ((has-subtask)
            (subtree-end (save-excursion (org-end-of-subtree t)))
            (is-a-task (member (nth 2 (org-heading-components)) org-todo-keywords-1)))
        (save-excursion
          (forward-line 1)
          (while (and (not has-subtask)
                      (< (point) subtree-end)
                      (re-search-forward "^\*+ " subtree-end t))
            (when (member (org-get-todo-state) org-todo-keywords-1)
              (setq has-subtask t))))
        (and is-a-task has-subtask))))
  (defun bh/find-project-task ()
    "Move point to the parent (project) task if any."
    (save-restriction
      (widen)
      (let ((parent-task (save-excursion (org-back-to-heading 'invisible-ok) (point))))
        (while (org-up-heading-safe)
          (when (member (nth 2 (org-heading-components)) org-todo-keywords-1)
            (setq parent-task (point))))
        (goto-char parent-task)
        parent-task)))
  (defun bh/is-project-subtree-p ()
    "Any task with a todo keyword that is in a project subtree.
   Callers of this function already widen the buffer view."
    (let ((task (save-excursion (org-back-to-heading 'invisible-ok)
                                (point))))
      (save-excursion
        (bh/find-project-task)
        (if (equal (point) task)
            nil
          t))))
  (defun bh/clock-in-to-next (kw) ;; kw should not been deleted.
    "Switch a task from TODO to NEXT when clocking in.
   Skips capture tasks, projects, and subprojects.
   Switch projects and subprojects from NEXT back to TODO"
    (when (not (and (boundp 'org-capture-mode) org-capture-mode))
      (cond
       ((and (member (org-get-todo-state) (list "TODO"))
             (bh/is-task-p))
        "NEXT")
       ((and (member (org-get-todo-state) (list "NEXT"))
             (bh/is-project-p))
        "TODO"))))
  (defun bh/punch-in (arg)
    "Start continuous clocking and set the default task to the selected task.
   If `ARG' is nil, set the Organization task
   as the default task."
    (interactive "p")
    (setq bh/keep-clock-running t)
    (if (equal major-mode 'org-agenda-mode)
        ;;
        ;; We're in the agenda
        ;;
        (let* ((marker (org-get-at-bol 'org-hd-marker))
               (tags (org-with-point-at marker (org-get-tags))))
          (if (and (eq arg 4) tags)
              (org-agenda-clock-in '(16))
            (bh/clock-in-default-task-as-default)))
      ;;
      ;; We are not in the agenda
      ;;
      (save-restriction
        (widen)
                                          ; Find the tags on the current task
        (if (and (equal major-mode 'org-mode) (not (org-before-first-heading-p)) (eq arg 4))
            (org-clock-in '(16))
          (bh/clock-in-default-task-as-default)))))
  (defun bh/punch-out ()
    "Punch out."
    (interactive)
    (setq bh/keep-clock-running nil)
    (when (org-clock-is-active)
      (org-clock-out))
    (org-agenda-remove-restriction-lock))
  (defun bh/clock-in-default-task ()
    "Clock In default task with specific ID."
    (save-excursion
      (org-with-point-at org-clock-default-task
        (org-clock-in))))
  (defun bh/clock-in-parent-task ()
    "Move point to the parent (project) task if any and clock in."
    (let ((parent-task))
      (save-excursion
        (save-restriction
          (widen)
          (while (and (not parent-task) (org-up-heading-safe))
            (when (member (nth 2 (org-heading-components)) org-todo-keywords-1)
              (setq parent-task (point))))
          (if parent-task
              (org-with-point-at parent-task
                (org-clock-in))
            (when bh/keep-clock-running
              (bh/clock-in-default-task)))))))
  (defvar bh/default-task-id "20220524T114723.420565")
  (defun bh/clock-in-default-task-as-default ()
    "Clock in default task."
    (interactive)
    (org-with-point-at (org-id-find bh/default-task-id 'marker)
      (org-clock-in '(16))))
  (defun bh/clock-out-maybe ()
    "Clock out."
    (when (and bh/keep-clock-running
               (not org-clock-clocking-in)
               (marker-buffer org-clock-default-task)
               (not org-clock-resolving-clocks-due-to-idleness))
      (bh/clock-in-parent-task)))

  (add-hook 'org-clock-out-hook 'bh/clock-out-maybe 'append)

  (defun bh/clock-in-last-task (arg)
    "Clock in the interrupted task if there is one.
   Skip the default task and get the next one.
   A prefix `ARG' forces clock in of the default task."
    (interactive "p")
    (let ((clock-in-to-task
           (cond
            ((eq arg 4) org-clock-default-task)
            ((and (org-clock-is-active)
                  (equal org-clock-default-task (cadr org-clock-history)))
             (caddr org-clock-history))
            ((org-clock-is-active) (cadr org-clock-history))
            ((equal org-clock-default-task (car org-clock-history)) (cadr org-clock-history))
            (t (car org-clock-history)))))
      (widen)
      (org-with-point-at clock-in-to-task
        (org-clock-in nil))))

  (defun my/toggle-punch-in-or-out ()
    "Start clock or stop it when there is a clocking."
    (interactive)
    (if (org-clocking-p)
        (progn
          (bh/punch-out)
          (alert "Wish you have a good day!" :title "Punch Out"))
      (progn
        (bh/punch-in nil)
        (alert "Start Working: Fighting" :title "Punch In" ))))

  (my/comma-leader-def
    "i" '(my/toggle-punch-in-or-out :wk "Punch In or Out"))
#+end_src

*** org buffer
#+begin_src emacs-lisp
  (add-to-list 'display-buffer-alist
               '("\\*Org Note\\*"
                 (display-buffer-in-side-window)
                 (side . right)
                 (slot . 0)
                 (window-width . 0.5)
                 (window-parameters . ((no-other-window . t)
                                       (no-delete-other-windows . t)))))
#+end_src
*** ol
#+begin_src emacs-lisp
  (use-package ol
    :config
    (setq org-link-frame-setup '((vm . vm-visit-folder-other-frame)
                                 (vm-imap . vm-visit-imap-folder-other-frame)
                                 (gnus . org-gnus-no-new-news)
                                 (file . find-file)
                                 (wl . wl-other-frame))))
#+end_src
*** org-header
**** Auto calc clock tables
è¿™ä¸ªç”¨äº clocktable è¿›è¡Œä»»åŠ¡æ—¶é—´çš„æ±‡æ€»æ¯”è¾ƒï¼Œç›®å‰æˆ‘ç”¨å®ƒæ¥ç»Ÿè®¡ä¸€å¹´çš„è¯»ä¹¦æ—¶é•¿è®¡å½•ï¼ŒåŠä¸€å¹´è¯»äº†å“ªäº›ä¹¦ã€‚
#+begin_src emacs-lisp
  ;; https://200ok.ch/posts/2022-12-07_streamline_your_org_mode_workflow_with_automatic_clock_table_recalculation.html
  ;; Need add #+AUTOCALC_CLOCK_TABLES to org file.
  (with-eval-after-load 'org
    (add-to-list 'org-options-keywords "AUTOCALC_CLOCK_TABLES:"))

  (defun autocalc-clocktable ()
    "Auto update clock table."
    (when (derived-mode-p 'org-mode)
      (save-excursion
        (goto-char 0)
        (if (string-equal (car
                           (cdr
                            (car
                             (org-collect-keywords '("AUTOCALC_CLOCK_TABLES")))))
                          "t")
            (progn
              (goto-char (search-forward "clocktable"))
              (org-ctrl-c-ctrl-c))))))

  (add-hook 'before-save-hook 'autocalc-clocktable)
#+end_src
**** Auto update DATE
#+begin_src emacs-lisp
  (defun my/org-find-time-file-property (property &optional anywhere)
    "Return the position of the time file PROPERTY if it exists.
  When ANYWHERE is non-nil, search beyond the preamble."
    (save-excursion
      (goto-char (point-min))
      (let ((first-heading
             (save-excursion
               (re-search-forward org-outline-regexp-bol nil t))))
        (when (re-search-forward (format "^#\\+%s:" property)
                                 (if anywhere nil first-heading)
                                 t)
          (point)))))

  (defun my/org-set-time-file-property (property &optional anywhere pos)
    "Set the time file PROPERTY in the preamble.
  When ANYWHERE is non-nil, search beyond the preamble.
  If the position of the file PROPERTY has already been computed,
  it can be passed in POS.

  https://github.com/zaeph/.emacs.d/blob/615ac37be6bd78c37e967fdb43d28897a4116583/lisp/zp-org.el#L194"
    (when-let ((pos (or pos
                        (my/org-find-time-file-property property))))
      (save-excursion
        (goto-char pos)
        (if (looking-at-p " ")
            (forward-char)
          (insert " "))
        (delete-region (point) (line-end-position))
        (let* ((now (format-time-string "[%Y-%m-%d %a %H:%M]")))
          (insert now)))))

  (defun my/org-set-date ()
    "Update the LAST_MODIFIED file property in the preamble.
  https://github.com/zaeph/.emacs.d/blob/615ac37be6bd78c37e967fdb43d28897a4116583/lisp/zp-org.el#L212"
    (when (and (derived-mode-p 'org-mode)
               (buffer-modified-p))
      (my/org-set-time-file-property "DATE")))

  (add-hook 'before-save-hook 'my/org-set-date)
#+end_src
** ekg
è½»åº¦å°è¯•ï¼Œç›®å‰è¿˜æœ‰å¾ˆå¤šçš„ä¸è¶³ï¼Œæ—¥å¸¸ä½¿ç”¨ä¸å¤ªå¤Ÿã€‚
å’Œå…¶ä»–çš„æ¨¡å—ä¸èƒ½å¾ˆå¥½çš„åˆä½œï¼Œå¦‚ org-agendaï¼Œmath-previewã€‚
#+begin_src emacs-lisp
  (use-package ekg
    :commands (ekg-show-notes-in-trash
               ekg-show-notes-for-today
               ekg-show-notes-with-tag
               ekg-show-notes-with-all-tags
               ekg-show-notes-with-any-tags
               ekg-show-rename-tag
               ekg-browse-url)
    :bind (("<f9>" . ekg-capture)
           ("M-<f9>" . ekg-capture-url))
    :general
    (evil-define-key 'motion ekg-notes-mode-map
      "q" 'quit-window)
    :config
    (setq triples-default-database-filename (expand-file-name "ekg/triples.db" my-galaxy)))

  (add-to-list 'display-buffer-alist '("\\*EKG"
                                         (display-buffer-pop-up-frame)
                                         (window-parameters
                                          (no-other-window . t)
                                          (mode-line-format . none)
                                          (no-delete-other-windows . t))))
  (my/space-leader-def
    "e" '(:ignore t :wk "EKG")
    "ee" '(ekg-show-notes-with-tag :wk "With TAG")
    "ed" '(ekg-show-notes-for-today :wk "Today")
    "eA" '(ekg-show-notes-with-all-tags :wk "All TAG")
    "ea" '(ekg-show-notes-with-any-tags :wk "Any TAG")
    "et" '(ekg-show-notes-in-trash :wk "Trash")
    "er" '(ekg-rename-tag :wk "Rename TAG")
    "eb" '(ekg-browse-url :wk "Open URL"))
#+end_src
** org-roam
readinglog å’Œ reference æ¨¡æ¿è§ [[./template/]] æ–‡ä»¶å¤¹ã€‚

Org-roam é»˜è®¤ä¼šç¼“å­˜æ‰€æœ‰çš„èŠ‚ç‚¹ï¼ˆæ–‡ä»¶æˆ–æ ‡é¢˜ï¼‰ï¼Œè‹¥è¦æ’é™¤ä¸éœ€è¦çš„èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ =ROAM_EXCLUDE= å…³é”®å­—æˆ–è€…ä½¿ç”¨ =org-roam-db-node-include-function= å‡½æ•°ã€‚

#+begin_example
  (setq org-roam-db-node-include-function
        (lambda ()
          (not (member "ATTACH" (org-get-tags)))))
#+end_example

#+begin_src emacs-lisp
  (use-package org-roam
    :commands org-roam-node-find
    :init
    (setq org-roam-directory (file-truename (expand-file-name "roam" my-galaxy)))
    :hook ((on-first-input . org-roam-db-autosync-mode)
           (org-mode . (lambda () (setq-local time-stamp-active t
                                         time-stamp-start "#\\+MODIFIED:[ \t]*"
                                         time-stamp-end "$"
                                         time-stamp-format "\[%Y-%m-%d %3a %H:%M\]")
                         (add-hook 'before-save-hook 'time-stamp nil 'local))))
    :config
    (setq org-roam-database-connector 'sqlite)
    (setq org-roam-db-gc-threshold most-positive-fixnum)
    (setq org-roam-mode-sections
          '((org-roam-backlinks-section :unique t)
            org-roam-reflinks-section
            org-roam-unlinked-references-section))

    (cl-defmethod org-roam-node-type ((node org-roam-node))
      "Return the TYPE of NODE."
      (condition-case nil
          (file-name-nondirectory
           (directory-file-name
            (file-name-directory
             (file-relative-name (org-roam-node-file node) org-roam-directory))))
        (error "")))

    (cl-defmethod org-roam-node-directories ((node org-roam-node))
      (if-let ((dirs (file-name-directory (file-relative-name (org-roam-node-file node) org-roam-directory))))
          (format "(%s)" (car (split-string dirs "/")))
        ""))

    (cl-defmethod org-roam-node-backlinkscount ((node org-roam-node))
      (let* ((count (caar (org-roam-db-query
                           [:select (funcall count source)
                                    :from links
                                    :where (= dest $s1)
                                    :and (= type "id")]
                           (org-roam-node-id node)))))
        (format "[%d]" count)))

    (cl-defmethod org-roam-node-doom-filetitle ((node org-roam-node))
      "Return the value of \"#+title:\" (if any) from file that NODE resides in.
           If there's no file-level title in the file, return empty string."
      (or (if (= (org-roam-node-level node) 0)
              (org-roam-node-title node)
            (org-roam-get-keyword "TITLE" (org-roam-node-file node)))
          ""))

    (cl-defmethod org-roam-node-doom-hierarchy ((node org-roam-node))
      "Return hierarchy for NODE, constructed of its file title, OLP and direct title.
           If some elements are missing, they will be stripped out."
      (let ((title     (org-roam-node-title node))
            (olp       (org-roam-node-olp   node))
            (level     (org-roam-node-level node))
            (filetitle (org-roam-node-doom-filetitle node))
            (separator (propertize " > " 'face 'shadow)))
        (cl-case level
          ;; node is a top-level file
          (0 filetitle)
          ;; node is a level 1 heading
          (1 (concat (propertize filetitle 'face '(shadow italic))
                     separator title))
          ;; node is a heading with an arbitrary outline path
          (t (concat (propertize filetitle 'face '(shadow italic))
                     separator (propertize (string-join olp " > ") 'face '(shadow italic))
                     separator title)))))

    ;; è·å¾—æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´.
    (cl-defmethod org-roam-node-date ((node org-roam-node))
      (format-time-string "%Y-%m-%d" (org-roam-node-file-mtime node)))

    (setq org-roam-node-display-template
          (concat "${type:4} ${backlinkscount:3} "
                  (propertize "${doom-hierarchy:*}" 'face 'org-level-3)
                  (propertize "${tags:20}" 'face 'org-tag)
                  " "))

    (setq org-roam-capture-templates
          '(("a" "articles" plain "%?"
             :target (file+head "articles/${slug}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)
            ("b" "Books" plain (file "~/.emacs.d/template/readinglog")
             :target (file+head "books/${slug}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)
            ("d" "Diary" plain "%?"
             :target (file+datetree "daily/<%Y-%m>.org" day))
            ("m" "main" plain "%?"
             :target (file+head "main/${slug}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)
            ("p" "people" plain (file "~/.emacs.d/template/crm")
             :target (file+head "crm/${slug}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)
            ("r" "reference" plain (file "~/.emacs.d/template/reference")
             :target (file+head "ref/${citekey}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)
            ("s" "sources" plain "%?"
             :target (file+head "sources/${slug}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)
            ("w" "work" plain "%?"
             :target (file+head "work/${slug}.org"
                                "#+TITLE: ${title}\n#+CREATED: %U\n#+MODIFIED: \n")
             :unnarrowed t)))

    (defun my/org-roam-buffer-show (_)
      (when (and
             (not (minibufferp))
             (not (> 120 (frame-width)))
             (not (derived-mode-p 'calendar-mode))
             (not (derived-mode-p 'org-agenda-mode))
             (xor (org-roam-file-p) (eq 'visible (org-roam-buffer--visibility))))
        (org-roam-buffer-toggle)))

    (add-hook 'window-buffer-change-functions 'my/org-roam-buffer-show)

    (add-to-list 'display-buffer-alist
                 '("\\*org-roam\\*"
                   (display-buffer-reuse-window display-buffer-in-side-window)
                   (side . right)
                   (slot . 0)
                   (window-width . 0.35)
                   (window-parameters
                    (mode-line-format . none)
                    (no-other-window . t)
                    (no-delete-other-windows . t)))))
  (my/space-leader-def
    "n" '(:ignore t :wk "Notes")
    "nr" '(org-roam-node-random :wk "Random node")

    "nf" '(org-roam-node-find :wk "Find node")
    "ni" '(org-roam-node-insert :wk "Insert node")

    "na" '(org-roam-alias-add :wk "Add alias")
    "nA" '(org-roam-alias-remove :wk "Remove alias")

    "nt" '(org-roam-tag-add :wk "Add tag")
    "nT" '(org-roam-tag-remove :wk "Remove tag")

    "nd" '(org-roam-dailies-goto-today :wk "Goto today"))

  (my/space-leader-def
    "r" '(:ignore t :wk "References")
    "ra" '(org-roam-ref-add :wk "Ref add")
    "rf" '(org-roam-ref-find :wk "Ref find")
    "rr" '(org-roam-ref-remove :wk "Ref remove"))
#+end_src
#+begin_src emacs-lisp
  (use-package org
    :after evil
    :config
    (defun gpc/open-node-roam-ref-url ()
      "Open the URL in this node's ROAM_REFS property, if one exists."
      (interactive)
      (when-let ((ref-url (org-entry-get-with-inheritance "ROAM_REFS")))
        (browse-url ref-url)))

    (evil-collection-define-key 'normal 'org-mode-map
      "zr" 'gpc/open-node-roam-ref-url))
#+end_src

*** org-roam-ui
#+begin_src emacs-lisp
  (use-package org-roam-ui
    :commands org-roam-ui-open
    :config
    (setq org-roam-ui-sync-theme t)
    (setq org-roam-ui-follow t)
    (setq org-roam-ui-update-on-save t)
    (setq org-roam-ui-open-on-start t))

  (my/space-leader-def
    "nu" '(:ignore :wk "Roam UI")
    "nuu" '(org-roam-ui-open :wk "Open")
    "nuz" '(org-roam-ui-node-zoom :wk "Node zoom"))
#+end_src

*** consult-org-roam
è¿™ä¸ªåŒ…æä¾›äº† 3 ä¸ªæœ‰ç”¨çš„å‡½æ•°ï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œé“¾æ¥çš„ forward å’Œ backlink çš„è·³è½¬ï¼Œä»¥åŠè¿›è¡Œå†…å®¹çš„æŸ¥æ‰¾ã€‚
#+begin_src emacs-lisp
  (use-package consult-org-roam
    :commands (consult-org-roam-backlinks consult-org-roam-forward-links))

  (my/space-leader-def
    "ns" '(consult-org-roam-search :wk "Search"))

  (with-eval-after-load 'evil
    (evil-collection-define-key 'normal 'org-mode-map
      "zb" 'consult-org-roam-backlinks
      "zf" 'consult-org-roam-forward-links))
#+end_src

*** consult-notes
è¿™ä¸ªåŒ…ç»“åˆ denote æ¯”è¾ƒå¥½ç”¨ï¼Œä¸éœ€è¦ç»“åˆ org-roam ä½¿ç”¨ã€‚

å› ä¸ºæˆ‘å·±ç»ä¸ä½¿ç”¨ deft è€Œæ˜¯ä½¿ç”¨ consult-notes æ¥ç®¡ç†è‡ªå·±å†™çš„åšå®¢ã€‚ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°æ¥åˆ›å»ºæ–°çš„æ–‡ç« ï¼Œ consult-notes åªèƒ½ç”¨äºæŸ¥è¯¢ï¼Œæ— æ–°å»ºæ–‡ä»¶çš„åŠŸèƒ½ã€‚
#+begin_src emacs-lisp
  (use-package consult-notes
    :commands consult-notes
    :config
    (setq consult-notes-file-dir-sources
          `(("Articles"  ?a  ,(concat my-galaxy "/articles")))))
  (defun my/new-article (article)
      (interactive "sTitle: ")
      (let ((filename (format "%s" article))
            (ext ".org"))
        (find-file (concat my-galaxy "/articles/" filename ext))
        (insert "#+TITLE: " article "\n")
        (tempel-insert 'hugo)))

  (my/space-leader-def
      "nc" '(my/new-article :wk "Create article")
      "nn" '(consult-notes :wk "Consult notes"))

  (use-package consult-notes-org-roam
    :commands consult-notes-org-roam-find-node-relation)

  (my/space-leader-def
      "nv" '(consult-notes-org-roam-find-node-relation :wk "Node navigation"))
#+end_src

*** org-transclusion
è¿™é‡Œéœ€è¦ç»“åˆ [[fringe-mode]] ä½¿ç”¨ï¼Œä¸èƒ½å®Œå…¨éšè— fringe, å¦åˆ™ä¼šæ²¡æœ‰æ•ˆæœã€‚æˆ‘è®¾ç½®çš„æ˜¯ minimal.
#+begin_src emacs-lisp
  (use-package org-transclusion
    :commands (org-transclusion-make-from-link org-transclusion-add org-transclusion-add-all)
    :config
    (face-spec-set 'org-transclusion-fringe
                   '((((background light))
                      :foreground "black")
                     (t
                      :foreground "white"))
                   'face-override-spec)
    (face-spec-set 'org-transclusion-source-fringe
                   '((((background light))
                      :foreground "black")
                     (t
                      :foreground "white"))
                   'face-override-spec))
  (my/space-leader-def
    "ot" '(:ignore t :wk "Transclusion")
    "ota" '(org-transclusion-add :wk "Add")
    "otA" '(org-transclusion-add-all :wk "Add all")
    "otr" '(org-transclusion-remove :wk "Remove")
    "otR" '(org-transclusion-remove-all :wk "Remove all")
    "otg" '(org-transclusion-refresh :wk "Refresh")
    "otm" '(org-transclusion-make-from-link :wk "Make link")
    "oto" '(org-transclusion-open-source :wk "Open source")
    "ote" '(org-transclusion-live-sync-start :wk "Edit live"))
#+end_src

** dynamic org-agenda
vulpea to build dynamic agenda.
#+begin_src emacs-lisp
  ;; (autoload 'vulpea-buffer-tags-get "vulpea" "" t) ;
  ;; (autoload 'vulpea-buffer-tags-add "vulpea" "" t)
  ;; (autoload 'vulpea-buffer-tags-remove "vulpea" "" t)
  ;; (autoload 'vulpea-buffer-prop-set "vulpea" "" t)
  ;; (autoload 'vulpea-buffer-prop-get "vulpea" "" t)
  ;; (autoload 'vulpea-buffer-prop-set-list "vulpea" "" t)
  ;; (autoload 'vulpea-buffer-prop-get-list "vulpea" "" t)
  (use-package vulpea
    :after org-roam
    :config
    (defun vulpea-project-p ()
      "Return non-nil if current buffer has any todo entry.
    TODO entries marked as done are ignored, meaning the this
    function returns nil if current buffer contains only completed
    tasks."
      (seq-find                                 ; (3)
       (lambda (type)
         (or (eq type 'todo)
             (eq type 'done)))
       (org-element-map                         ; (2)
           (org-element-parse-buffer 'headline) ; (1)
           'headline
         (lambda (h)
           (org-element-property :todo-type h)))))

    (defun vulpea-buffer-p ()
      "Return non-nil if the currently visited buffer is a note."
      (and buffer-file-name
           (string-prefix-p
            (expand-file-name (file-name-as-directory org-roam-directory))
            (file-name-directory buffer-file-name))))

    (defun vulpea-project-update-tag ()
      "Update PROJECT tag in the current buffer."
      (when (and (not (active-minibuffer-window))
                 (vulpea-buffer-p))
        (save-excursion
          (goto-char (point-min))
          (let* ((tags (vulpea-buffer-tags-get))
                 (original-tags tags))
            (if (vulpea-project-p)
                (setq tags (cons "project" tags))
              (setq tags (remove "project" tags)))
            ;; cleanup duplicates
            (setq tags (seq-uniq tags))
            ;; update tags if changed
            (when (or (seq-difference tags original-tags)
                      (seq-difference original-tags tags))
              (apply #'vulpea-buffer-tags-set tags))))))

    (defun vulpea-project-files ()
      "Return a list of note files containing 'project' tag." ;
      (seq-uniq
       (seq-map
        #'car
        (org-roam-db-query
         [:select [nodes:file]
                  :from tags
                  :left-join nodes
                  :on (= tags:node-id nodes:id)
                  :where (like tag (quote "%\"project\"%"))]))))

    (defun vulpea-agenda-files-update (&rest _)
      "Update the value of `org-agenda-files'."
      (setq org-agenda-files (seq-uniq
                              (append
                               (vulpea-project-files)
                               `(,(expand-file-name "todos/gtd.org" my-galaxy))))))

    (add-hook 'find-file-hook #'vulpea-agenda-files-update)

    (advice-add 'org-agenda :before #'vulpea-agenda-files-update)
    (advice-add 'org-todo-list :before #'vulpea-agenda-files-update)

    (add-hook 'find-file-hook #'vulpea-project-update-tag)
    (add-hook 'before-save-hook #'vulpea-project-update-tag))
#+end_src
#+begin_src emacs-lisp
  (defun my/gtd-file ()
    (interactive)
    (find-file (expand-file-name "todos/gtd.org" my-galaxy)))
  (my/space-leader-def
    "fog" '(my/gtd-file :wk "GTD file"))
#+end_src

#+begin_src emacs-lisp
  (use-package org-agenda
    :after org
    :bind ("<f12>" . my/org-agenda)
    :hook (org-agenda-finalize . #'org-agenda-find-same-or-today-or-agenda)
    :init
    (setq org-agenda-files (directory-files-recursively (expand-file-name "todos" my-galaxy) "org$\\|archive$"))
    :config
    (setq org-agenda-dim-blocked-tasks t)
    (setq org-agenda-compact-blocks t)
    (setq org-agenda-window-setup 'other-tab)
    (setq org-agenda-align-tags-to-column -120)
    (setq org-agenda-custom-commands
          '(("R" "Review projects" tags-todo "-CANCELLED/"
             ((org-agenda-overriding-header "Reviews Scheduled")
              (org-agenda-skip-function 'org-review-agenda-skip)
              (org-agenda-cmp-user-defined 'org-review-compare)))
            ("A" "Archive"
             ((todo "DONE|CNCL"
                    ((org-agenda-prefix-format " %i")
                     (org-agenda-hide-tags-regexp "project")
                     (org-agenda-overriding-header "Archive")))))
            (" " "GTD Lists: Daily agenda and tasks"
             ((agenda "" ((org-agenda-span 2)
                          (org-deadline-warning-days 3)
                          (org-agenda-block-separator nil)
                          (org-scheduled-past-days 365)
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-day-face-function (lambda (date) 'org-agenda-date))
                          (org-agenda-format-date "%A %-e %B %Y")
                          (org-agenda-prefix-format " %i %?-12t% s")
                          (org-agenda-overriding-header "Today's agenda")))
              (tags-todo "*"
                         ((org-agenda-skip-function
                           `(org-agenda-skip-entry-if 'deadline
                                                      'schedule
                                                      'timestamp
                                                      'notregexp ,(format "\\[#%s\\]" (char-to-string org-priority-highest))))
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-prefix-format " %i")
                          (org-agenda-overriding-header "Important tasks without a date")))
              (todo "NEXT"
                    ((org-agenda-skip-function '(org-agenda-skip-if nil '(timestamp)))
                     (org-agenda-prefix-format " %i")
                     (org-agenda-block-separator nil)
                     (org-agenda-hide-tags-regexp "project")
                     (org-agenda-overriding-header "Next tasks list")))
              (tags-todo "-Reading/INPROGRESS"
                         ((org-agenda-block-separator nil)
                          (org-agenda-skip-function '(org-agenda-skip-if nil '(timestamp)))
                          (org-agenda-prefix-format " %i")
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-overriding-header "Inprogress tasks list")))
              (tags-todo "-Computer-Emacs-Reading/TODO"
                         ((org-agenda-skip-function
                           `(org-agenda-skip-entry-if 'deadline
                                                      'schedule
                                                      'timestamp
                                                      'regexp ,(format "\\[#%s\\]" (char-to-string org-priority-highest))))
                          (org-agenda-prefix-format " %i")
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-block-separator nil)
                          (org-agenda-overriding-header "Todo tasks list")))
              (tags-todo "Emacs|Computer"
                         ((org-agenda-block-separator nil)
                          (org-agenda-skip-function '(org-agenda-skip-if nil '(timestamp)))
                          (org-agenda-prefix-format " %i")
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-overriding-header "Computer science")))
              (tags-todo "Family"
                         ((org-agenda-skip-function '(org-agenda-skip-if nil '(timestamp)))
                          (org-agenda-prefix-format " %i")
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-block-separator nil)
                          (org-agenda-overriding-header "Family")))
              (tags-todo "Reading"
                         ((org-agenda-skip-function '(org-agenda-skip-if nil '(timestamp)))
                          (org-agenda-prefix-format " %i")
                          (org-agenda-hide-tags-regexp "project")
                          (org-agenda-block-separator nil)
                          (org-agenda-overriding-header "Reading Lists")))
              (todo "WAIT|SOMEDAY"
                    ((org-agenda-block-separator nil)
                     (org-agenda-prefix-format " %i")
                     (org-agenda-hide-tags-regexp "project")
                     (org-agenda-overriding-header "Tasks on hold")))))))

    (setq org-agenda-category-icon-alist
          `(("\\`gtd\\'"
             (#("ï‚® " 0 1 (rear-nonsticky t display (raise 0.0)
                                         font-lock-face
                                         (:family "FontAwesome" :height 1.0)
                                         face
                                         (:family "FontAwesome" :height 1.0))))
             nil nil :ascent center)
            ("\\\cc\\\|[a-zA-z0-9]*"
             (#("î¯ " 0 1 (rear-nonsticky t display (raise 0.0)
                                         font-lock-face
                                         (:family "FontAwesome" :height 1.0)
                                         face
                                         (:family "FontAwesome" :height 1.0))))
             nil nil :ascent center)))

    (defun my/org-agenda ()
      "Open my `org-agenda'.
  Run `org-roam-db-sync' to get full lists of org agenda files."
      (interactive)
      (if (eq major-mode 'org-agenda-mode)
          (org-agenda-redo-all)
        (org-agenda "" " ")))

    (defun my/org-agenda-query ()
      "Open my `org-agenda' and `m'.
    Run `org-roam-db-sync' to get full lists of org agenda files."
      (interactive)
      (org-roam-db-sync)
      (org-agenda "" "m"))

    (defun my/org-inprogress-tasks ()
      (interactive)
      (org-todo-list "INPROGRESS"))

    (my/space-leader-def
      "o" '(:ignore t :wk "Org")
      "oa" '(:ignore t :wk "Agenda")
      "oaa" '(my/org-agenda :wk "Agenda")
      "oaq" '(my/org-agenda-query :wk "Query")
      "oat" '(org-todo-list :wk "Todo list")
      "oav" '(org-search-view :wk "View search")
      "oai" '(my/org-inprogress-tasks :wk "Inprogess tasks")))
#+end_src

#+begin_src emacs-lisp
  (use-package org-agenda
    :after evil
    :config
    (evil-set-initial-state 'org-agenda-mode 'motion)
    (evil-define-key 'motion org-agenda-mode-map
      (kbd "RET") 'org-agenda-switch-to
      "gj" 'org-agenda-next-item
      "gr" 'org-agenda-redo
      "gR" 'org-agenda-redo-all
      "t" 'org-agenda-todo
      "u" 'org-agenda-undo
      "I" 'org-agenda-clock-in
      "O" 'org-agenda-clock-out
      "cg" 'org-agenda-clock-goto
      "cc" 'org-agenda-clock-cancel
      "cr" 'org-agenda-clockreport-mode))
#+end_src
** calendar and appt
#+begin_src emacs-lisp
  (use-package calendar
    :commands calendar
    :config
    (setq calendar-view-diary-initially-flag t)
    (setq calendar-mark-diary-entries-flag t)
    (setq calendar-mode-line-format nil)

    (setq calendar-date-style 'iso)
    (setq calendar-date-display-form calendar-iso-date-display-form)

    (setq calendar-time-display-form
          '(24-hours ":" minutes
                     (when time-zone
                       (format "(%s)" time-zone))))
    (setq diary-date-forms diary-iso-date-forms)
    :hook (calendar-today-visible . #'calendar-mark-today))

  (my/comma-leader-def
    "c" '(calendar :wk "Calendar"))
#+end_src

#+begin_src emacs-lisp
  (use-package appt
    :after calendar
    :config
    (setq appt-display-diary nil)
    (setq appt-disp-window-function #'appt-disp-window)
    (setq appt-display-mode-line t)
    (setq appt-display-interval 3)
    (setq appt-audible nil)
    (setq appt-warning-time-regexp "appt \\([0-9]+\\)")
    (setq appt-message-warning-time 6)
    (add-hook 'diary-mode-hook #'appt-activate))
#+end_src

Use diary-lib to write diary. å…³äºè¿™ä¸ªçš„ä½¿ç”¨å¯ä»¥è§ï¼š[[https://www.youtube.com/watch?v=NkhgIB64zgc][Emacs: Diary and Calendar - YouTube]]
#+begin_src emacs-lisp
  (use-package diary-lib
    :after calendar
    :config
    (add-hook 'diary-list-entries-hook #'diary-sort-entries)
    (add-hook 'diary-mode-hook #'goto-address-mode)
    (setq diary-display-function #'diary-fancy-display)
    (setq diary-header-line-format nil)
    (setq diary-list-include-blanks nil)
    (setq diary-abbreviated-year-flag nil)
    (setq diary-number-of-entries 7)
    (setq diary-comment-start ");;")
    (setq diary-comment-end "")
    (setq diary-nonmarking-symbol "!")

    (setq diary-file (expand-file-name "diary/diary.org" my-galaxy)))
#+end_src

** Zen
Zen Mode æˆ–è€…å«ç¦…æ¨¡å¼ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†é™ä½ä¸ç›¸å…³å› ç´ å¯¹äºå¿ƒæ™ºçš„å¹²æŒ ã€‚å°†è‡ªå·±çš„è§†é‡é›†ä¸­äºå¯è§çš„åŒºåŸŸï¼Œä¸éœ€è¦ç§»åŠ¨è„‘è¢‹ã€‚

åœ¨ Emacs ä¸Šæœ‰ä¸¤ä¸ªç›¸å…³çš„åŒ…ï¼Œä¸€ä¸ªæ˜¯ ~olivetti~, å¦å¤–ä¸€ä¸ªæ˜¯ ~writeroom-mode~. ~olivetti~ çš„åŠŸèƒ½æ›´å•ä¸€ä¸€äº›ï¼Œä½†æ˜¯è¶³å¤Ÿä½¿ç”¨ã€‚
#+begin_src emacs-lisp
  (use-package olivetti
    :commands olivetti-mode)

  (with-eval-after-load 'evil
    (evil-define-key 'nromal 'org-mode-map
      "zw" 'olivetti-mode))
#+end_src
** TOC
åœ¨ Org æ–‡ä»¶çš„é¡¶éƒ¨ç”Ÿæˆç›®å½•ã€‚[[https://github.com/snosov1/toc-org][snosov1/toc-org: toc-org is an Emacs utility to have an up-to-date table of contents in the org files without exporting (useful primarily for readme files on GitHub)]]

éœ€è¦åœ¨æ–‡ä»¶çš„å¤´éƒ¨æ–°å»ºä¸€ä¸ª heading å¹¶åŠ ä¸Š tagï¼štoc.
#+begin_src emacs-lisp
  (use-package toc-org
    :hook (org-mode . toc-org-mode))
#+end_src

** org-super-star
[[https://github.com/integral-dw/org-superstar-mode][integral-dw/org-superstar-mode: Make org-mode stars a little more super]]

#+begin_src emacs-lisp
  (use-package org-superstar
    :hook (org-mode . org-superstar-mode)
    :config
    (setq org-superstar-headline-bullets-list '("â¶" "â·" "â¸" "â¹" "âº" "â»" "â¼"))
    ;; (setq org-superstar-headline-bullets-list '("1" "2" "3" "4" "5" "6" "7"))
    ;; (setq org-superstar-headline-bullets-list '("â‘ " "â‘¡" "â‘¢" "â‘£" "â‘¤" "â‘¥"))
    (setq org-hide-leading-stars t))
#+end_src
** org-download
ç”¨äºç®¡ç†å›¾ç‰‡ã€‚
#+begin_src emacs-lisp
  (use-package org-download
    :commands org-download-enable
    :hook (org-mode . org-download-enable)
    :config
    (setq org-download-image-dir (expand-file-name "pictures" my-galaxy))
    (setq org-download-screenshot-method 'screencapture)
    (setq org-download-abbreviate-filename-function 'expand-file-name)
    (setq org-download-timestamp "%Y%m%d%H%M%S")
    (setq org-download-display-inline-images nil)
    (setq org-download-heading-lvl nil)
    (setq org-download-annotate-function (lambda (_link) ""))
    (setq org-download-image-attr-list '("#+NAME: fig: "
                                         "#+CAPTION: "
                                         "#+ATTR_ORG: :width 500px"
                                         "#+ATTR_LATEX: :width 10cm :placement [!htpb]"
                                         "#+ATTR_HTML: :width 600px")))
  (my/space-leader-def
    "od" '(:ignore t :wk "Download")
    "odc" '(org-download-clipboard :wk "Download Clipboard")
    "ody" '(org-download-yank :wk "Download Yank")
    "odr" '(org-download-rename-last-file :wk "Rename last file")
    "odR" '(org-download-rename-at-point :wk "Rename point"))
#+end_src

** org-appear
åœ¨ org ä¸­ç»å¸¸ä½¿ç”¨é“¾æ¥ï¼Œä½¿ Org å…ƒç´ çš„ä¸å¯è§éƒ¨åˆ†æ˜¾ç¤ºä¸ºå¯è§ã€‚ç»“åˆ Evil ä½¿ç”¨ï¼Œå¯¹äºé“¾æ¥çš„ç¼–è¾‘å¾ˆæ–¹ä¾¿ã€‚
#+begin_src emacs-lisp
  (use-package org-appear
    :config
    (setq org-appear-autolinks t)
    (setq org-appear-trigger 'manual)
    :hook ((org-mode . (lambda ()
                         (add-hook 'evil-insert-state-entry-hook
                                   #'org-appear-manual-start
                                   nil
                                   t)
                         (add-hook 'evil-insert-state-exit-hook
                                   #'org-appear-manual-stop
                                   nil
                                   t)))
           (org-mode . org-appear-mode)))
#+end_src

** math-preview
#+begin_src emacs-lisp
  (use-package math-preview
    :commands (math-preview-all math-preview-at-point)
    :config
    (setq math-preview-scale 1.1)
    (setq math-preview-raise 0.3)
    (setq math-preview-margin '(1 . 0)))

  (my/space-leader-def
    "mpa" '(math-preview-all :wk "All")
    "mpA" '(math-preview-clear-all :wk "Clear All")
    "mpp" '(math-preview-at-point :wk "Point")
    "mpP" '(math-preview-clear-at-point :wk "Clear Point")
    "mpr" '(math-preview-region :wk "Region")
    "mpR" '(math-preview-clear-region :wk "Clear Region"))
#+end_src

** plantuml
#+begin_src emacs-lisp
  (use-package plantuml
    :commands (plantuml-org-to-mindmap-open plantuml-org-to-wbs-open)
    :hook (org-mode . (lambda ()
                        (require 'plantuml)))
    :config
    (setq plantuml-jar-path
          (concat (string-trim
                   (shell-command-to-string "readlink -f $(brew --prefix plantuml)"))
                  "/libexec/plantuml.jar")))
  (my/space-leader-def
    "op" '(:ignore t :wk "Plantuml")
    "opm" '(plantuml-org-to-mindmap-open :wk "Mindmap")
    "ops" '(plantuml-org-to-wbs-open :wk "Work Breakdown Structure"))
#+end_src

** org-rainbow-tags
#+begin_src emacs-lisp
  (use-package org-rainbow-tags
    :hook (org-mode . org-rainbow-tags-mode))
#+end_src

** alarm-clock
å¦‚å…¶åï¼Œåœ¨ Emacs ä¸­è®¾ç½®é—¹é’Ÿçš„ã€‚
#+begin_src emacs-lisp
  (use-package alarm-clock
    :commands (alarm-clock-set alarm-clock-list-view)
    :config
    (setq alarm-clock-cache-file (expand-file-name "var/.alarm-clock.cache" user-emacs-directory)))
#+end_src

** COMMENT alert
#+begin_src emacs-lisp
  (use-package alert
    :defer t
    :config
    (setq alert-default-style 'osx-notifier))
#+end_src
** COMMENT org-alert
#+begin_src emacs-lisp
  (use-package org-alert
    :hook (after-init . org-alert-enable)
    :config
    (setq org-alert-interval 300)
    (setq org-alert-notify-cutoff 10)
    (setq org-alert-notify-after-event-cutoff 10)
    (setq org-alert-notification-title "Org Agenda Reminder!"))
#+end_src

** pomm
Emacs ä¸­æ‰§è¡Œ Pomodoro å“²å­¦ã€‚
#+begin_src emacs-lisp
  (use-package pomm
    :commands pomm
    :config
    (setq pomm-state-file-location (expand-file-name "pomm" no-littering-var-directory))
    (pomm-mode-line-mode 1))
#+end_src

** Pandoc
å°† org æ–‡æ¡£è½¬æ¢ä¸º word æ–‡æ¡£ï¼Œä»…æ”¯æŒç®€å•çš„æ–‡æ¡£ï¼Œè¿‡äºå¤æ‚çš„æ–‡æ¡£ä¸è¡Œã€‚
#+begin_src emacs-lisp
  (defun org-export-docx ()
    "Convert org to docx."
    (interactive)
    (let ((docx-file (concat (file-name-sans-extension (buffer-file-name)) ".docx"))
          (template-file (expand-file-name "template/template.docx" user-emacs-directory)))
      (shell-command (format "pandoc %s -o %s --reference-doc=%s" (buffer-file-name) docx-file template-file))
      (message "Convert finish: %s" docx-file)))
#+end_src

ox-pandoc å¢åŠ  org-export çš„é€‰é¡¹ã€‚ä¸è¿‡ ox-pandoc å·±ç»ä¸æ€ä¹ˆæ›´æ–°ã€‚

æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª pandoc-mode, åˆæ­¥å°è¯•åæ„Ÿè§‰è¿˜å¯ä»¥ã€‚.

Pandoc ä¸æ€ä¹ˆä½¿ç”¨ï¼Œæ—¶é—´é•¿äº†å°±å¿˜è®° pandoc çš„ä½¿ç”¨æ–¹æ³•ã€‚
#+begin_src emacs-lisp :tangle no
  ;; First, install pandoc with `brew install pandoc'.
  ;; Only for simple file, no cite info, no latex formular.
  ;; Image file has to be absolute path, relative path do not work!
  (setq org-pandoc-menu-entry
        '((?m "as md." org-pandoc-export-as-commonmark)
          (?M "to md and open." org-pandoc-export-to-commonmark-and-open)
          (?x "to docx." org-pandoc-export-to-docx)
          (?X "to docx and open." org-pandoc-export-to-docx-and-open)
          (?e "to epub." org-pandoc-export-to-epub)
          (?E "to epub and open." org-pandoc-export-to-epub-and-open)
          (?3 "to epub3." org-pandoc-export-to-epub3)
          (?Â£ "to epub3 and open." org-pandoc-export-to-epub3-and-open)
          (?j "as json." org-pandoc-export-as-json)
          (?J "to json and open." org-pandoc-export-to-json-and-open)
          (?r "as rst." org-pandoc-export-as-rst)
          (?R "to rst and open." org-pandoc-export-to-rst-and-open)))
  (setq org-pandoc-options '((standalone . t)
                             (mathjax . t)
                             (wrap . "preserve")))
#+end_src

** beancount-mode
Beancount has more plugin than ledger-cli.
#+begin_src emacs-lisp
  (use-package beancount
    :mode (".bean" . beancount-mode)
    :hook ((beancount-mode . (lambda ()
                               (setq-local electric-indent-chars nil)))
           (beancount-mode . outline-minor-mode))
    :config
    (evil-define-key 'normal 'beancount-mode-map
      "zf" 'beancount-fava)

    ;; insert whole transaction instead of only insert date.
    (defun my/beancount-insert-transaction (&optional days)
      "Start a new timestamped directive with date shifted by DAYS from today."
      (interactive "P")
      (unless (bolp) (newline))
      (insert (beancount--shift-current-date days) " * \"\" \"\"")
      (evil-backward-char 3)
      (evil-insert 0))

    (advice-add 'beancount-insert-date :override 'my/beancount-insert-transaction)

    ;; Auto open browser after beancount-fava started.
    (defun my/browser-beancount-fava ()
      (if beancount--fava-process
          (browse-url "http://127.0.0.1:5000")))

    (advice-add 'beancount-fava :after 'my/browser-beancount-fava)

    ;; auto align transaction before save file.
    (defun my/beancount-align-transaction ()
      "Align visible region in current buffer."
      (save-excursion
        (indent-region (window-start) (window-end))))

    (add-hook 'before-save-hook (lambda ()
                                  (if (eq major-mode 'beancount-mode)
                                      (my/beancount-align-transaction))))

    ;; If cursor in "", activate input method rime.
    (defun my/beancount-activate-input-method ()
      (when (eq major-mode 'beancount-mode)
        (if (not (bounds-of-thing-at-point 'whitespace))
            (if (bounds-of-thing-at-point 'string)
                (activate-input-method "rime")))))

    (add-hook 'evil-insert-state-entry-hook #'my/beancount-activate-input-method))





#+end_src
** Bibtex management
æ–‡çŒ®ç®¡ç†æ¶‰åŠåˆ°çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæ–‡çŒ®çš„æŸ¥æ‰¾ã€ç®¡ç†ã€é˜…è¯»ä¸å¼•ç”¨ç­‰ç­‰ã€‚

Emacs è¿›è¡Œæ–‡çŒ®ç®¡ç†éœ€è¦ç”¨åˆ°çš„åŒ…æœ‰ org-cite,bibtex-completion,citar
*** org-cite
Org-cite ç›®å‰æ˜¯ org å†…ç½®çš„è¿›è¡Œæ–‡çŒ®å¼•ç”¨çš„åŒ…ã€‚

å…³äº org-cite çš„ä½¿ç”¨è§ï¼šhttps://blog.tecosaur.com/tmio/2021-07-31-citations.html æˆ– [[https://kristofferbalintona.me/posts/202206141852/][Citations in org-mode: Org-cite and Citar | Kristoffer Balintona]].

å·±ç»è¯´çš„æ¯”è¾ƒè¯¦ç»†ã€‚
#+begin_src emacs-lisp
  (use-package oc
    :after org
    :config
    (setq org-cite-global-bibliography `(,(concat my-galaxy "/bibtexs/References.bib"))))
#+end_src

*** citar
ä¸ºä»€ä¹ˆä½¿ç”¨ citar? æ˜¯å› ä¸º org-cite çš„æç¤ºç•Œé¢çœ‹èµ·æ¥ä¸å’‹åœ°ï¼Œè€Œ citar æä¾›çš„ç•Œé¢å°±å¾ˆå‹å¥½ã€‚

æˆ‘é€šå¸¸ä½¿ç”¨ ~citar-open-files~ / ~SPC n r p~ æ¥æ‰“å¼€æƒ³è¦é˜…è¯»çš„æ–‡çŒ® PDF æ–‡ä»¶ã€‚

é˜…è¯»æ–‡çŒ®ä½¿ç”¨çš„æ˜¯ [[pdf-tools]] ï¼Œæ›´å¥½ç”¨çš„æ˜¯ [[https://github.com/emacs-eaf/eaf-pdf-viewer][emacs-eaf/eaf-pdf-viewer: Fastest PDF Viewer in Emacs]].

eaf-pdf-viewer å­˜åœ¨çš„é—®é¢˜è¿˜æ˜¯å®‰è£…è¾ƒéš¾ï¼Œå¯¹äºç³»ç»Ÿç¯å¢ƒè¦æ±‚è¾ƒé«˜ï¼Œå¦‚ Emacs 29 ä¸Šå°±ä¸èƒ½ä½¿ç”¨ï¼Œå­˜åœ¨é—®é¢˜ã€‚
#+begin_src emacs-lisp
  (use-package citar
    :commands citar-open citar-open-entry citar-open-files citar-open-notes citar-open-links
    :config
    (setq citar-bibliography org-cite-global-bibliography)
    (setq citar-notes-paths `(,(expand-file-name "roam/ref" my-galaxy)))
    (setq citar-library-file-extensions '("pdf" "jpg" "epub"))
    (setq citar-templates '((main . "${author editor:30} ${date year issued:4} ${title:48}")
                            (suffix . "${=key= id:15} ${=type=:12} ${tags keywords:*}")
                            (preview . "${author editor} (${year issued date}) ${title}, ${journal journaltitle publisher container-title collection-title}.\n")
                            (note . "${title}")))
    (setq citar-symbol-separator "  ")
    (setq citar-file-additional-files-separator "-")
    (setq citar-at-point-function 'embark-act))

  (use-package citar
    :after all-the-icons
    :config
    (setq citar-symbols
          `((file ,(all-the-icons-faicon "file-pdf-o" :face 'all-the-icons-dred :v-adjust -0.1) . " ")
            (note ,(all-the-icons-material "speaker_notes" :face 'all-the-icons-blue :v-adjust -0.3) . " ")
            (link ,(all-the-icons-octicon "link" :face 'all-the-icons-orange :v-adjust 0.01) . " "))))

  (use-package citar-capf
    :hook ((LaTeX-mode . citar-capf-setup)
           (org-mode . citar-capf-setup)))

  (use-package citar-org
    :config
    (setq org-cite-insert-processor 'citar)
    (setq org-cite-follow-processor 'citar)
    (setq org-cite-activate-processor 'citar)

    (with-eval-after-load 'citar-org
      (define-key citar-org-citation-map (kbd "RET") 'org-open-at-point)))

  (use-package citar-embark
    :commands citar-embark-mode
    :hook (org-mode . citar-embark-mode))

  (my/space-leader-def
    "re" '(citar-open-entry :wk "Open entry")
    "rp" '(citar-open-files :wk "Open files")
    "ri" '(citar-insert-citation :wk "Insert citation")
    "rn" '(citar-open-notes :wk "Open/Create note")
    "rl" '(citar-open-links :wk "Open links"))
#+end_src

*** citar-org-roam
è¿™ä¸ªåŒ…å°† citar å’Œ org-roam ç›¸ç»“åˆï¼Œæˆ‘ä¸»è¦ä½¿ç”¨å®ƒæ¥åˆ›å»ºæ–‡çŒ®ç¬”è®°å†…å®¹ã€‚

ç›®å‰ citar-org-roam ä¸æ”¯æŒ capture with template, æˆ‘æ”¹å†™äº† citar-org-roam--create-capture-note å‡½æ•°ã€‚
#+begin_src emacs-lisp
  (use-package citar-org-roam
    :commands (citar-org-roam-mode citar-org-roam-cited)
    :hook (org-roam-mode . citar-org-roam-mode)
    :config
    (setq citar-org-roam-subdir "ref")
    (setq citar-org-roam-note-title-template "${title}")

    ;; Temporarily work, wait citar-org-roam update to support capture with template.
    (defun my/citar-org-roam--create-capture-note (citekey entry)
      "Open or create org-roam node for CITEKEY and ENTRY."
      ;; adapted from https://jethrokuan.github.io/org-roam-guide/#orgc48eb0d
      (let ((title (citar-format--entry
                    citar-org-roam-note-title-template entry)))
        (org-roam-capture-
         :templates
         '(("r" "reference" plain (file "~/.emacs.d/template/reference") :if-new ;; Change "%?" to a template file.
            (file+head
             "%(concat
                    (when citar-org-roam-subdir (concat citar-org-roam-subdir \"/\")) \"${citekey}.org\")"
             "#+title: ${title}\n")
            :immediate-finish t
            :unnarrowed t))
         :info (list :citekey citekey)
         :node (org-roam-node-create :title title)
         :props '(:finalize find-file))
        (org-roam-ref-add (concat "@" citekey))))
    (advice-add 'citar-org-roam--create-capture-note :override #'my/citar-org-roam--create-capture-note))

  (my/space-leader-def
    "rc" '(citar-org-roam-cited :wk "Cited Roam Node"))
#+end_src
*** bibtex-completion
bibtex-completion è¿™ä¸ªåŒ…æ˜¯ org-roam-bibtex çš„ä¾èµ–ã€‚
#+begin_src emacs-lisp
  (use-package bibtex-completion
    :after org-roam-bibtex
    :config
    (setq bibtex-completion-bibliography org-cite-global-bibliography)
    (setq bibtex-completion-notes-path (expand-file-name "roam/ref" my-galaxy))
    (setq bibtex-completion-pdf-field "File")
    (setq bibtex-completion-additional-search-fields '(keywords journal booktitle))
    (setq bibtex-completion-pdf-symbol "P")
    (setq bibtex-completion-notes-symbol "N")
    (setq bibtex-completion-display-formats '((article . "${=has-pdf=:1} ${=has-note=:1} ${year:4} ${author:36} ${title:*} ${journal:40}")
                                              (inbook . "${=has-pdf=:1} ${=has-note=:1} ${year:4} ${author:36} ${title:*} Chapter ${chapter:32}")
                                              (incollection . "${=has-pdf=:1} ${=has-note=:1} ${year:4} ${author:36} ${title:*} ${booktitle:40}")
                                              (inproceedings . "${=has-pdf=:1} ${=has-note=:1} ${year:4} ${author:36} ${title:*} ${booktitle:40}")
                                              (t . "${=has-pdf=:1} ${=has-note=:1} ${year:4} ${author:36} ${title:*}"))))
#+end_src
*** org-roam-bibtex
org-roam-bibtex çš„ä¸»è¦ä½œç”¨æ˜¯å½“åˆ›å»ºæ–‡çŒ®ç¬”è®°æ—¶ï¼Œä¼šåœ¨æ–‡ä»¶çš„å¤´éƒ¨åˆ›å»ºä¸€ä¸ª ~ROAM_REFS: @xxx~ ï¼Œè¿™æ ·é€šè¿‡ @xxx å¯ä»¥æ‰“å¼€å¯¹åº”æ–‡çŒ®çš„ PDF æ–‡ä»¶ã€‚

æˆ‘è®¾ç½®äº† ~z m~ è°ƒç”¨ ~orb-note-actions~. ä¸»è¦ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æ‰“å¼€å¯¹åº”æ–‡çŒ®ç¬”è®°çš„ PDF æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡ scrapper æ¥è·å– PDF æ–‡ä»¶çš„å¼•æ–‡ä¿¡æ¯ã€‚

ä½¿ç”¨ scrapper åŠŸèƒ½éœ€è¦å®‰è£… [[https://github.com/inukshuk/anystyle][inukshuk/anystyle: Fast and smart citation reference parsing]], ~[sudo] gem install anystyle-cli~.

è¿™æ ·æ–‡çŒ®æ£€ç´¢å°±æœ‰äº†å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡å·±æœ‰çš„æ–‡çŒ®æ¥æŸ¥æ‰¾æ–‡çŒ®ï¼Œè¿™ä¹Ÿæ˜¯é˜…è¯»æ–‡çŒ®çš„ä¸€ä¸ªé‡è¦æ–¹æ³•ã€‚åˆ«äººå¼•ç”¨äº†å•¥ï¼Œæ¡é‡è¦çš„çœ‹å“ˆã€‚
#+begin_src emacs-lisp
  (use-package org-roam-bibtex
    :commands orb-note-actions)

  (with-eval-after-load 'evil
    (evil-define-key 'normal 'org-mode-map
      "zm" 'orb-note-actions))
#+end_src
*** ebib
Ebib æ˜¯ Emacs ä¸­çš„æ–‡çŒ®ç®¡ç†è½¯ä»¶ï¼Œç±»ä¼¼äº zotero, ä½†æ˜¯æˆ‘æ„Ÿè§‰ Zotero æ›´å¼ºä¸€äº›ï¼Œä½†æ˜¯ Zotero å ç”¨çš„å†…å­˜å®åœ¨æ˜¯å¤§ï¼ŒMacOS ä¸Šçº¦æœ‰ä¸€ä¸ªG.

ç›¸æ¯”è¾ƒè€Œè¨€ï¼ŒEmacs æ•´ä¸ªå ç”¨çš„å†…å­˜æ‰å‡ ç™¾å…†ã€‚

æˆ‘ä¿ç•™ Ebib çš„åŸå› æ˜¯å®ƒå¯ä»¥ä»ä¸» bibtex æ–‡ä»¶ä¸­æå–æ–‡ç« éœ€è¦çš„æ–‡çŒ®å†…å®¹ã€‚

å…·ä½“çš„ä½¿ç”¨è§ï¼š[[https://joostkremers.github.io/ebib/ebib-manual.html#main-and-dependent-databases][Ebib Manual]]

é¦–å…ˆåˆ›å»ºä¸€ä¸ª dependent database ~M c~, ç„¶åä½¿ç”¨ ~M a~ æŠŠ main database ä¸­çš„å¼•æ–‡æ·»åŠ åˆ° dependent database ä¸­ã€‚
#+begin_src emacs-lisp
  (use-package ebib
    :bind ("<f2>" . ebib)
    :config
    (setq ebib-preload-bib-files org-cite-global-bibliography)

    (setq ebib-keywords (concat org-roam-directory "/bibtexs/keywords.txt"))
    (setq ebib-notes-directory (concat org-roam-directory "/ref"))
    (setq ebib-filters-default-file (concat org-roam-directory "/bibtexs/ebib-filters"))
    (setq ebib-reading-list-file (concat org-roam-directory "/bibtexs/reading_list.org"))

    (setq ebib-keywords-field-keep-sorted t)
    (setq ebib-keywords-file-save-on-exit 'always)

    (setq ebib-index-columns
          '(("Entry Key" 30 t) ("Note" 1 nil) ("Year" 6 t) ("Title" 50 t)))
    (setq ebib-file-associations '(("ps" . "gv"))))
#+end_src
*** COMMENT persid
[[https://github.com/rougier/persid/tree/master/][rougier/persid: Persistent identifier library for GNU Emacs]] å…·æœ‰å’Œ biblio ç›¸ä¼¼çš„åŠŸèƒ½ã€‚å½“å·±çŸ¥ ISBN æˆ– DOI çš„æ—¶å€™å¯ä»¥ç”¨äºè·å– bibtex å¼•æ–‡ã€‚

*** scihub
å½“æœ‰äº† DOI ä¹‹åæƒ³è¦ä¸‹è½½æ–‡çŒ®ï¼Œå¯ä»¥ä½¿ç”¨ scihub è¿™ä¸ªé€šè¿‡ scihub ä¸‹è½½ã€‚è‹¥æ²¡æœ‰æºçš„è¯å†æƒ³å…¶ä»–çš„æ–¹å¼ã€‚

ä½¿ç”¨ scihub éœ€è¦æä¾› DOI æˆ–è€…å®Œæ•´çš„æ–‡çŒ®é¢˜ç›®ã€‚
#+begin_src emacs-lisp
  (use-package scihub
    :commands scihub
    :config
    (setq scihub-download-directory "~/Downloads/")
    (setq scihub-open-after-download t)
    (setq scihub-fetch-domain 'scihub-fetch-domains-lovescihub))
#+end_src

*** biblio
æ–‡çŒ®çš„æŸ¥æ‰¾ç›®å‰æœ‰å¤šç§æ–¹å¼ï¼Œå¦‚å¯ä»¥ä½¿ç”¨ biblio è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¸¸ç”¨çš„æœ‰ crossfer-lookup.

æˆ‘é»˜è®¤ä½¿ç”¨ crossref ä½œä¸ºåç«¯ï¼Œé€šè¿‡ ~SPC n r d~ è°ƒç”¨ï¼Œè‹¥è¦ä½¿ç”¨å…¶ä»–çš„åç«¯ï¼Œé€šè¿‡ ~M-x biblio-lookup~ è¿›è¡Œã€‚
#+begin_src emacs-lisp
  (use-package biblio
    :commands biblio-lookup
    :general
    (:states 'normal
             "SPC rd" 'my/biblio-lookup-crossref :no-autoload t)
    :preface
    (defun my/biblio-lookup-crossref ()
      (interactive)
      (biblio-lookup 'biblio-crossref-backend)))

  (my/space-leader-def
    "rd" '(my/biblio-lookup-crossref :wk "Get bib from crossfer"))
#+end_src
** latex
å‚è€ƒèµ„æ–™ï¼š[[https://gist.github.com/karthink/7d89df35ee9b7ac0c93d0177b862dadb][fast latex input]].

Latex å¯ä»¥ç»“åˆ eglot ä½¿ç”¨ï¼Œæœ‰å¤šä¸ª server å¯ä»¥ä½¿ç”¨ï¼Œ =digestif= å’Œ =texlab=ï¼Œæˆ‘ä½¿ç”¨å‰è€…ã€‚
*** Auctex
Auctex è‹¥é€šè¿‡æºæ–‡ä»¶å®‰è£…ï¼Œéœ€è¦å…ˆå°†å…¶å…‹éš†åˆ°æœ¬åœ°ï¼Œç„¶åæ‰§è¡Œï¼š
#+begin_src shell
  ./autogen.sh
  ./configure
  make
  sudo make install
#+end_src
emacs ä¸Šæœ‰ =latex-mode= å’Œ =LaTeX-mode= ä¸¤ä¸ªï¼Œä½¿ç”¨å“ªä¸ªå–å†³äºæ˜¯å¦å®‰è£…äº† =auctex= è¿™ä¸ªåŒ…ã€‚è‹¥æœ‰ï¼Œä½¿ç”¨ =LaTex-mode= å°±å¥½ã€‚
#+begin_src emacs-lisp
  (use-package tex
    :mode (".tex" . LaTeX-mode)
    :init
    (load "auctex.el" nil t t)
    (load "preview-latex.el" nil t t)
    :config
    (setq TeX-auto-save t)
    (setq TeX-parse-self t)
    (setq TeX-save-query nil)
    (setq TeX-electric-sub-and-superscript t)
    (setq TeX-auto-local ".auctex-auto")
    (setq TeX-style-local ".auctex-style")
    (setq TeX-source-correlate-mode t)
    (setq TeX-source-correlate-method 'synctex)
    (setq TeX-source-correlate-start-server nil)

    (setq-default TeX-master t)
    (add-to-list 'TeX-command-list '("XeLaTeX" "%`xelatex%(mode)%' %t" TeX-run-TeX nil t))
    (add-to-list 'TeX-view-program-selection '(output-pdf "PDF Tools"))
    (add-to-list 'TeX-view-program-list '("PDF Tools" TeX-pdf-tools-sync-view))
    (add-hook 'TeX-after-compilation-finished-functions #'TeX-revert-document-buffer))

  (use-package latex
    :bind (:map LaTeX-mode-map
                ("C-c h" . TeX-doc)))
#+end_src
*** fontification
[[https://tex.stackexchange.com/questions/85849/auctex-new-commands-recognized-as-such/86119#86119][macros - AUCTeX â€“ new commands recognized as such - TeX - LaTeX Stack Exchange]].
#+begin_src emacs-lisp
  (use-package font-latex
    :after tex
    :config
    (setq font-latex-match-reference-keywords
          '(;; BibLaTeX.
            ("printbibliography" "[{")
            ("addbibresource" "[{")
            ;; Standard commands.
            ("cite" "[{")
            ("citep" "[{")
            ("citet" "[{")
            ("Cite" "[{")
            ("parencite" "[{")
            ("Parencite" "[{")
            ("footcite" "[{")
            ("footcitetext" "[{")
            ;; Style-specific commands.
            ("textcite" "[{")
            ("Textcite" "[{")
            ("smartcite" "[{")
            ("Smartcite" "[{")
            ("cite*" "[{")
            ("parencite*" "[{")
            ("supercite" "[{")
            ;; Qualified citation lists.
            ("cites" "[{")
            ("Cites" "[{")
            ("parencites" "[{")
            ("Parencites" "[{")
            ("footcites" "[{")
            ("footcitetexts" "[{")
            ("smartcites" "[{")
            ("Smartcites" "[{")
            ("textcites" "[{")
            ("Textcites" "[{")
            ("supercites" "[{")
            ;; Style-independent commands.
            ("autocite" "[{")
            ("Autocite" "[{")
            ("autocite*" "[{")
            ("Autocite*" "[{")
            ("autocites" "[{")
            ("Autocites" "[{")
            ;; Text commands.
            ("citeauthor" "[{")
            ("Citeauthor" "[{")
            ("citetitle" "[{")
            ("citetitle*" "[{")
            ("citeyear" "[{")
            ("citedate" "[{")
            ("citeurl" "[{")
            ;; Special commands.
            ("fullcite" "[{")
            ;; Cleveref.
            ("cref" "{")
            ("Cref" "{")
            ("cpageref" "{")
            ("Cpageref" "{")
            ("cpagerefrange" "{")
            ("Cpagerefrange" "{")
            ("crefrange" "{")
            ("Crefrange" "{")
            ("labelcref" "{")))

    (setq font-latex-match-textual-keywords
          '(;; BibLaTeX brackets.
            ("parentext" "{")
            ("brackettext" "{")
            ("hybridblockquote" "[{")
            ;; Auxiliary commands.
            ("textelp" "{")
            ("textelp*" "{")
            ("textins" "{")
            ("textins*" "{")
            ;; Subcaption.
            ("subcaption" "[{")))

    (setq font-latex-match-variable-keywords
          '(;; Amsmath.
            ("numberwithin" "{")
            ;; Enumitem.
            ("setlist" "[{")
            ("setlist*" "[{")
            ("newlist" "{")
            ("renewlist" "{")
            ("setlistdepth" "{")
            ("restartlist" "{")
            ("crefname" "{"))))
#+end_src
*** COMMENT evil-tex
#+begin_src emacs-lisp
  (add-hook 'LaTeX-mode-hook #'evil-tex-mode)
#+end_src
*** COMMENT latex-preview-pane
#+begin_src emacs-lisp
  (setq latex-preview-pane-multifile-mode 'auctex)

  (add-hook 'LaTeX-mode-hook 'latex-preview-pane-enable)
#+end_src
*** cdlatex
#+begin_src emacs-lisp
  (use-package cdlatex
    :hook ((LaTeX-mode . turn-on-cdlatex)
           (org-mode . org-cdlatex-mode)))
#+end_src

*** Reftex
#+begin_src emacs-lisp
  (use-package reftex
    :hook ((LaTeX-mode . turn-on-reftex)
           (reftex-toc-mode . menu-bar--visual-line-mode-enable))
    :config
    (setq reftex-toc-split-windows-horizontally t)
    (setq reftex-toc-split-windows-fraction 0.25))

  (add-to-list 'display-buffer-alist '("\\*toc\\*"
                                       (display-buffer-reuse-window)
                                       (side . left)
                                       (window-parameters
                                        (mode-line-format . none)
                                        (delete-other-windows . t))))
#+end_src
*** ox-latex
#+begin_src emacs-lisp
  (use-package org
    :config
    (setq org-highlight-latex-and-related '(latex script)))

  (use-package ox-latex
    :defer 3
    :config
    (setq org-latex-src-block-backend 'minted)
    (setq org-latex-minted-options '(("breaklines" "true")
                                     ("breakanywhere" "true")))

    (setq org-latex-classes nil)
    (add-to-list 'org-latex-classes
                 '("book"
                   "\\documentclass[UTF8,twoside,a4paper,12pt,openright]{ctexrep}
                     [NO-DEFAULT-PACKAGES]
                     [NO-PACKAGES]
                     [EXTRA]"
                   ("\\chapter{%s}" . "\\chapter*{%s}")
                   ("\\section{%s}" . "\\section*{%s}")
                   ("\\subsection{%s}" . "\\subsection*{%s}")
                   ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                   ("\\paragraph{%s}" . "\\paragraph*{%s}")
                   ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

    (add-to-list 'org-latex-classes '("article-cn" "\\documentclass{ctexart}
                                        [NO-DEFAULT-PACKAGES]
                                        [NO-PACKAGES]
                                        [EXTRA]"
                                      ("\\section{%s}" . "\\section*{%s}")
                                      ("\\subsection{%s}" . "\\subsection*{%s}")
                                      ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                                      ("\\paragraph{%s}" . "\\paragraph*{%s}")
                                      ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

    (add-to-list 'org-latex-classes '("article" "\\documentclass[11pt]{article}
                                        [NO-DEFAULT-PACKAGES]
                                        [NO-PACKAGES]
                                        [EXTRA]"
                                      ("\\section{%s}" . "\\section*{%s}")
                                      ("\\subsection{%s}" . "\\subsection*{%s}")
                                      ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                                      ("\\paragraph{%s}" . "\\paragraph*{%s}")
                                      ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
    (add-to-list 'org-latex-classes '("beamer" "\\documentclass[presentation]{beamer}
                                        [DEFAULT-PACKAGES]
                                        [PACKAGES]
                                        [EXTRA]"
                                      ("\\section{%s}" . "\\section*{%s}")
                                      ("\\subsection{%s}" . "\\subsection*{%s}")
                                      ("\\subsubsection{%s}" . "\\subsubsection*{%s}")))

    (setq org-latex-pdf-process
          '("xelatex -8bit --shell-escape  -interaction=nonstopmode -output-directory %o %f"
            "bibtex -shell-escape %b"
            "xelatex -8bit --shell-escape  -interaction=nonstopmode -output-directory %o %f"
            "xelatex -8bit --shell-escape  -interaction=nonstopmode -output-directory %o %f"
            "rm -fr %b.out %b.log %b.tex %b.brf %b.bbl"))

    (setq org-latex-logfiles-extensions '("lof" "lot" "tex~" "aux" "idx" "log"
                                          "out" "toc" "nav" "snm" "vrb" "dvi"
                                          "fdb_latexmk" "blg" "brf" "fls"
                                          "entoc" "ps" "spl" "bbl"))

    (setq org-latex-prefer-user-labels t))
#+end_src
*** COMMENT Math symbol
#+begin_src emacs-lisp :tangle no
  (add-hook 'LaTeX-mode-hook
            (lambda ()
              (setq-local company-backends
                          (append '((company-math-symbols-latex company-latex-commands))
                                  company-backends))))
  (add-hook 'org-mode-hook
            (lambda ()
              (setq-local company-backends
                          (append '((company-math-symbols-latex company-latex-commands))
                                  company-backends))))
#+end_src
*** COMMENT company-math
#+begin_src emacs-lisp :tangle no
  ;; global activation of the unicode symbol completion
  ;; company-math
  (with-eval-after-load 'company
    (add-to-list 'company-backends 'company-math-symbols-unicode))
#+end_src
*** COMMENT company-auctex
#+begin_src emacs-lisp :tangle no
  (add-hook 'company-mode-hook 'company-auctex-init)

  (defun company-bibtex-completion-candidates ()
    (let ((bibtex-completion-bibliography
           (or (bibtex-completion-find-local-bibliography)
               bibtex-completion-bibliography)))
      (mapcar (lambda (x) (propertize (cdr (assoc "=key=" (cdr x)))
                                      'bibtex-completion-annotation
                                      (cdr (assoc "title" (cdr x)))))
              (bibtex-completion-candidates))))

  (defun company-bibtex-completion (command &optional arg &rest ignored)
    "bibtex-completion backend."
    (interactive (list 'interactive))
    (cl-case command
      (interactive (company-begin-backend 'company-bibtex-completion))
      (prefix (let ((prefixes
                     (cond ((derived-mode-p 'latex-mode)
                            (company-auctex-prefix "\\\\cite[^[{]*\\(?:\\[[^]]*\\]\\)?{\\([^}]*\\)\\="))
                           ((and (derived-mode-p 'org-mode)
                                 (not (org-in-src-block-p))
                                 (looking-back "cite:\\([^}]*\\)"))
                            (match-string-no-properties 1))
                           (t nil))))
                (if prefixes
                    (last (split-string prefixes "," t))
                  nil)))
      (candidates (all-completions arg (company-bibtex-completion-candidates)))
      (annotation (get-text-property 0 'bibtex-completion-annotation arg))))

  (add-to-list 'company-backends #'company-bibtex-completion)
#+end_src
*** auctex-latexmk
[[https://github.com/tom-tan/auctex-latexmk][tom-tan/auctex-latexmk: This library adds LatexMk support to AUCTeX.]]
æœ€æ–°çš„ auctex ä¸èƒ½ä½¿ç”¨æ­¤å¤„çš„åŒ…æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ [[https://github.com/emacsmirror/auctex-latexmk][emacsmirror/auctex-latexmk: Add LatexMk support to AUCTeX]] æ›¿ä»£ã€‚
#+begin_src emacs-lisp
  (use-package auctex-latexmk
    :hook (LaTeX-mode . auctex-latexmk-setup))
#+end_src
*** ox-beamer
#+begin_src emacs-lisp
  (use-package ox-beamer
    :defer 3
    :after org)
#+end_src
*** COMMENT org-elp
https://emacs-china.org/t/retina-osx-ei-10-11-3-emacs-org-mode-latex-preview/77/7
#+begin_src emacs-lisp
    (setq org-format-latex-options '(:foreground default
                                                 :background default
                                                 :scale 4.0
                                                 :html-foreground "Black"
                                                 :html-background "Transparent"
                                                 :html-scale 1.0
                                                 :matchers ("begin" "$1" "$" "$$" "\\(" "\\[")))
    (setq org-latex-create-formula-image-program 'dvisvgm)
#+end_src
** Blog
ä½¿ç”¨ org-mode å†™ blog æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨ ox-hugo, å¦å¤–ä¸€ä¸ªå°±æ˜¯ä½¿ç”¨ org-publish.

è¿™ä¸¤ä¸ªéƒ½å¯ä»¥åŸºäº github å»ºç«‹è‡ªå·±çš„åšå®¢ã€‚

ä½¿ç”¨ deft ç®¡ç†è‡ªå·±çš„å†™ä½œï¼ŒåŸå…ˆæƒ³ä½¿ç”¨ denote è¿›è¡Œï¼Œä½†æ˜¯ denote åˆ›å»ºçš„æ–‡ä»¶åè¿‡é•¿ï¼Œä¼šå¯¼è‡´ [[https://codeberg.org/ideasman42/emacs-undo-fu-session][undo-fu-session]] æŠ¥ ~file name too long~ çš„é”™è¯¯ã€‚

å‘ç°ä½¿ç”¨ [[consult-notes]] æ¯” deft å¥½ç”¨ã€‚Deft é»˜è®¤åˆ›å»ºçš„æ–‡ä»¶åæ˜¯ä¸€ä¸²æ—¥æœŸæ ¼å¼ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ title ç›´è§‚ã€‚è™½ç„¶å¯ä»¥ä½¿ç”¨ deft æä¾›çš„ç•Œé¢æŸ¥æ‰¾æ–‡ä»¶ï¼Œä½†æ˜¯ä¸èƒ½ç»“åˆ vertico ç›´æ¥ä½¿ç”¨æ‹¼éŸ³è¿›è¡Œä¸­æ–‡çš„æ£€ç´¢ã€‚
*** ox-hugo
#+begin_src emacs-lisp
  (use-package ox-hugo
    :defer 3
    :after ox)
#+end_src
*** ox-html
#+begin_src emacs-lisp
  (use-package ox-html
    :after ox
    :config
    (setq org-html-preamble t)
    (setq org-html-preamble-format
          '(("en" "<a href=\"/index.html\" class=\"button\">Home</a>
                 <a href=\"/notes/index.html\" class=\"button\">Notes</a>
                 <a href=\"/engineering/index.html\" class=\"button\">Engineering</a>
                 <a href=\"/movies/index.html\" class=\"button\">Movies</a>
                 <a href=\"/books/index.html\" class=\"button\">Books</a>
                 <a href=\"/about.html\" class=\"button\">About</a>
                 <hr>")))

    (setq org-html-postamble t)

    (setq org-html-postamble-format
          '(("en" "<hr><div class=\"generated\">Created with %c on MacOS</div>")))

    (setq org-html-head-include-default-style nil)

    (setq org-html-head
          "<link rel=\"stylesheet\" type=\"text/css\" href=\"../css/style.css\" />"))
#+end_src
*** ox-publish
#+begin_src emacs-lisp
  (use-package ox-publish
    :after ox
    :config
    (defvar my/publish-directory "~/shuyi.github.io")

    (setq org-publish-project-alist
          `(("site"
             :base-directory ,website-directory
             :base-extension "org"
             :recursive nil
             :publishing-directory ,my/publish-directory
             :publishing-function org-html-publish-to-html)

            ("notes"
             :base-directory ,(expand-file-name "notes" website-directory)
             :base-extension "org"
             :publishing-directory ,(expand-file-name "notes" my/publish-directory)
             :publishing-function org-html-publish-to-html
             :auto-sitemap t
             :sitemap-filename "index.org"
             :sitemap-title "Notes"
             :sitemap-sort-files anti-chronologically)
            ("books"
             :base-directory ,(expand-file-name "books" website-directory)
             :base-extension "org"
             :publishing-directory ,(expand-file-name "books" my/publish-directory)
             :publishing-function org-html-publish-to-html
             :auto-sitemap t
             :sitemap-filename "index.org"
             :sitemap-title "Books"
             :sitemap-sort-files anti-chronologically)
            ("movies"
             :base-directory ,(expand-file-name "movies" website-directory)
             :base-extension "org"
             :publishing-directory ,(expand-file-name "movies" my/publish-directory)
             :publishing-function org-html-publish-to-html
             :auto-sitemap t
             :sitemap-filename "index.org"
             :sitemap-title "Movies"
             :sitemap-sort-files anti-chronologically)
            ("engineering"
             :base-directory ,(expand-file-name "engineering" website-directory)
             :base-extension "org"
             :publishing-directory ,(expand-file-name "engineering" my/publish-directory)
             :publishing-function org-html-publish-to-html
             :auto-sitemap t
             :sitemap-filename "index.org"
             :sitemap-title "Engineering"
             :sitemap-sort-files anti-chronologically)
            ("static"
             :base-directory ,website-directory
             :base-extension "css\\|txt\\|jpg\\|gif\\|png"
             :recursive t
             :publishing-directory  ,my/publish-directory
             :publishing-function org-publish-attachment)

            ("personal-website" :components ("site" "notes" "books"
                                             "movies" "engineering" "static")))))
#+end_src
** COMMENT org-present
[[https://xenodium.com/emacs-org-present-in-style/][Emacs: org-present in style]]
* Applications
** Browser
#+begin_src emacs-lisp
  ;; eww
  ;; Install readability first.
  ;; npm install -g readability-cli
  ;; (setq eww-retrieve-command '("readable"))

  ;; Another choice `websearch'.
  ;; Search engine
  (use-package engine-mode
    :hook (on-first-input . engine-mode)
    :config
    (defengine google "https://google.com/search?q=%s"
               :keybinding "g"
               :docstring "Search Google.")
    (defengine wikipedia "https://en.wikipedia.org/wiki/Special:Search?search=%s"
               :keybinding "w"
               :docstring "Search Wikipedia.")
    (defengine github "https://github.com/search?ref=simplesearch&q=%s"
               :keybinding "h"
               :docstring "Search GitHub.")
    (defengine youtube "http://www.youtube.com/results?aq=f&oq=&search_query=%s"
               :keybinding "y"
               :docstring "Search YouTube.")
    (defengine moviedouban "https://search.douban.com/movie/subject_search?search_text=%s"
               :keybinding "m"
               :docstring "Search Moive DouBan.")
    (defengine bookdouban "https://search.douban.com/book/subject_search?search_text=%s"
               :keybinding "b"
               :docstring "Search Book DouBan.")
    (defengine zhihu "https://www.zhihu.com/search?type=content&q=%s"
               :keybinding "z"
               :docstring "Search Zhihu."))

  (my/comma-leader-def
    "s" '(:ignore t :wk "Search")
    "sb" '(engine/search-bookdouban :wk "Book DouBan")
    "ss" '(engine/search-google :wk "Google")
    "sg" '(engine/search-github :wk "Github")
    "sy" '(engine/search-youtube :wk "Youtube")
    "sw" '(engine/search-wikipedia :wk "Wikipedia")
    "sm" '(engine/search-moviedouban :wk "Movie DouBan")
    "sz" '(engine/search-zhihu :wk "Zhihu")
    "sr" '(rg :wk "rg")
    "sl" '(consult-git-log-grep :wk "Git Log Grep"))
#+end_src

[[https://github.com/xuchunyang/grab-mac-link.el][xuchunyang/grab-mac-link.el: Grab link from Mac Apps and insert it into Emacs]]. å¾ˆæ–¹ä¾¿çš„åœ¨æ–‡ä»¶ä¸­å¢åŠ å½“å‰æµè§ˆç½‘é¡µçš„é“¾æ¥ï¼Œæˆ‘ä½¿ç”¨ MacOS, å¸¸ç”¨çš„æ˜¯ Safari æµè§ˆå™¨ã€‚

#+begin_src emacs-lisp
  (use-package grab-mac-link
    :commands grab-mac-link-dwim
    :preface
    (defun my/link-grab ()
      (interactive)
      (grab-mac-link-dwim 'safari))
    :bind ("<f8>" . my/link-grab))
#+end_src
** Elfeed
[[https://github.com/skeeto/elfeed][https://github.com/skeeto/elfeed]]
#+begin_src emacs-lisp
  (use-package elfeed
    :bind ("C-c , r" . elfeed)
    :preface
    (defun elfeed-display-buffer (buf &optional act)
      (pop-to-buffer buf '((display-buffer-reuse-window display-buffer-in-side-window)
                           (side . bottom)
                           (window-height . 0.8)
                           (reusable-frames . visible)
                           (window-parameters
                            (select . t)
                            (quit . t)
                            (popup . t)))))
    :config
    (setq elfeed-show-entry-switch #'elfeed-display-buffer))

  (my/comma-leader-def
    "r" '(elfeed-summary :wk "Elfeed"))

  (add-to-list 'display-buffer-alist
               `(,(rx (| "*elfeed-search*"
                         "*elfeed-summary*"
                         "*elfeed-entry-"))
                 (display-buffer-in-tab)
                 (tab-name . "RSS")
                 (tab-group . "RSS")
                 (window-parameters . ((mode-line-format . none)))))

#+end_src
*** elfeed-org
[[https://github.com/remyhonig/elfeed-org][remyhonig/elfeed-org: Configure the Elfeed RSS reader with an Orgmode file]] é€šè¿‡ org é›†ä¸­ç®¡ç† elfeed æºã€‚
#+begin_src emacs-lisp
  (use-package elfeed-org
    :after elfeed
    :init
    (setq rmh-elfeed-org-files `(,(concat my-galaxy "/rss/elfeed.org"))))

  (defun my/rss-source ()
    "Open elfeed config file."
    (interactive)
    (find-file (car rmh-elfeed-org-files)))

  (my/space-leader-def
    "foe" '(my/rss-source :wk "Elfeed file"))
#+end_src
*** elfeed-summary
[[https://github.com/SqrtMinusOne/elfeed-summary][SqrtMinusOne/elfeed-summary: Feed summary interface for elfeed]]
#+begin_src emacs-lisp
  (use-package elfeed-summary
    :bind ("C-c , r" . elfeed-summary)
    :config
    (setq elfeed-summary-other-window t)
    (setq elfeed-summary-settings
          '((group (:title . "ç§‘æŠ€")
                   (:elements (query . (and tec (not emacs) (not blogs)))
                              (group (:title . "Emacs")
                                     (:elements (query . emacs))
                                     (:face . org-level-1))
                              (group (:title . "Blogs")
                                     (:elements (query . blogs)))))
            (group (:title . "News")
                   (:elements (query . news)))
            (group (:title . "Books")
                   (:elements (query . book)))
            (group (:title . "Finance")
                   (:elements (query . finance)))
            (group (:title . "Youtube")
                   (:elements (query . video)))))

    (advice-add 'elfeed-summary :after 'elfeed-summary-update)
    (advice-add 'elfeed-summary :before 'elfeed-org))
#+end_src

[[https://github.com/karthink/elfeed-tube][karthink/elfeed-tube: Youtube integration for Elfeed, the feed reader for Emacs]] ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸èƒ½æ›´æ–° RSS. æš‚æ—¶åœç”¨äº†ã€‚
#+begin_src emacs-lisp :tangle no
  (with-eval-after-load 'elfeed
    (require 'elfeed-tube)
    (elfeed-tube-setup)

    (define-key elfeed-show-mode-map (kbd "F") 'elfeed-tube-fetch)
    (define-key elfeed-show-mode-map [remap save-buffer] 'elfeed-tube-save)
    (define-key elfeed-search-mode-map (kbd "F") 'elfeed-tube-fetch)
    (define-key elfeed-search-mode-map [remap save-buffer] 'elfeed-tube-save)

    (require-package 'elfeed-tube-mpv)
    (with-eval-after-load 'elfeed
      (require 'elfeed-tube-mpv)
      (define-key elfeed-show-mode-map (kbd "C-c C-f") 'elfeed-tube-mpv-follow-mode)
      (define-key elfeed-show-mode-map (kbd "C-c C-w") 'elfeed-tube-mpv-where)))
#+end_src
** Reader
*** pdf-tools
å‡çº§ pdf-tools åè¦é‡æ–°ç”Ÿæˆ =epdfinfo= æ–‡ä»¶ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯é‡è£… pdf-toolsï¼Œä»¥å…æœ‰é—®é¢˜ã€‚

#+begin_src emacs-lisp
  (use-package pdf-tools
    :hook ((doc-view-mode . pdf-tools-install)
           (dirvish-setup . pdf-tools-install)
           (pdf-tools-enabled . pdf-view-themed-minor-mode)))

  (use-package pdf-view
    :mode ("\\.[pP][dD][fF]\\'" . pdf-view-mode)
    :magic ("%PDF" . pdf-view-mode)
    :config
    (pdf-tools-install t nil t nil)
    (evil-declare-key 'normal pdf-view-mode-map
      "gh" 'pdf-annot-add-highlight-markup-annotation
      "ga" 'pdf-annot-add-text-annotation
      "gd" 'pdf-annot-delete)
    :init
    (setq pdf-view-display-size 'fit-width)
    (setq pdf-view-use-unicode-ligther nil)
    (setq pdf-view-use-scaling t)
    (setq pdf-view-use-imagemagick nil)
    (setq pdf-annot-activate-created-annotations nil))

  (add-to-list 'display-buffer-alist '("\\.pdf"
                                       (display-buffer-in-tab)
                                       (tab-name . "PDF")
                                       (tab-group . "PDF")))
  (use-package pdf-occur
    :hook (pdf-view-mode . pdf-occur-global-minor-mode))

  (use-package pdf-history
    :hook (pdf-view-mode . pdf-history-minor-mode))

  (use-package pdf-links
    :hook (pdf-view-mode . pdf-links-minor-mode))

  (defun my/get-file-name ()
    "Copy pdf file name."
    (interactive)
    (kill-new (file-name-base (buffer-file-name)))
    (message "Copied %s" (file-name-base (buffer-file-name))))

  (use-package pdf-outline
    :hook (pdf-view-mode . pdf-outline-minor-mode)
    :bind (:map pdf-outline-buffer-mode-map
                ("RET" . pdf-outline-follow-link-and-quit)))

  (add-to-list 'display-buffer-alist '("\\*Outline"
                                       (display-buffer-in-side-window)
                                       (side . right)
                                       (window-width . 0.5)
                                       (window-parameters
                                        (mode-line-format . none))))
  (use-package pdf-annot
    :hook (pdf-view-mode . pdf-annot-minor-mode)
    :bind (:map pdf-annot-edit-contents-minor-mode-map
                ("<return>" . pdf-annot-edit-contents-commit)
                ("<S-return>" . newline)))

  (use-package pdf-sync
    :hook (pdf-view-mode . pdf-sync-minor-mode))

  (use-package pdf-cache
    :after pdf-view
    :config
    (define-pdf-cache-function pagelabels))

  (use-package pdf-misc
    :after pdf-view
    :config
    (setq pdf-misc-print-program-executable "/usr/bin/lp")

    (defun mrb/pdf-misc-print-pages(filename pages &optional interactive-p)
      "Wrapper for `pdf-misc-print-document` to add page selection support."
      (interactive (list (pdf-view-buffer-file-name)
                         (read-string "Page range (empty for all pages): "
                                      (number-to-string (pdf-view-current-page)))
                         t) pdf-view-mode)
      (let ((pdf-misc-print-program-args
             (if (not (string-blank-p pages))
                 (cons (concat "-P " pages) pdf-misc-print-program-args)
               pdf-misc-print-program-args)))
        (pdf-misc-print-document filename)))
    :bind (:map pdf-view-mode-map
                ([remap pdf-misc-print-document] . mrb/pdf-misc-print-pages)))
#+end_src

#+begin_src emacs-lisp
  (defun my/pdf-extract-highlight ()
    "Extract highlight to plain text.
  When it finised, it will jump to note file."
    (interactive)
    (let* ((pdf-filename (buffer-name))
           (txt-filename (make-temp-name "/tmp/annot-"))
           (org-file (read-file-name "Save extracted highlights to org file: " (expand-file-name "roam/ref/" my-galaxy)))
           (org-heading "Highlights")
           (process (start-process-shell-command
                     "pdfannots"
                     nil
                     (format "python3 ~/pdfannots/pdfannots.py \"%s\" -o \"%s\""
                             pdf-filename txt-filename))))
      (set-process-sentinel
       process
       (lambda (process _event)
         (when (eq (process-status process) 'exit)
           (find-file org-file)
           (goto-char (point-min))
           (if (re-search-forward (format "^* %s" org-heading) nil t)
               (progn
                 (end-of-line)
                 (insert "\n")
                 (insert-file-contents txt-filename)
                 (delete-file txt-filename)
                 (message "PDF highlights added to org heading '%s'" org-heading))
             (message "Org heading '%s' not found" org-heading)))))))

  (my/comma-leader-def
    "h" '(my/pdf-extract-highlight :wk "Extract highlight"))
#+end_src
#+begin_src emacs-lisp
  (defun my/dired-pdf-to-png ()
    (interactive)
    (let* ((filename (dired-get-filename)))
      (if (string-match "\.pdf" filename)
          (let* ((pdf-base-name (file-name-sans-extension (file-name-nondirectory filename)))
                 (png (concat pdf-base-name ".png"))
                 (pdf-info (shell-command-to-string (format "pdfinfo %s | grep Pages | awk '{print $2}'" filename)))
                 (pdf-pages (string-to-number pdf-info)))
            (when (file-exists-p png)
              (delete-file png))
            (if (= pdf-pages 1)
                (start-process-shell-command
                 "pdf-to-png"
                 nil
                 (format "pdftoppm -singlefile -r 600 %s %s -png" filename pdf-base-name))
              (start-process-shell-command
               "pdf-to-png"
               nil
               (format "pdftoppm -r 600 %s %s -png" filename pdf-base-name))))
        (message "Current file is not a PDF file."))))
#+end_src
*** COMMENT saveplace-pdf-view

*** Nov
Nov ç”¨äºé˜…è¯» epub æ–‡ä»¶ã€‚
#+begin_src emacs-lisp
  (use-package nov
    :mode (".epub" . nov-mode)
    :config
    (setq nov-unzip-program (executable-find "bsdtar")
          nov-unzip-args '("-xC" directory "-f" filename)))
#+end_src
*** Calibredb
Calibre ç”¨äºç®¡ç†ä¹¦ç±ï¼ŒCalibredb å¯ä»¥åœ¨ Emacs ä¸­ç®¡ç†è€Œä¸éœ€è¦æ‰“å¼€ Calibre è½¯ä»¶ã€‚
#+begin_src emacs-lisp
  ;; Export catalog need to use argument: set entry type to mixed, default is book.
  (use-package calibredb
    :bind (("<f1>" . calibredb)
           :map calibredb-search-mode-map
           ("C-c l" . calibredb-copy-as-org-link))
    :config
    (setq calibredb-root-dir "~/Nextcloud/L.Calibre/")
    (setq calibredb-db-dir (expand-file-name "metadata.db" calibredb-root-dir))
    (setq calibredb-add-delete-original-file t)
    (setq calibredb-size-show t)
    (setq calibredb-format-character-icons t)

    (setq calibredb-ref-default-bibliography (expand-file-name "calibre.bib" calibredb-root-dir))

    (evil-set-initial-state 'calibredb-search-mode 'emacs))
#+end_src
** vterm
ä½¿ç”¨[[https://github.com/akermu/emacs-libvterm][akermu/emacs-libvterm: Emacs libvterm integration]] æ›¿ä»£äº†å†…ç½®çš„ eshell.
#+begin_src emacs-lisp
  (use-package vterm
    :bind ("C-c , v" . toggle-vterm)
    :config
    (setq vterm-kill-buffer-on-exit t)
    (setq vterm-max-scrollback 5000)
    (add-to-list 'display-buffer-alist
                 '("\\*vterm\\*"
                   (display-buffer-in-side-window)
                   (window-height . 0.35)
                   (side . bottom)
                   (slot . -1)))
    (defun toggle-vterm ()
      "Toggle vterm on or off."
      (interactive)
      (if (get-buffer-window "*vterm*")
          (delete-window (get-buffer-window "*vterm*"))
        (progn
          (vterm)
          (evil-insert 1)))))

  (my/comma-leader-def
    "v" '(toggle-vterm :wk "vterm"))
#+end_src
** Mail
*** Personal Info
#+begin_src emacs-lisp
  (setq user-full-name "Duan Ning")
  (setq user-mail-address "duan_n@outlook.com")
#+end_src
*** Message
#+begin_src emacs-lisp
  (setq message-sendmail-envelope-from 'header)
  (setq message-kill-buffer-query nil)
  (setq message-sendmail-extra-arguments '("-a" "outlook"))
  (setq message-send-mail-function 'sendmail-send-it)
#+end_src
*** Mu4e
åœ¨ MacOS ä¸Šé…ç½® mu å’Œ mu4e çš„æ•™ç¨‹è§ï¼š[[https://macowners.club/posts/email-emacs-mu4e-macos/][Email setup in Emacs with Mu4e on macOS | macOS & (open-source) Software]].

ä¸Šè¿°çš„æ•™ç¨‹å†™çš„å¾ˆè¯¦ç»†ï¼ŒæŒ‰ç…§æ­¥éª¤è¿›è¡Œä¸€å®šä¼šæˆåŠŸã€‚

é…ç½® Emacs æ—¶ç»å¸¸è¦å¤šæ¬¡é‡å¯ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´ mu æŠ¥ä»¥ä¸‹çš„é”™è¯¯ï¼š
#+begin_quote
error in process sentinel: mu4e--server-sentinel: Mu server process ended with exit code 1
error in process sentinel: Mu server process ended with exit code 1
#+end_quote
è¿™æ—¶éœ€è¦åœ¨ç»ˆç«¯ä¸‹æ‰§è¡Œä»¥ä¸‹çš„å‘½ä»¤æ¥æ¢å¤ mu çš„çŠ¶æ€ã€‚
#+begin_src shell
  mu init --maildir=~/.maildir --my-address=your_email_account && mu index
#+end_src

å¯åŠ¨ Emacs æ—¶ç›´æ¥å¯åŠ¨ mu4e ä¼šå¯¼è‡´ Emacs å¯åŠ¨é€Ÿåº¦å˜çš„å¾ˆæ…¢ï¼Œå½“ Emacs å¤„äº idle çŠ¶æ€æ—¶åœ¨åå°å¯åŠ¨ã€‚
#+begin_src emacs-lisp
  (add-to-list 'load-path "/opt/homebrew/opt/mu/share/emacs/site-lisp/mu/mu4e")
  (unless (fboundp 'mu4e)
    (autoload #'mu4e "mu4e" nil t))

  (run-with-idle-timer 5 nil #'(lambda () (mu4e 'background)))
#+end_src

è¿™é‡Œæœ‰ä¸ª [[https://github.com/rougier/mu4e-dashboard][rougier/mu4e-dashboard: A dashboard for mu4e (mu for emacs)]] çœ‹ç€å¾ˆå¥½çœ‹ï¼Œä½†æ˜¯ä¸å®ç”¨ï¼Œä¸è¦å†å°è¯•ã€‚
#+begin_src emacs-lisp
  (with-eval-after-load 'mu4e
    (setq mail-user-agent 'mu4e-user-agent)
    (setq mu4e-mu-binary (executable-find "mu"))
    (setq mu4e-update-interval (* 15 60))
    (setq mu4e-attachment-dir "~/Downloads/")
    (setq mu4e-get-mail-command (concat (executable-find "mbsync") " -a"))
    (setq mu4e-index-update-in-background t)
    (setq mu4e-index-update-error-warning t)
    (setq mu4e-index-update-error-warning nil)
    (setq mu4e-index-cleanup t)
    (setq mu4e-view-show-images t)
    (setq mu4e-view-image-max-width 800)
    (setq mu4e-view-show-addresses t)
    (setq mu4e-confirm-quit nil)
    (setq mu4e-context-policy 'pick-first)
    (with-eval-after-load 'mu4e
      (setq mu4e-sent-folder   "/outlook/Sent"
            mu4e-drafts-folder "/outlook/Drafts"
            mu4e-trash-folder  "/outlook/Deleted"
            mu4e-refile-folder  "/outlook/Archive"))
    (setq mu4e-view-prefer-html nil)
    (setq mu4e-html2text-command 'mu4e-shr2text)
    (setq mu4e-main-hide-personal-addresses t)
    (setq mu4e-headers-precise-alignment t)
    (setq mu4e-headers-include-related t)
    (setq mu4e-headers-auto-update t)
    (setq mu4e-headers-date-format "%d/%m/%y")
    (setq mu4e-headers-time-format "%H:%M")
    (setq mu4e-headers-fields '((:flags . 4)
                                (:human-date . 9)
                                (:subject . 90)
                                (:from-or-to . 40)
                                (:tags . 20)))
    (setq mu4e-bookmarks '(("flag:unread AND NOT flag:trashed" "Unread messages" ?u)
                           ("date:today..now" "Today's messages" ?t)
                           ("date:7d..now" "Last 7 days" ?w)
                           ("date:1d..now AND NOT list:emacs-orgmode.gnu.org" "Last 1 days" ?o)
                           ("date:1d..now AND list:emacs-orgmode.gnu.org" "Last 1 days (org mode)" ?m)
                           ("maildir:/drafts" "drafts" ?d)
                           ("flag:flagged AND NOT flag:trashed" "flagged" ?f)
                           ("mime:image/*" "Messages with images" ?p)))
    (setq mu4e-compose-reply-ignore-address '("no-?reply" "duan_n@outlook.com"))
    (setq mu4e-compose-format-flowed nil)
    (setq mu4e-compose-signature-auto-include nil)
    (setq mu4e-compose-dont-reply-to-self t))
#+end_src
è‹¥è¦æŠŠ mail å’Œ org ç¬”è®°ç›¸ç»“åˆï¼Œå¯ä»¥ä½¿ç”¨ ~org-store-link~ å’Œ ~org-insert-link~ ç»™åˆä½¿ç”¨ï¼Œåœ¨ org æ–‡ä»¶ä¸­æ’å…¥ mail çš„é“¾æ¥ã€‚
#+begin_src emacs-lisp
  (with-eval-after-load 'mu4e
    (define-key mu4e-headers-mode-map (kbd "C-c l") 'org-store-link))
#+end_src
#+begin_src emacs-lisp
  (my/comma-leader-def
    "e" '(mu4e :wk "MAIL"))
#+end_src
#+begin_src emacs-lisp
  (add-to-list 'display-buffer-alist
               `(,(rx (| "*mu4e-main*"
                         "*mu4e-headers*"))
                 (display-buffer-in-tab)
                 (tab-name . "Mail")
                 (tab-group . "Mail")
                 (window-parameters . ((mode-line-format . none)))))
#+end_src
*** mu4e-actions
Save mail to pdf as backup.
#+begin_src emacs-lisp
  (defun extra-email-to-pdf (msg &optional args)
    "Pdf temp file MSG to a new name with ARGS ignored."
    (let* ((async-shell-command-display-buffer nil)
           (temp (format-time-string (expand-file-name "%Y-%m-%dT%H:%M.pdf" mail-source-directory)))
           (name (read-string "File name: " temp))
           (html (replace-regexp-in-string (regexp-quote "file://") "" msg t t)))
      (if args (message "Additional optional argument was ignored when saving to PDF."))
      (async-shell-command (concat "pandoc " html " -o " name))))

  (defun extra-print-email-to-pdf (msg &optional skip-headers)
    "Save current MSG as a pdf if it includes an HTML-part.
  If SKIP-HEADERS is set, do not show include message headers."
    (let* ((browse-url-browser-function  'extra-email-to-pdf))
      (mu4e-action-view-in-browser msg skip-headers)))
  (with-eval-after-load 'mu4e
    (add-to-list 'mu4e-view-actions '("print to PDF"  . extra-print-email-to-pdf)))
#+end_src
Save mail to html as backup.
#+begin_src emacs-lisp
  (defun extra-move-temp-email-location (msg &optional args)
    "Move and rename temp file MSG to a new location with ARGS ignored."
    (let* ((temp (format-time-string (expand-file-name "html/%Y-%m-%dT%H:%M.html" mail-source-directory)))
           (name (read-string "File name: " temp))
           (file (replace-regexp-in-string (regexp-quote "file://") "" msg t t)))
      (if args (message "Additional optional argument was ignored when saving to HTML."))
      (rename-file file name)))

  (defun extra-save-email-html (msg &optional skip-headers)
    "Save current MSG HTML-part.
  If SKIP-HEADERS is set, do not show include message headers."
    (let* ((extra-temp-email-dir (expand-file-name "html" mail-source-directory))
           (browse-url-browser-function  'extra-move-temp-email-location))
      (mu4e-action-view-in-browser msg skip-headers)))

  (with-eval-after-load 'mu4e
    (add-to-list 'mu4e-view-actions '("download as html"  . extra-save-email-html)))
#+end_src
*** Icons
#+begin_src emacs-lisp
  (with-eval-after-load 'all-the-icons
    (setq display-time-mail-icon `(,(propertize
                                     (all-the-icons-material "mail")
                                     'face `(:family ,(all-the-icons-material-family))))))

  (with-eval-after-load 'mu4e
    (setq mu4e-use-fancy-chars nil))
  ;; (require-package 'mu4e-marker-icons)
  ;; (add-hook 'mu4e-headers-mode-hook 'mu4e-marker-icons-mode)
#+end_src
*** COMMENT mu4e-alert
#+begin_src emacs-lisp
  (with-eval-after-load 'mu4e
    (mu4e-alert-set-default-style 'osx-notifier)
    (mu4e-alert-enable-notifications)
    (mu4e-alert-enable-mode-line-display))
#+end_src
*** COMMENT mu4e-column-faces
#+begin_src emacs-lisp
  (with-eval-after-load 'mu4e
    (mu4e-column-faces-mode))
#+end_src
*** Send mail
#+begin_src emacs-lisp
  (add-hook 'mu4e-main-mode-hook
            (lambda ()
              (progn
                (require 'smtpmail-async)
                (setq send-mail-function 'async-sendmail-send-it)
                (setq message-send-mail-function 'async-smtpmail-send-it))))
  (setq sendmail-program (executable-find "msmtp"))
  (setq mail-specify-envelope-from t)
  (setq mail-envelope-from 'header)
#+end_src
*** COMMENT org-msg
ä½¿ç”¨ [[https://github.com/jeremy-compostella/org-msg][jeremy-compostella/org-msg: OrgMsg is a GNU/Emacs global minor mode mixing up Org mode and Message mode to compose and reply to emails in a Outlook HTML friendly style.]] æ¥ç¼–å†™ Email.

éœ€è¦æ·»åŠ é™„ä»¶æ—¶æ‰§è¡Œ C-c C-a.
#+begin_src emacs-lisp
    (setq org-msg-options "html-preamble:nil html-postamble:nil toc:nil author:nil email:nil")
    (setq org-msg-greeting-fmt "\nHi%s,\n\n")
    (setq org-msg-recipient-names `(,user-mail-address . ,user-full-name))
    (setq org-msg-greeting-name-limit 3)
    (setq org-msg-default-alternatives '((new		. (text html))
                                         (reply-to-html	. (text html))
                                         (reply-to-text	. (text))))
    (setq org-msg-convert-citation t)

    (setq org-msg-signature (concat "Best Regards,\n\n#+begin_signature\n*"
                                    user-full-name
                                    "*\n\n" (format-time-string "%Y-%m-%d")
                                    "\n#+end_signature"))

    (add-hook 'mu4e-main-mode-hook 'org-msg-mode)
#+end_src

** Report
æˆ‘ä½¿ç”¨ [[Calibredb]] ç®¡ç†ä¹¦ç±ï¼Œä½¿ç”¨ org-roam ä¸‹çš„ books æ–‡ä»¶å¤¹ç®¡ç†è¯»ä¹¦ç¬”è®°å†…å®¹ã€‚å‡¡æ˜¯è¯»ä¹¦å¿…å»ºç«‹å¯¹åº”çš„ç¬”è®°å†…å®¹ï¼Œåœ¨ç¬”è®°å†…å®¹ä¸­ä¼šä½¿ç”¨ org-clock çš„åŠŸèƒ½è®°å½•è¯»ä¹¦çš„æ—¶é•¿ã€‚

è¯»ä¹¦ç¬”è®°é€šè¿‡ org-roam-capture ä¸­çš„ books ä¸€é¡¹åˆ›å»ºã€‚

ç„¶ååœ¨è¯»ä¹¦è®°å½•ç¬”è®°ä¸­å¯ä»¥é€šè¿‡ org report åŠŸèƒ½ç”Ÿæˆä¸€å¹´çš„è¯»ä¹¦è®°å½•ã€‚

#+begin_example
  ,#+BEGIN: clocktable :scope my/reading-list :maxlevel 9 :emphasize t :fileskip0 t :hidefiles t :block 2023
  ,#+END:
#+end_example

clocktable ä¸­çš„ scope å¯ä»¥æ˜¯è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œä¸‹é¢çš„å‡½æ•°å°† books ä¸‹çš„æ‰€æœ‰è¯»ä¹¦ç¬”è®°çº³å…¥ç»Ÿè®¡èŒƒå›´ã€‚ç”Ÿæˆçš„è¡¨æ ¼ä¸­åŒ…æ‹¬äº†ä¹¦ååŠé˜…è¯»æœ¬ä¹¦æ‰€èŠ±çš„æ—¶é—´ã€‚

#+begin_src emacs-lisp
  ;; Get reading list from books directory for org-clock report.
  ;; The org-clock report scope can be a function.
  (defun my/reading-list ()
    "Get reading list."
    (let (reading-list)
      (append reading-list
              (file-expand-wildcards (expand-file-name "roam/books/*.org" my-galaxy)))))
#+end_src

** Achive
#+begin_src emacs-lisp
  (use-package achive
    :commands achive
    :config
    (setq achive-language 'zh)
    (setq achive-cache-path (expand-file-name ".achive" no-littering-var-directory)))

  (my/comma-leader-def
    "a" '(achive :wk "A-share"))

  (with-eval-after-load 'evil-collection
    (evil-collection-define-key 'normal 'achive-visual-mode-map
      "q" 'quit-window))

#+end_src
* Easy use, Code snippets
** Open APP within Emacs
è¯¥é…ç½®æ¥æºï¼š[[https://emacs-china.org/t/emacs-mini-buffer-app-macos-only/23153][[æŠ€å·§åˆ†äº«] åœ¨ Emacs mini buffer ä¸­é€‰æ‹©å¹¶æ‰“å¼€å…¶ä»– Appã€macOS onlyã€‘ - Emacs-general - Emacs China]]
#+begin_src emacs-lisp
  (defun mac-launchpad/string-ends-with (s ending)
    "Return non-nil if string S ends with ENDING."
    (cond ((>= (length s) (length ending))
           (let ((elength (length ending)))
             (string= (substring s (- 0 elength)) ending)))
          (t nil)))

  (defun mac-launchpad/find-mac-apps (folder)
    (let* ((files (directory-files folder))
           (without-dots (cl-delete-if (lambda (f) (or (string= "." f) (string= ".." f))) files))
           (all-files (mapcar (lambda (f) (file-name-as-directory (concat (file-name-as-directory folder) f))) without-dots))
           (result (cl-delete-if-not (lambda (s) (mac-launchpad/string-ends-with s ".app/")) all-files)))
      result))

  (defun mac-launchpad ()
    (interactive)
    (let* ((apps (mac-launchpad/find-mac-apps "/Applications"))
           (to-launch (completing-read "launch: " apps)))
      (shell-command (format "defaults read \"%s\"Contents/Info.plist CFBundleIdentifier | xargs open -b" to-launch))))
#+end_src
#+begin_src emacs-lisp
  (my/comma-leader-def
    "j" '(mac-launchpad :wk "Jump to App"))
#+end_src
** Open file with system file manager
#+begin_src emacs-lisp
  (defun xah-show-in-desktop ()
    "Show current file in desktop.
  This command can be called when in a file buffer or in `dired'."
    (interactive)
    (let (($path (if (buffer-file-name) (buffer-file-name) default-directory)))
      (cond
       ((string-equal system-type "windows-nt")
        (shell-command
         (format "PowerShell -Command Start-Process Explorer -FilePath %s"
                 (shell-quote-argument default-directory))))
       ((string-equal system-type "darwin")
        (if (eq major-mode 'dired-mode)
            (let (($files (dired-get-marked-files )))
              (if (eq (length $files) 0)
                  (shell-command (concat "open " (shell-quote-argument (expand-file-name default-directory ))))
                (shell-command (concat "open -R " (shell-quote-argument (car (dired-get-marked-files )))))))
          (shell-command
           (concat "open -R " (shell-quote-argument $path)))))
       ((string-equal system-type "gnu/linux")
        (let ((process-connection-type nil)
              (openFileProgram (if (file-exists-p "/usr/bin/gvfs-open")
                                   "/usr/bin/gvfs-open"
                                 "/usr/bin/xdg-open")))
          (start-process "" nil openFileProgram (shell-quote-argument $path)))))))

  (my/space-leader-def
    "fd" '(xah-show-in-desktop :wk "Open in Finder"))
#+end_src

** Remove link
ä¸‹é¢çš„é…ç½®æ¥æºï¼š[[https://github.com/jeremyf/dotemacs/blob/main/emacs.d/jf-org-mode.el][dotemacs/jf-org-mode.el at main Â· jeremyf/dotemacs]]. ä½œç”¨æ˜¯ç§»é™¤ org æ–‡ä»¶ä¸­çš„é“¾æ¥ï¼Œä»…ä¿ç•™é“¾æ¥çš„æè¿°å†…å®¹ã€‚
#+begin_src emacs-lisp
  (defun jf/org-link-remove-link ()
    "Remove the link part of an `org-mode' link at point and keep only the description."
    (interactive)
    (let ((elem (org-element-context)))
      (when (eq (car elem) 'link)
        (let* ((content-begin (org-element-property :contents-begin elem))
               (content-end  (org-element-property :contents-end elem))
               (link-begin (org-element-property :begin elem))
               (link-end (org-element-property :end elem)))
          (when (and content-begin content-end)
            (let ((content (buffer-substring-no-properties content-begin content-end)))
              (delete-region link-begin link-end)
              (insert content)))))))

  (with-eval-after-load 'evil
    (evil-declare-key 'normal 'global
      "gX" 'jf/org-link-remove-link))
#+end_src
** Add timestamps to youtube links
æ­¤é…ç½®æ¥æºï¼š[[https://mbork.pl/2022-10-10_Adding_timestamps_to_youtube_links][Marcin Borkowski: 2022-10-10 Adding timestamps to youtube links]].

è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨ youtube é“¾æ¥ä¸­å¢åŠ æ—¶é—´ï¼Œè¿™æ ·å¯ä»¥è¿›è¡Œè§†é¢‘å†…å®¹çš„ç²¾å‡†è·³è½¬ï¼Œå½“ä½ çœ‹äº†ä¸€éƒ¨ä»½è§†é¢‘å†…å®¹æ—¶è®°å½•æ—¶é—´ç­‰åæœŸæ¥ç€çœ‹ã€‚
#+begin_src emacs-lisp
  (defun yt-set-time (time)
    "Set TIME in the YouTube link at point.)
    TIME is number of seconds if called from Lisp, and a string if
    called interactively.
    Supported formats:
    - seconds
    - minutes:seconds
    - number of seconds with the \"s\" suffix."
    (interactive (list
                  (if current-prefix-arg
                      (prefix-numeric-value current-prefix-arg)
                    (read-string "Time: "))))
    (let ((url (thing-at-point-url-at-point)))
      (if (and url
               (string-match
                (format "^%s"
                        (regexp-opt
                         '("https://www.youtube.com/"
                           "https://youtu.be/")
                         "\\(?:")))
               url))
      (let* ((bounds (thing-at-point-bounds-of-url-at-point))
             (time-present-p (string-match "t=[0-9]+" url))
             (question-mark-present-p (string-search "?" url))
             (seconds (cond
                       ((numberp time)
                        time)
                       ((string-match
                         "^\\([0-9]+\\):\\([0-9]\\{2\\}\\)$" time)
                        (+ (* 60 (string-to-number
                                  (match-string 1 time)))
                           (string-to-number (match-string 2 time))))
                       ((string-match "^\\([0-9]+\\)s?$" time)
                        (string-to-number (match-string 1 time)))
                       (t (error "Wrong argument format"))))
             (new-url (if time-present-p
                          (replace-regexp-in-string
                           "t=[0-9]+"
                           (format "t=%i" seconds)
                           url)
                        (concat url
                                (if question-mark-present-p "&" "?")
                                (format "t=%i" seconds)))))
        (delete-region (car bounds) (cdr bounds))
        (insert new-url))
      (error "Not on a Youtube link")))
#+end_src
#+begin_src emacs-lisp
  (my/space-leader-def
    "lt" '(yt-set-time :wk "Set Youtube link time"))
#+end_src
** self define function
#+begin_src emacs-lisp
  (defun switch-to-message ()
    "Quick switch to `*Message*' buffer."
    (interactive)
    (switch-to-buffer "*Messages*"))

  (defun switch-to-scratch ()
    "Quick switch to `*Scratch*' buffer."
    (interactive)
    (switch-to-buffer "*scratch*"))

  (my/space-leader-def
    "bs" '(switch-to-scratch :wk "*scratch*")
    "bm" '(switch-to-message :wk "*message*"))

  (defun my/inbox-file ()
    "Open inbox file."
    (interactive)
    (find-file (expand-file-name "inbox/inbox.org" my-galaxy)))

  (defun my/plan-file ()
    "Open plan file."
    (interactive)
    (find-file (expand-file-name "inbox/plan.org" my-galaxy)))

  (defun my/index-file ()
    (interactive)
    (find-file (expand-file-name "roam/main/index.org" my-galaxy)))

  (defun my/reflection-file ()
    (interactive)
    (find-file (expand-file-name "roam/main/reflection.org" my-galaxy)))

  (defun my/finance-file ()
    "Open finance file."
    (interactive)
    (find-file (expand-file-name "finance/finance.bean" my-galaxy)))

  (defun my/reading-record ()
    "Open reading record file."
    (interactive)
    (find-file (expand-file-name "roam/main/reading-record.org" my-galaxy)))

  (my/space-leader-def
    "fo" '(:ignore t :wk "Open file")
    "fob" '(my/reading-record :wk "Reading record")
    "foi" '(my/inbox-file :wk "Inbox file")
    "foI" '(my/index-file :wk "Index file")
    "fop" '(my/plan-file :wk "Plan file")
    "fof" '(my/finance-file :wk "Finance file")
    "for" '(my/reflection-file :wk "Reflection file")
    "fog" '(my/gtd-file :wk "GTD file"))

  (defun my/start-server ()
    (interactive)
    (if (not (server-running-p))
        (server-start))
    (message "Server has started"))

  (defun my/scroll-other-windown-down ()
    "Scroll other window down."
    (interactive)
    (scroll-other-window-down 2))

  (global-set-key (kbd "M-p") 'my/scroll-other-windown-down)

  (defun my/scroll-other-windown ()
    "Scroll other window up."
    (interactive)
    (scroll-other-window 2))

  (global-set-key (kbd "M-n") 'my/scroll-other-windown)
#+end_src
* End
#+begin_src emacs-lisp
  ;;; init.el ends here.
#+end_src
